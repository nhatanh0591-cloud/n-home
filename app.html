﻿<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N-Home - Khách Hàng</title>
    <meta name="description" content="Ứng dụng xem hóa đơn và thanh toán tiền nhà trọ">
    <!-- Updated: 03/12/2025 -->
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest-customer.json" crossorigin="use-credentials">
    
    <!-- Theme Color - Trùng với logo #23904f -->
    <meta name="theme-color" content="#23904f">
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#23904f">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#23904f">
    
    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="N-Home">
    <link rel="apple-touch-icon" href="/icon-nen-xanh.jpg">
    <link rel="apple-touch-startup-image" href="/icon-nen-xanh.jpg">
    
    <!-- Android -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Icons -->
    <link rel="icon" type="image/jpeg" sizes="192x192" href="/icon-nen-xanh.jpg">
    <link rel="icon" type="image/jpeg" sizes="512x512" href="/icon-nen-xanh.jpg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 🔇 DISABLE ALL CONSOLE LOGS FOR PRODUCTION -->
    <script>
        // Developer mode: Add ?debug=1 to URL to enable logs
        const isDev = window.location.hostname === 'localhost' || 
                     window.location.hostname === '127.0.0.1' || 
                     new URLSearchParams(window.location.search).has('debug');
        
        if (!isDev) {
            // Production: Disable console spam
            console.log = function() {};
            console.warn = function() {};
            console.info = function() {};
            console.debug = function() {};
        }
        // Always keep console.error for critical debugging
        
        // 🧹 Cleanup on page unload to prevent memory leaks
        window.addEventListener('beforeunload', () => {
            activeListeners.forEach(unsubscribe => {
                if (typeof unsubscribe === 'function') {
                    unsubscribe();
                }
            });
            if (renderNotificationsTimeout) {
                clearTimeout(renderNotificationsTimeout);
            }
        });
        
        // 🚨 Global error handlers để tránh crash app
        window.addEventListener('error', (event) => {
            console.error('🚨 Global JS Error:', event.error?.message || event.message);
            // Không để error crash app
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('🚨 Unhandled Promise Rejection:', event.reason?.message || event.reason);
            event.preventDefault(); // Prevent console error
        });
    </script>
    
    <!-- PWA Service Worker Registration & Install Prompt -->
    <script>
        let deferredPrompt;
        let installButton = null;

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/customer-sw.js')
                    .then((registration) => {
                        console.log('N-Home Customer SW registered successfully:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('N-Home Customer SW registration failed:', error);
                    });
            });
        }

        // PWA Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWA Install prompt event fired');
            e.preventDefault();
            deferredPrompt = e;
            showInstallPrompt();
        });

        // Show custom install prompt
        function showInstallPrompt() {
            console.log('🔥 SHOWING INSTALL PROMPT - FORCE MODE');
            
            // Remove existing prompt if any
            const existing = document.getElementById('pwa-install-prompt');
            if (existing) {
                console.log('🗑️ Removing existing prompt');
                existing.remove();
            }
            
            // Tạo popup install
            const installPrompt = document.createElement('div');
            installPrompt.id = 'pwa-install-prompt';
            installPrompt.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; padding: 24px; margin: 20px; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
                        <div style="width: 60px; height: 60px; margin: 0 auto 16px; background-image: url('/icon-nen-xanh.jpg'); background-size: cover; border-radius: 12px;"></div>
                        <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: bold; color: #1f2937;">🚀 Cài đặt N-Home</h3>
                        <p style="margin: 0 0 20px 0; color: #6b7280; font-size: 14px;">Cài đặt ứng dụng để truy cập nhanh hơn và ẩn thanh địa chỉ</p>
                        <div style="display: flex; gap: 12px;">
                            <button id="pwa-install-btn" style="flex: 1; background: #16a34a; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 500; cursor: pointer;">Cài đặt</button>
                            <button id="pwa-cancel-btn" style="flex: 1; background: #f3f4f6; color: #6b7280; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 500; cursor: pointer;">Bỏ qua</button>
                        </div>
                    </div>
                </div>
            `;
            
            console.log('✅ Appending popup to body');
            document.body.appendChild(installPrompt);
            console.log('✅ Popup appended, should be visible now');

            // Install button click
            document.getElementById('pwa-install-btn').addEventListener('click', async () => {
                console.log('🔥 Install button clicked, deferredPrompt:', !!deferredPrompt);
                
                // LUÔN THỬ NATIVE INSTALL TRƯỚC
                if (deferredPrompt) {
                    console.log('✅ Using deferredPrompt');
                    try {
                        await deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        console.log('PWA install outcome:', outcome);
                        if (outcome === 'accepted') {
                            console.log('✅ User accepted install');
                            document.body.removeChild(installPrompt);
                            return;
                        }
                        deferredPrompt = null;
                    } catch (error) {
                        console.log('❌ deferredPrompt error:', error);
                    }
                }
                
                // DETECT BROWSER VÀ SHOW ĐÚNG HƯỚNG DẪN
                const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
                const isEdge = /Edg/.test(navigator.userAgent);
                const isSamsung = /SamsungBrowser/.test(navigator.userAgent);
                
                console.log('🔍 Browser detection:', { isChrome, isEdge, isSamsung, userAgent: navigator.userAgent });
                
                let instructions = '';
                if (isChrome || isEdge) {
                    instructions = '🚀 Cài đặt N-Home:\n\n✅ Bước 1: Bấm menu (⋮) ở góc phải trên cùng\n✅ Bước 2: Tìm và chọn "Cài đặt N-Home" hoặc "Install N-Home"\n✅ Bước 3: Bấm "Install" trong popup xuất hiện\n\n🎉 Ứng dụng sẽ mở không có thanh địa chỉ Vercel!';
                } else if (isSamsung) {
                    instructions = '🚀 Cài đặt N-Home:\n\n✅ Bước 1: Bấm menu (☰) \n✅ Bước 2: Chọn "Add page to" → "Home screen"\n\n🎉 Ứng dụng sẽ xuất hiện trên màn hình chính!';
                } else {
                    instructions = '🚀 Cài đặt N-Home:\n\n✅ Bước 1: Bấm menu trình duyệt\n✅ Bước 2: Tìm "Thêm vào màn hình chính" hoặc "Add to Home screen"\n\n🎉 Ứng dụng sẽ mở không có thanh địa chỉ!';
                }
                
                alert(instructions);
                document.body.removeChild(installPrompt);
            });

            // Cancel button click
            document.getElementById('pwa-cancel-btn').addEventListener('click', () => {
                console.log('❌ Install cancelled by user');
                document.body.removeChild(installPrompt);
                // Lưu trạng thái đã từ chối cho customer app riêng
                localStorage.setItem('pwa-customer-install-dismissed', Date.now());
            });
        }

        // Check if device is mobile
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   window.innerWidth <= 768 || 
                   'ontouchstart' in window;
        }

        // Check if should show install prompt
        window.addEventListener('load', () => {
            console.log('🔥 FORCE SHOW - Page loaded, checking install conditions...');
            
            // Chỉ hiện popup trên mobile/tablet, không hiện trên desktop
            const isMobile = isMobileDevice();
            const dismissed = localStorage.getItem('pwa-customer-install-dismissed');
            const isInstalled = window.matchMedia('(display-mode: standalone)').matches;
            
            console.log('🔥 Install conditions:', { 
                isMobile, 
                dismissed, 
                isInstalled, 
                deferredPrompt: !!deferredPrompt,
                userAgent: navigator.userAgent
            });
            
            // FORCE SHOW POPUP - BỎ TẤT CẢ ĐIỀU KIỆN
            console.log('🔥 FORCE SHOWING POPUP - IGNORING ALL CONDITIONS');
            setTimeout(() => {
                console.log('🔥 FORCE TIMEOUT - Showing install prompt now!');
                showInstallPrompt();
            }, 1000);
        });
        // Track if app was installed
        window.addEventListener('appinstalled', (evt) => {
            console.log('PWA Customer was installed successfully');
            localStorage.removeItem('pwa-customer-install-dismissed');
        });
    </script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #e5e7eb;
            min-height: 100vh;
        }
        .app-container {
            max-width: 400px;
            margin: 0 auto;
            background: #f3f4f6;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            overflow-x: hidden;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #1e6b3a, #23904f);
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 16px;
        }
        .status-paid { background: #dcfce7; color: #23904f; }
        .status-unpaid { background: #fef3c7; color: #d97706; }
        .hidden { display: none; }
        
        /* Bills Screen Styles */
        #bills-screen {
            background: #f8fafc;
            height: 100vh;
            overflow: hidden;
        }
        
        #bills-screen .content-wrapper {
            height: 100vh;
            overflow-y: auto;
            padding-bottom: 100px;
        }
        
        /* Custom scrollbar for bills list */
        #bills-list-page {
            padding-bottom: 20px;
        }
        
        /* Ẩn thanh cuộn cho mobile */
        #bills-list-page::-webkit-scrollbar {
            width: 0;
            display: none;
        }
        
        /* Ẩn thanh cuộn cho tất cả các màn hình */
        
        /* Hide VN/EN labels but keep radio buttons */
        .language-code {
            display: none !important;
        }
        ::-webkit-scrollbar {
            width: 0;
            display: none;
        }
        
        /* Đảm bảo vẫn có thể scroll trên mobile */
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            width: 100%;
            max-width: 400px;
            border-radius: 20px 20px 0 0;
            padding: 2px 0;
        }
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 0;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .nav-item.active {
            color: #23904f;
        }
        .nav-item:not(.active) {
            color: #9ca3af;
        }
        .nav-item:hover {
            background: #f9fafb;
        }
        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }
        .nav-label {
            font-size: 11px;
            font-weight: 500;
        }
        .content-wrapper {
            padding-bottom: 85px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: relative;
        }
        
        #notifications-screen .content-wrapper {
            padding-bottom: 80px;
        }
        .wallet-float {
            margin-top: -32px;
            background: white;
            padding: 6px;
            border-radius: 50%;
        }
        
        /* Ensure all screens stay within app container */
        #home-screen,
        #login-screen {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: relative;
        }
        
        #notifications-screen {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }
        
        /* Fix notifications screen layout */
        #notifications-screen {
            background: white;
            height: 100vh;
            overflow: hidden;
        }
        
        #notifications-screen .content-wrapper {
            height: 100vh;
            padding-bottom: 80px;
            padding-top: 0;
        }
        
        /* QR Payment Screen Styles */
        #qr-payment-screen {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: #f0f9ff;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Disable scroll and interaction when not logged in */
        .no-scroll {
            overflow: hidden !important;
            touch-action: none !important;
        }
        
        .disabled-interaction {
            pointer-events: none !important;
            user-select: none !important;
        }
        
        .disabled-interaction .content-wrapper {
            overflow: hidden !important;
            height: 100vh !important;
        }
        
        #qr-payment-screen .content-wrapper {
            height: 100vh;
            padding-bottom: 80px;
            padding-top: 0;
        }
        
        
        /* Create Issue Screen Styles */
        #create-issue-screen {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            height: 100vh;
            overflow: visible;
        }
        
        #create-issue-screen .content-wrapper {
            height: 100vh;
            padding-bottom: 100px;
            padding-top: 0;
        }
        
        /* Custom styles for issue screen to match sample exactly */
        #create-issue-screen .issue-illustration {
            width: 200px !important;
            height: 200px !important;
            max-width: 200px !important;
            max-height: 200px !important;
            object-fit: contain;
            margin: 0 auto;
        }
        
        #create-issue-screen .issue-title {
            font-size: 1.1rem; /* 17.6px */
            font-weight: 700;
            line-height: 1.3;
            color: #374151;
            margin-bottom: 0.75rem;
        }
        
        #create-issue-screen .issue-description {
            font-size: 0.8rem; /* 12.8px */
            line-height: 1.4;
            color: #6B7280;
            margin-bottom: 1.25rem;
            padding: 0 0.5rem;
        }
        
        /* Line clamp utility for text truncation */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Issue Form Screen Styles */
        #issue-form-screen {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: #f8fafc;
            height: 100vh;
            overflow: hidden;
        }
        
        #create-issue-screen .content-wrapper {
            height: 100vh;
            padding-bottom: 80px;
            padding-top: 0;
        }
        
        /* Line clamp utility for text truncation */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Issue Form Screen Styles */
        #issue-form-screen {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: #f8fafc;
            height: 100vh;
            overflow: hidden;
        }
        
        #issue-form-screen .content-wrapper {
            height: 100vh;
            padding-bottom: 80px;
            padding-top: 0;
        }
        
        #notifications-list {
            max-height: calc(100vh - 140px);
            background: white;
        }
        
        /* Bill Detail Screen */
        #bill-detail-screen {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 400px;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }
        
        /* Profile Screen Styles */
        #profile-screen {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: #f0f9ff;
            height: 100vh;
            overflow: hidden;
        }
        
        #profile-screen .content-wrapper {
            height: 100vh;
            padding-bottom: 80px;
            padding-top: 0;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Loading Screen -->
        <div id="loading-screen" class="gradient-bg h-screen flex items-center justify-center">
            <div class="text-center text-white">
                <div class="w-16 h-16 mx-auto mb-4 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                    <div class="w-8 h-8 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                </div>
                <p class="text-lg">Đang kết nối...</p>
            </div>
        </div>





        <!-- Login Screen -->
        <div id="login-screen" class="hidden gradient-bg h-screen">
            <div class="pt-20 px-6">
                <div class="text-center text-white mb-10">
                    <img src="/icon-nen-xanh.jpg" alt="N-Home Logo" class="w-16 h-16 rounded-full mx-auto mb-4">
                    <h1 class="text-2xl font-bold mb-2">N-Home</h1>
                    <p class="text-white text-opacity-80">Kiểm Soát Chi Phí và Thông Tin Thuê Nhà</p>
                </div>

                <div class="card">
                    <h2 class="text-xl font-bold mb-2">Đăng Nhập</h2>
                    <p class="text-gray-600 mb-6">Nhập số điện thoại để xem thông tin hóa đơn</p>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Số điện thoại</label>
                        <input type="tel" id="phone-input" placeholder="0961512412" maxlength="10" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <button id="login-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 font-semibold">
                        Đăng Nhập
                    </button>
                </div>
            </div>
        </div>

        <!-- Home Screen -->
        <div id="home-screen" class="hidden">
            <div class="content-wrapper">
            <!-- Header -->

            
            <!-- Building Info -->
            <div class="px-6 mb-3">
                <h2 class="text-lg font-semibold mb-3 text-gray-700" id="room-info-header">Thông tin tòa nhà</h2>
                <div class="card" id="building-info">
                    <!-- Loading skeleton -->
                    <div class="animate-pulse">
                        <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
                        <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                    </div>
                </div>
            </div>

            <!-- Contract Duration -->
            <div class="px-6 mb-3">
                <h2 class="text-lg font-semibold mb-3 text-gray-700" id="contract-duration-header">Thời hạn hợp đồng</h2>
                <div class="card" id="contract-duration-info">
                    <!-- Loading skeleton -->
                    <div class="animate-pulse">
                        <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
                        <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                    </div>
                </div>
            </div>

            <!-- Bills List -->
            <div class="px-6">
                <!-- Tiền thuê và các khoản phí -->
                <div class="mb-3">
                    <h2 class="text-lg font-semibold mb-3 text-gray-700" id="rent-header">Tiền thuê và các khoản phí</h2>
                    <div class="card" id="rent-info">
                        <!-- Loading skeleton -->
                        <div class="animate-pulse">
                            <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
                            <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tenant Info -->
            <div class="px-6 mb-3">
                <h2 class="text-lg font-semibold mb-3 text-gray-700" id="tenant-header">Người thuê</h2>
                <div class="card" id="tenant-info">
                    <!-- Loading skeleton -->
                    <div class="animate-pulse">
                        <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
                        <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Bills Screen -->
        <div id="bills-screen" class="hidden bg-gray-100 min-h-screen">
            <div class="content-wrapper">
                <!-- Header với tiêu đề ở giữa -->
                <div class="bg-green-600 text-white px-4 py-4 flex items-center justify-center sticky top-0 z-50 shadow-lg h-16">
                    <h1 class="text-xl font-bold" id="bills-title">Hóa đơn</h1>
                </div>

                <!-- Bills List Container -->
                <div class="px-4 py-4 pb-20">
                    <div id="bills-list-page" class="space-y-4">
                        <!-- Bills will be rendered here -->
                        <div class="bg-white rounded-xl p-4 shadow-sm animate-pulse">
                            <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
                            <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation Bar -->
        <div class="bottom-nav">
                <div class="flex">
                    <div class="nav-item active" onclick="switchTab('home')">
                        <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M4 4h7v7H4V4zm9 0h7v7h-7V4zM4 13h7v7H4v-7zm9 0h7v7h-7v-7z"/>
                        </svg>
                    </div>                    <div class="nav-item" onclick="switchTab('notifications')" style="position: relative;">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        <!-- Badge số thông báo chưa đọc -->
                        <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold hidden">0</span>
                    </div>
                    
                    <div class="nav-item" onclick="switchTab('bills')">
                        <div class="wallet-float">
                            <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center" style="box-shadow: 0 4px 12px rgba(5, 150, 105, 0.4);">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-item" onclick="switchTab('feedback')">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 11l3 3 3-3"/>
                        </svg>
                    </div>
                    
                    <div class="nav-item" onclick="switchTab('profile')">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"/>
                            <path stroke-linecap="round" d="M8 14s1.5 2 4 2 4-2 4-2M9 9h.01M15 9h.01"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Screen -->
        <div id="notifications-screen" class="hidden">
            <div class="content-wrapper flex flex-col">
                <!-- Header -->
                <div class="px-4 py-4 flex-shrink-0 bg-green-600 text-white h-16 flex items-center sticky top-0 z-50 shadow-lg">
                    <div class="relative flex justify-end items-center w-full">
                        <div class="absolute inset-0 flex items-center justify-center">
                            <h1 class="text-xl font-bold text-white" id="notifications-title">Hộp thư</h1>
                        </div>
                        <button onclick="markAllAsRead()" class="text-white w-8 h-8 flex items-center justify-center relative z-10">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 7l2 2 4-4"/>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 7h9"/>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 17l2 2 4-4"/>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 17h9"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Notifications List -->
                <div class="flex-1 overflow-y-auto bg-white pb-32" id="notifications-list" style="min-height: 100%;">
                    <!-- Loading skeleton -->
                    <div class="animate-pulse">
                        <div class="h-16 bg-gray-200 rounded-lg mb-3"></div>
                        <div class="h-16 bg-gray-200 rounded-lg mb-3"></div>
                        <div class="h-16 bg-gray-200 rounded-lg"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Issue Screen -->
        <div id="create-issue-screen" class="hidden">
            <div class="content-wrapper flex flex-col">
                <!-- Header -->
                <div class="px-4 pt-4 pb-4 flex-shrink-0 bg-green-600 text-white">
                    <div class="flex items-center justify-center relative">
                        <h1 class="text-xl font-bold" id="issues-header-title">Phản ánh</h1>
                        <button onclick="showIssueForm()" class="absolute right-0 w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Empty State (shown when no issues) -->
                <div id="empty-issues-state" class="flex-1 overflow-y-auto bg-gray-50 flex flex-col" style="min-height: 100%;">
                    <!-- Illustration -->
                    <div class="flex-1 flex justify-center items-center px-6 pt-2 pb-2">
                        <img src="images/plumber-illustration.png" 
                             alt="Thợ sửa chữa" 
                             class="issue-illustration">
                    </div>
                    
                    <!-- Bottom Text and Button Section -->
                    <div class="text-center px-6 pb-32 pt-2">
                        <h2 class="issue-title" id="need-help-title">
                            Bạn đang cần trợ giúp chứ? 🤔
                        </h2>
                        <p class="issue-description" id="help-text">
                            Nếu bạn gặp phải vấn đề, hãy tạo phản ánh để quản lý tòa nhà nắm thông tin và xử lý ngay cho bạn nhé!
                        </p>
                        
                        <!-- Create Issue Button -->
                        <button onclick="showIssueForm()" class="bg-green-600 hover:bg-green-700 text-white py-2.5 px-6 rounded-xl font-medium text-sm transition-colors w-40 mx-auto block" id="create-feedback-btn">
                            Tạo phản ánh
                        </button>
                    </div>
                </div>

                <!-- Issues List (shown when there are issues) -->
                <div id="issues-list-container" class="flex-1 overflow-y-auto bg-gray-50 px-4 py-4 hidden">
                    <div id="issues-list" class="space-y-3 pb-20">
                        <!-- Issues will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Issue Form Screen -->
        <div id="issue-form-screen" class="hidden">
            <div class="content-wrapper flex flex-col">
                <!-- Header -->
                <div class="px-4 pt-4 pb-4 flex-shrink-0 bg-green-600 text-white">
                    <div class="flex items-center justify-between">
                        <button onclick="backToIssueScreen()" class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <h1 class="text-xl font-bold" id="report-issue-title">Báo cáo sự cố</h1>
                        <div class="w-10 h-10"></div>
                    </div>
                </div>

                <!-- Form Content -->
                <div class="flex-1 overflow-y-auto bg-white px-3 py-2 pb-32" style="min-height: 100%;">
                    <div class="bg-white rounded-xl p-3 shadow-sm">
                        <h2 class="text-base font-semibold mb-3 text-gray-900" id="issue-info-title">Thông tin sự cố</h2>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1.5" id="description-label">Mô tả chi tiết *</label>
                                <textarea id="issue-description" rows="4" placeholder="Mô tả chi tiết vấn đề bạn gặp phải..." 
                                          class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none text-sm"></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1.5" id="images-label">Hình ảnh (0/5)</label>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                                    <div class="mb-2">
                                        <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                    </div>
                                    <p class="text-xs text-gray-600 mb-1.5" id="add-image-text">Thêm ảnh</p>
                                    <input type="file" id="issue-images" multiple accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                                    <button type="button" onclick="document.getElementById('issue-images').click()" class="text-green-600 hover:text-green-700 text-xs font-medium" id="choose-device-btn">
                                        Chọn từ thiết bị
                                    </button>
                                </div>
                                <div id="image-preview" class="mt-2 grid grid-cols-3 gap-2"></div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 mt-4">
                            <button onclick="submitIssue()" class="flex-1 bg-green-600 text-white py-2.5 px-3 rounded-lg hover:bg-green-700 font-semibold text-sm" id="submit-issue-btn">
                                Gửi sự cố
                            </button>
                            <button onclick="backToIssueScreen()" class="px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium text-sm" id="cancel-btn">
                                Hủy
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Payment Screen -->
        <div id="qr-payment-screen" class="hidden">
            <div class="content-wrapper flex flex-col">
                <!-- Header -->
                <div class="px-4 pt-4 pb-4 flex-shrink-0 bg-green-600 text-white">
                    <div class="flex items-center justify-between">
                        <button onclick="closeQRPayment()" class="w-8 h-8 flex items-center justify-center">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <h1 class="text-xl font-bold" id="payment-title">THANH TOÁN</h1>
                        <div class="w-8 h-8"></div> <!-- Spacer -->
                    </div>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto bg-white px-4 py-4">
                    <!-- QR Code Container -->
                    <div class="bg-white rounded-xl p-4 shadow-sm mb-4">
                        <div class="border-4 border-green-600 rounded-lg p-3 mb-4 w-64 h-64 mx-auto flex items-center justify-center">
                            <img id="payment-qr-image" src="" alt="QR Code" class="w-full h-full object-contain">
                        </div>
                        
                        <!-- Download Button -->
                        <button onclick="downloadQR()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold mb-4 flex items-center justify-center hover:bg-green-700 transition-colors">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                            </svg>
                            <span id="download-text">💾 Lưu vào thư viện</span>
                        </button>
                    </div>
                    
                    <!-- Payment Info -->
                    <div class="bg-white rounded-xl p-4 shadow-sm space-y-4">
                        <div>
                            <p class="text-sm text-gray-600 mb-1" id="account-name-label">Tên tài khoản</p>
                            <p id="payment-account-name" class="text-base font-bold text-gray-900"></p>
                        </div>
                        
                        <div>
                            <p class="text-sm text-gray-600 mb-1" id="account-number-label">Số tài khoản</p>
                            <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                                <p id="payment-account-number" class="text-base font-bold text-gray-900"></p>
                                <button onclick="copyAccountNumber()" class="text-green-600 font-medium text-sm" id="copy-account-btn">Sao chép</button>
                            </div>
                        </div>
                        
                        <div>
                            <p class="text-sm text-gray-600 mb-1" id="amount-label">Số tiền</p>
                            <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                                <p id="payment-amount" class="text-base font-bold text-gray-900"></p>
                                <button onclick="copyAmount()" class="text-green-600 font-medium text-sm" id="copy-amount-btn">Sao chép</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Screen -->
        <div id="profile-screen" class="hidden">
            <div class="content-wrapper flex flex-col">
                <!-- Header -->
                <div class="px-4 py-4 flex-shrink-0 bg-green-600 text-white h-16 flex items-center justify-center">
                    <h1 class="text-xl font-bold">Cá nhân</h1>
                </div>
                
                <!-- Profile Content -->
                <div class="flex-1 overflow-hidden bg-gray-50 px-3 py-2 pb-32" style="min-height: 100%;">
                    <!-- Avatar Section -->
                    <div class="bg-white rounded-xl p-4 shadow-sm mb-3 text-center">
                        <div class="relative inline-block mb-2">
                            <img id="profile-avatar" src="/icon-nen-xanh.jpg" alt="Avatar" class="w-32 h-32 rounded-full border-4 border-green-100 shadow-lg">
                            <button onclick="changeAvatar()" class="absolute bottom-0 right-0 w-10 h-10 bg-green-600 rounded-full flex items-center justify-center shadow-lg">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </button>
                            <input type="file" id="avatar-input" accept="image/*" class="hidden" onchange="handleAvatarChange(this)">
                        </div>
                        <h2 id="profile-name" class="text-lg font-bold text-gray-800">Đang tải...</h2>
                    </div>

                    <!-- Personal Info Section -->
                    <div class="bg-white rounded-xl p-3 shadow-sm mb-3">
                        <h3 class="text-base font-semibold text-gray-800 mb-3 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                            </svg>
                            <span class="translate" data-key="personalInfo">Thông tin cá nhân</span>
                        </h3>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-gray-600 text-sm translate" data-key="fullName">Họ tên:</span>
                                <span id="profile-fullname" class="font-semibold text-gray-800 text-sm">Đang tải...</span>
                            </div>
                            <div class="flex justify-between items-center py-2">
                                <span class="text-gray-600 text-sm translate" data-key="phoneNumber">Số điện thoại:</span>
                                <span id="profile-phone" class="font-semibold text-gray-800 text-sm">Đang tải...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Language Section -->
                    <div class="bg-white rounded-xl p-2 shadow-sm mb-2">
                        <h3 class="text-sm font-semibold text-gray-800 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7 2a1 1 0 011 1v1h3a1 1 0 110 2H9.578a18.87 18.87 0 01-1.724 4.78c.29.354.596.696.914 1.026a1 1 0 11-1.44 1.389c-.188-.196-.373-.396-.554-.6a19.098 19.098 0 01-3.107 3.567 1 1 0 01-1.334-1.49 17.087 17.087 0 003.13-3.733 18.992 18.992 0 01-1.487-2.494 1 1 0 111.79-.89c.234.47.489.928.764 1.372.417-.934.752-1.913.997-2.927H3a1 1 0 110-2h3V3a1 1 0 011-1zm6 6a1 1 0 01.894.553l2.991 5.982a.869.869 0 01.02.037l.99 1.98a1 1 0 11-1.79.895L15.383 16h-4.764l-.724 1.447a1 1 0 11-1.788-.894l.99-1.98.019-.038 2.99-5.982A1 1 0 0113 8zm-1.382 6h2.764L13 11.236 11.618 14z" clip-rule="evenodd"/>
                            </svg>
                            <span id="language-header" class="translate" data-key="language">Ngôn ngữ</span>
                        </h3>
                        <div class="space-y-1">
                            <label class="flex items-center py-1 cursor-pointer" onclick="switchLanguage('vi')">
                                <input type="radio" name="language" value="vi" class="mr-2" checked>
                                <span class="flex items-center text-sm">
                                    <span class="text-xl mr-2">🇻🇳</span>
                                    <span>Tiếng Việt</span>
                                </span>
                            </label>
                            <label class="flex items-center py-2 cursor-pointer" onclick="switchLanguage('en')">
                                <input type="radio" name="language" value="en" class="mr-3">
                                <span class="flex items-center">
                                    <span class="text-2xl mr-2">��</span>
                                    <span>English</span>
                                </span>
                            </label>
                        </div>
                    </div>

                    <!-- Logout Section -->
                    <div class="bg-white rounded-xl p-2 shadow-sm">
                        <button onclick="logout()" class="w-full flex items-center justify-center py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                            </svg>
                            <span class="text-sm font-semibold">Đăng xuất</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bill Detail Screen -->
        <div id="bill-detail-screen" class="hidden bg-gray-100 min-h-screen">
            <!-- Header -->
            <div class="bg-green-600 text-white px-4 py-4 flex items-center justify-between sticky top-0 z-10">
                <button onclick="closeBillDetail()" class="w-8 h-8 flex items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <h1 class="text-xl font-bold" id="bill-detail-title">Chi tiết hóa đơn</h1>
                <div class="w-8 h-8"></div> <!-- Spacer -->
            </div>

            <!-- Content -->
            <div class="px-4 py-4 pb-20">
                <div id="bill-detail-content" class="bg-white rounded-xl p-4 shadow-sm">
                    <!-- Bill detail content -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js';
        import { getFirestore, collection, query, where, getDocs, orderBy, onSnapshot, addDoc, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.17.1/firebase-storage.js';

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyA2m1K7pijNC1yirw_t36Rc3HnzCsD8pCs",
            authDomain: "nha-tro-53ca7.firebaseapp.com",
            projectId: "nha-tro-53ca7",
            storageBucket: "nha-tro-53ca7.firebasestorage.app",
            messagingSenderId: "415886594203",
            appId: "1:415886594203:web:f3cda09037973176c9763e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);



        let currentUser = null;
        let customerData = null;
        let bills = [];
        let buildings = [];
        let contracts = [];
        let services = [];
        
        // 🚨 PERFORMANCE MONITOR - Track excessive function calls
        const perfMon = {
            calls: {},
            track(fn) {
                this.calls[fn] = (this.calls[fn] || 0) + 1;
                if (this.calls[fn] % 20 === 0) {
                    console.warn(`🐌 ${fn} called ${this.calls[fn]} times - possible performance issue!`);
                }
            }
        };
        
        // 💾 DOM CACHE - Cache frequently used elements
        let domCache = {
            navItems: null,
            init() {
                this.navItems = document.querySelectorAll('.nav-item');
            },
            getNavItems() {
                if (!this.navItems) this.init();
                return this.navItems;
            }
        };

        // Language System - Only translate labels, not data values
        const translations = {
            vi: {
                // Navigation
                home: "Trang chủ",
                bills: "Hóa đơn",
                notifications: "Hộp thư",
                issues: "Sự cố",
                profile: "Cá nhân",
                
                // Home screen
                welcome: "Xin chào",
                roomInfo: "Thông tin phòng",
                contractDuration: "Thời hạn hợp đồng",
                monthlyRent: "Tiền thuê và các khoản phí",
                tenantInfo: "Người thuê",
                
                // Bills screen
            billsTitle: "Hóa đơn",
            month: "Tháng",
            amount: "Số tiền",
            status: "Trạng thái",
            paid: "Đã thanh toán",
            unpaid: "Chưa thanh toán",
            billDetail: "Chi tiết hóa đơn",
            
            // Bill detail labels
            roomLabel: "Phòng",
            billNumber: "Số hóa đơn",
            createdDate: "Ngày tạo",
            dueDate: "Hạn thanh toán",
            serviceDetails: "Chi tiết dịch vụ",
            unitPrice: "Đơn giá",
            reading: "Chỉ số",
            quantity: "Số lượng",
            total: "Tổng cộng",
            paid_amount: "Đã thanh toán",
            remaining: "Còn lại",
            paidStatus: "ĐÃ THANH TOÁN",
            unpaidStatus: "CHƯA THANH TOÁN",
            payButton: "Thanh toán",
            paymentNote: "Vui lòng thanh toán đúng hạn",
            thankNote: "Cảm ơn bạn đã thanh toán đúng hạn",                // Notifications screen
                notificationsTitle: "Hộp thư",
                markAllRead: "Đánh dấu tất cả đã đọc",
                billNotificationTitle: "Thông báo hóa đơn",
                
                // Issues screen
                issuesTitle: "Sự cố đã báo",
                reportIssue: "Báo sự cố",
                description: "Mô tả",
                submitIssue: "Gửi báo cáo",
                issueSubmitted: "Đã gửi báo cáo sự cố thành công!",
                needHelp: "Bạn đang cần trợ giúp chứ ?",
                createFeedback: "Tạo phản ánh",
                helpText: "Nếu bạn gặp phải vấn đề, hãy tạo phản ánh để quản lý toà nhà nắm thông tin và xử lý ngay cho bạn nhé!",
                
                // Issue form
                reportIssueTitle: "Báo cáo sự cố",
                issueInfo: "Thông tin sự cố",
                detailedDescription: "Mô tả chi tiết",
                descriptionPlaceholder: "Mô tả chi tiết vấn đề bạn gặp phải...",
                images: "Hình ảnh",
                addImage: "Thêm ảnh",
                chooseFromDevice: "Chọn từ thiết bị",
                submitIssueBtn: "Gửi sự cố",
                cancel: "Hủy",
                
                // Issue status
                statusPending: "Chờ xử lý",
                statusInProgress: "Đang xử lý",
                statusCompleted: "Đã hoàn thành",
                statusCancelled: "Đã hủy",
                
                // Issue notification
                issueFromRoom: "Sự cố từ phòng",
                
                // Profile language section
                languageSection: "Ngôn ngữ",
                
                // Profile screen
                profileTitle: "Thông tin cá nhân",
                personalInfo: "Thông tin cá nhân",
                fullName: "Họ tên:",
                phoneNumber: "Số điện thoại:",
                language: "Ngôn ngữ",
                loading: "Đang tải...",
                vietnamese: "Tiếng Việt",
                english: "English",
                logout: "Đăng xuất",
                
                // Payment screen
                paymentTitle: "THANH TOÁN",
                download: "Tải xuống",
                accountName: "Tên tài khoản",
                accountNumber: "Số tài khoản",
                amount: "Số tiền",
                copy: "Sao chép",
                
                // Common
                close: "Đóng",
                save: "Lưu",
                loading: "Đang tải..."
            },
            en: {
                // Navigation
                home: "Home",
                bills: "Bills",
                notifications: "Notifications",
                issues: "Issues",
                profile: "Profile",
                
                // Home screen
                welcome: "Hello",
                roomInfo: "Room Information",
                contractDuration: "Contract Duration",
                monthlyRent: "Rent and Fees",
                tenantInfo: "Tenant",
                
                // Bills screen
            billsTitle: "Bills",
            month: "Month",
            amount: "Amount",
            status: "Status",
            paid: "Paid",
            unpaid: "Unpaid",
            billDetail: "Bill Details",
            
            // Bill detail labels
            roomLabel: "Room",
            billNumber: "Bill Number",
            createdDate: "Created Date",
            dueDate: "Due Date",
            serviceDetails: "Service Details",
            unitPrice: "Unit Price",
            reading: "Reading",
            quantity: "Quantity",
            total: "Total",
            paid_amount: "Paid",
            remaining: "Remaining",
            paidStatus: "PAID",
            unpaidStatus: "UNPAID",
            payButton: "Pay Now",
            paymentNote: "Please pay on time",
            thankNote: "Thank you for your timely payment",                // Notifications screen
                notificationsTitle: "Notifications",
                markAllRead: "Mark All Read",
                billNotificationTitle: "Bill Notification",
                
                // Issues screen
                issuesTitle: "Reported Issues",
                reportIssue: "Report Issue",
                description: "Description",
                submitIssue: "Submit Report", 
                issueSubmitted: "Issue report submitted successfully!",
                needHelp: "Do you need help?",
                createFeedback: "Create Report",
                helpText: "If you encounter any issues, please create a report so the building management can be informed and handle it promptly for you!",
                
                // Issue form
                reportIssueTitle: "Report Issue",
                issueInfo: "Issue Information",
                detailedDescription: "Detailed Description",
                descriptionPlaceholder: "Describe the issue you encountered in detail...",
                images: "Images",
                addImage: "Add Image",
                chooseFromDevice: "Choose from Device",
                submitIssueBtn: "Submit Issue",
                cancel: "Cancel",
                
                // Issue status
                statusPending: "Pending",
                statusInProgress: "In Progress",
                statusCompleted: "Completed",
                statusCancelled: "Cancelled",
                
                // Issue notification
                issueFromRoom: "Issue from room",
                
                // Profile language section
                languageSection: "Language",
                
                // Profile screen
                profileTitle: "Profile",
                personalInfo: "Personal Information",
                fullName: "Full Name:",
                phoneNumber: "Phone Number:",
                language: "Language",
                loading: "Loading...",
                vietnamese: "Tiếng Việt",
                english: "English",
                logout: "Logout",
                
                // Payment screen
                paymentTitle: "PAYMENT",
                download: "Download",
                accountName: "Account Name",
                accountNumber: "Account Number",
                amount: "Amount",
                copy: "Copy",
                
                // Common
                close: "Close",
                save: "Save",
                loading: "Loading..."
            }
        };

        let currentLanguage = localStorage.getItem('language') || 'vi';

        function t(key) {
            return translations[currentLanguage]?.[key] || translations.vi[key] || key;
        }

        function switchLanguage(lang) {
            console.log('🌐 Switching language to:', lang);
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            
            // Update visual selection state
            document.querySelectorAll('[onclick*="switchLanguage"]').forEach(element => {
                const isSelected = element.onclick.toString().includes(`'${lang}'`);
                if (isSelected) {
                    element.classList.add('bg-green-100', 'border-l-4', 'border-green-500');
                    element.classList.remove('hover:bg-gray-50');
                } else {
                    element.classList.remove('bg-green-100', 'border-l-4', 'border-green-500');
                    element.classList.add('hover:bg-gray-50');
                }
            });
            
            // Update all UI elements
            updateAllUI();
            
            // Force re-render content with new language
            // console.log('🔄 Force re-rendering content...');
            if (notifications.length > 0) {
                renderNotificationsList();
            }
            if (bills.length > 0) {
                renderBillsList();
            }
            
            // Re-render issues list if exists
            const issuesContainer = document.getElementById('issues-list');
            if (issuesContainer && typeof issues !== 'undefined' && issues.length > 0) {
                renderIssuesList(issues);
            }
            
            // Update home screen content if needed
            if (typeof renderHomeData === 'function') {
                renderHomeData();
            }
        }

        function updateAllUI() {
            // Update navigation labels
            updateNavigationLabels();
            
            // Update all screens - detect current active screen
            const screens = ['home', 'bills', 'notifications', 'feedback', 'profile'];
            
            // Try to find active screen
            let activeScreen = null;
            for (const screen of screens) {
                const element = document.querySelector(`#${screen}-screen`);
                if (element && !element.classList.contains('hidden') && !element.style.display.includes('none')) {
                    activeScreen = screen;
                    console.log('🎯 Found active screen:', screen, element);
                    break;
                }
            }
            
            // Force update all screens for language change
            console.log('🔄 Force updating all screens for language change');
            updateHomeScreen();
            updateBillsScreen();
            updateNotificationsScreen();
            updateIssuesScreen();
            updateProfileScreen();
            updatePaymentScreen();
            updateBillDetailScreen();
            updateIssueFormScreen();
            
            // If we found an active screen, update it again
            if (activeScreen) {
                console.log('🎯 Additionally updating active screen:', activeScreen);
                updateScreenContent(activeScreen);
            }
        }

        function updateNavigationLabels() {
            // Update bottom navigation text (they are in spans, not direct text)
            const navItems = document.querySelectorAll('.nav-item');
            const labels = ['home', 'notifications', 'bills', 'feedback', 'profile'];
            
            // Note: Your navigation doesn't have text labels, only icons
            // If you want to add labels, you can modify the HTML structure
        }

        function updateScreenContent(screenId) {
            switch(screenId) {
                case 'home':
                    updateHomeScreen();
                    break;
                case 'bills':
                    updateBillsScreen();
                    break;
                case 'notifications':
                    updateNotificationsScreen();
                    break;
                case 'feedback':
                case 'issues':
                    updateIssuesScreen();
                    break;
                case 'profile':
                    updateProfileScreen();
                    break;
                case 'payment':
                    updatePaymentScreen();
                    break;
                case 'bill-detail':
                    updateBillDetailScreen();
                    break;
                case 'create-issue':
                    updateIssueFormScreen();
                    break;
            }
        }

        function updateHomeScreen() {
            // Update headers with IDs - welcome message removed
            const roomInfoHeader = document.getElementById('room-info-header');
            if (roomInfoHeader) {
                roomInfoHeader.textContent = t('roomInfo');
            }
            
            const contractDurationHeader = document.getElementById('contract-duration-header');
            if (contractDurationHeader) {
                contractDurationHeader.textContent = t('contractDuration');
            }
            
            const rentHeader = document.getElementById('rent-header');
            if (rentHeader) {
                rentHeader.textContent = t('monthlyRent');
            }
            
            const tenantHeader = document.getElementById('tenant-header');
            if (tenantHeader) {
                tenantHeader.textContent = t('tenantInfo');
            }
            
            // Update profile header
            const profileHeader = document.querySelector('#profile-screen h1');
            if (profileHeader) {
                profileHeader.textContent = t('profileTitle');
            }
        }

        function updateBillsScreen() {
            // console.log('💳 Updating bills screen, current language:', currentLanguage);
            
            const titleEl = document.getElementById('bills-title');
            if (titleEl) {
                const newTitle = t('billsTitle');
                console.log('🏷️ Updating bills title from', titleEl.textContent, 'to', newTitle);
                titleEl.textContent = newTitle;
            }
            
            // Re-render bills to update status labels and service names
            // console.log('🔄 Re-rendering bills list...');
            if (bills.length > 0) {
                renderBillsList();
            }
        }

        function updateNotificationsScreen() {
            // console.log('📧 Updating notifications screen, current language:', currentLanguage);
            
            const titleEl = document.querySelector('#notifications-title');
            if (titleEl) {
                const newTitle = t('notificationsTitle');
                console.log('🏷️ Updating title from', titleEl.textContent, 'to', newTitle);
                titleEl.textContent = newTitle;
            }
            
            // Re-render notifications to update content  
            // console.log('🔄 Re-rendering notifications list...');
            renderNotificationsList();
        }

        function updateIssuesScreen() {
            // Cập nhật title header
            const titleEl = document.getElementById('issues-header-title');
            if (titleEl) {
                titleEl.textContent = t('issues');
            }
            
            // Cập nhật "Bạn đang cần trợ giúp chứ?"
            const helpTitleEl = document.getElementById('need-help-title');
            if (helpTitleEl) {
                helpTitleEl.textContent = t('needHelp');
            }
            
            // Cập nhật text mô tả
            const helpTextEl = document.getElementById('help-text');
            if (helpTextEl) {
                helpTextEl.textContent = t('helpText');
            }
            
            // Cập nhật nút "Tạo phản ánh"
            const createFeedbackBtn = document.getElementById('create-feedback-btn');
            if (createFeedbackBtn) {
                createFeedbackBtn.textContent = t('createFeedback');
            }
            
            const helpDescEl = document.getElementById('help-description');
            if (helpDescEl) {
                helpDescEl.textContent = t('helpText');
            }
            
            const createBtn = document.getElementById('create-feedback-btn');
            if (createBtn) {
                createBtn.textContent = t('createFeedback');
            }
        }

        function updateProfileScreen() {
            // Update title
            const titleEl = document.querySelector('#profile-screen h1');
            if (titleEl) {
                titleEl.textContent = t('profileTitle');
            }
            
            // Update all elements with translate class in profile screen
            const translateElements = document.querySelectorAll('#profile-screen .translate');
            translateElements.forEach(element => {
                const key = element.getAttribute('data-key');
                if (key && translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });
            
            // Update language section header using ID selector
            const languageHeaderSpan = document.getElementById('language-header');
            if (languageHeaderSpan) {
                languageHeaderSpan.textContent = t('languageSection');
            }
            
            const logoutBtn = document.querySelector('#profile-screen .text-red-600 span');
            if (logoutBtn) {
                logoutBtn.textContent = t('logout');
            }
        }

        function updatePaymentScreen() {
            console.log('💳 Updating payment screen, current language:', currentLanguage);
            
            const titleEl = document.getElementById('payment-title');
            if (titleEl) {
                titleEl.textContent = t('paymentTitle');
            }
            
            const downloadEl = document.getElementById('download-text');
            if (downloadEl) {
                downloadEl.textContent = t('download');
            }
            
            const accountNameLabel = document.getElementById('account-name-label');
            if (accountNameLabel) {
                accountNameLabel.textContent = t('accountName');
            }
            
            const accountNumberLabel = document.getElementById('account-number-label');
            if (accountNumberLabel) {
                accountNumberLabel.textContent = t('accountNumber');
            }
            
            const amountLabel = document.getElementById('amount-label');
            if (amountLabel) {
                amountLabel.textContent = t('amount');
            }
            
            const copyBtns = document.querySelectorAll('#copy-account-btn, #copy-amount-btn');
            copyBtns.forEach(btn => {
                btn.textContent = t('copy');
            });
        }

        // Initialize app
        async function initApp() {
            try {
                await signInAnonymously(auth);
                
                const savedPhone = localStorage.getItem('userPhone');
                if (savedPhone) {
                    const customer = await loadCustomerData(savedPhone);
                    if (customer) {
                        await showHome(customer);
                        updateAppInteractionState(); // Enable interaction nếu đã đăng nhập
                        return;
                    }
                }
                
                showLogin();
                updateAppInteractionState(); // Disable interaction nếu chưa đăng nhập
            } catch (error) {
                console.error('Init error:', error);
                showLogin();
                updateAppInteractionState(); // Disable interaction khi có lỗi
            } finally {
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        async function loadCustomerData(phone) {
            try {
                const q = query(collection(db, 'customers'), where('phone', '==', phone));
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    return { id: doc.id, ...doc.data() };
                }
                return null;
            } catch (error) {
                console.error('Error loading customer:', error);
                return null;
            }
        }

        async function loadUserData(customerId) {
            try {
                // console.log('Loading data for customer ID:', customerId);
                
                // Load từ cache trước (nếu có)
                const cachedData = localStorage.getItem(`userData_${customerId}`);
                if (cachedData) {
                    const parsed = JSON.parse(cachedData);
                    buildings = parsed.buildings || [];
                    contracts = parsed.contracts || [];
                    // CHỈ LOAD HÓA ĐƠN ĐÃ DUYỆT TỪ CACHE
                    bills = (parsed.bills || []).filter(bill => bill.approved === true);
                    // console.log('✅ Loaded from cache - approved bills only:', bills.length);
                    renderHomeData(); // Hiện data cache trước
                }
                
                // Load song song để nhanh hơn
                const [contractsSnapshot, billsSnapshot] = await Promise.all([
                    getDocs(query(collection(db, 'contracts'), where('representativeId', '==', customerId))),
                    getDocs(query(collection(db, 'bills'), where('customerId', '==', customerId)))
                ]);
                
                contracts = contractsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // CHỈ LOAD HÓA ĐƠN ĐÃ DUYỆT
                bills = billsSnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(bill => bill.approved === true);
                // console.log('✅ Loaded bills from Firestore - approved only:', bills.length);
                
                // Load services if needed
                const servicesSnapshot = await getDocs(collection(db, 'services'));
                services = servicesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load buildings từ cả bills và contracts
                const buildingIdsFromBills = bills.map(b => b.buildingId).filter(id => id);
                const buildingIdsFromContracts = contracts.map(c => c.buildingId).filter(id => id);
                const buildingIds = [...new Set([...buildingIdsFromBills, ...buildingIdsFromContracts])];
                
                console.log('🏢 Building IDs to load:', buildingIds);
                console.log('📋 Contracts:', contracts.map(c => ({ id: c.id, buildingId: c.buildingId })));
                
                if (buildingIds.length > 0) {
                    const buildingsPromises = buildingIds.map(id => 
                        getDocs(query(collection(db, 'buildings'), where('__name__', '==', id)))
                    );
                    const buildingsResults = await Promise.all(buildingsPromises);
                    buildings = buildingsResults.flatMap(snap => 
                        snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    );
                    console.log('🏢 Loaded buildings:', buildings.map(b => ({ id: b.id, address: b.address })));
                } else {
                    buildings = [];
                    console.log('⚠️ No building IDs found in contracts or bills');
                }
                
                // Lưu cache
                localStorage.setItem(`userData_${customerId}`, JSON.stringify({
                    buildings, contracts, bills, timestamp: Date.now()
                }));
                
                // console.log('✅ Loaded fresh data - Bills:', bills.length);

            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // ⚡ OPTIMIZED: Function để chỉ reload bills (dùng cho optimistic update)
        async function reloadBillsOnly(customerId) {
            try {
                console.log('🔄 Reloading bills only for customer:', customerId);
                const billsSnapshot = await getDocs(query(collection(db, 'bills'), where('customerId', '==', customerId)));
                bills = billsSnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(bill => bill.approved === true);
                
                console.log('✅ Bills reloaded - approved only:', bills.length);
                
                // Update cache với bills mới
                const cachedData = localStorage.getItem(`userData_${customerId}`);
                if (cachedData) {
                    const parsed = JSON.parse(cachedData);
                    parsed.bills = bills;
                    parsed.timestamp = Date.now();
                    localStorage.setItem(`userData_${customerId}`, JSON.stringify(parsed));
                }
                
                // Re-render UI
                renderHomeData();
                updateBillsScreen();
                
            } catch (error) {
                console.error('❌ Error reloading bills:', error);
            }
        }

        // 💾 CACHE CONSTANTS
        const CACHE_VERSION = '1.0';
        const CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24 giờ
        
        // Real-time listeners cho thông báo - ĐÃ TỐI ƯU CACHE
        let activeListeners = []; // Lưu các listener để cleanup
        
        /**
         * 💾 Lưu data user vào máy tính
         */
        function saveUserDataToCache(customerId, data) {
            try {
                const cacheData = {
                    version: CACHE_VERSION,
                    timestamp: Date.now(),
                    customerId: customerId,
                    data: data
                };
                localStorage.setItem(`n_home_user_${customerId}`, JSON.stringify(cacheData));
                console.log(`💾 Đã lưu data user ${customerId} vào máy tính`);
            } catch (error) {
                console.error('❌ Lỗi lưu cache:', error);
            }
        }
        
        /**
         * 📖 Đọc data user từ máy tính
         */
        function loadUserDataFromCache(customerId) {
            try {
                const cached = localStorage.getItem(`n_home_user_${customerId}`);
                if (!cached) return null;
                
                const cacheData = JSON.parse(cached);
                
                // 🔥 CACHE EXPIRY NGẮN HƠN CHO REALTIME DATA
                const SHORT_CACHE_EXPIRY = 3 * 60 * 1000; // 3 phút cho critical data như bills
                const age = Date.now() - cacheData.timestamp;
                
                // Kiểm tra version và hạn sử dụng
                if (cacheData.version !== CACHE_VERSION || age > SHORT_CACHE_EXPIRY) {
                    console.log(`⏰ Cache hết hạn hoặc cũ (${Math.round(age / 1000 / 60)} phút), xóa cache`);
                    localStorage.removeItem(`n_home_user_${customerId}`);
                    return null;
                }
                
                console.log(`📖 Load data user ${customerId} từ cache (${Math.round(age / 1000 / 60)} phút tuổi)`);
                return cacheData.data;
                
            } catch (error) {
                console.error('❌ Lỗi đọc cache:', error);
                return null;
            }
        }
        
        function setupRealtimeListeners(customerId) {
            console.log(`🚀 Setup listeners cho user: ${customerId}`);
            
            // Cleanup listeners cũ trước
            activeListeners.forEach(unsubscribe => {
                if (typeof unsubscribe === 'function') {
                    unsubscribe();
                }
            });
            activeListeners = [];
            
            // 💾 BƯỚC 1: Thử load từ cache trước
            const cachedData = loadUserDataFromCache(customerId);
            if (cachedData) {
                console.log('⚡ Hiển thị data từ cache ngay');
                // Load data từ cache
                bills = cachedData.bills || [];
                notifications = cachedData.notifications || [];
                
                // 🔄 MIGRATION: Chuyển old notifications sang unified system (1 lần duy nhất)
                const userPhone = localStorage.getItem('userPhone');
                if (userPhone && notifications.length === 0) {
                    const oldNotifications = localStorage.getItem(`notifications_${userPhone}`);
                    if (oldNotifications) {
                        try {
                            const parsed = JSON.parse(oldNotifications);
                            if (Array.isArray(parsed) && parsed.length > 0) {
                                notifications = parsed;
                                console.log('🔄 Migrated', notifications.length, 'old notifications to unified system');
                                // Save to unified cache và xóa old storage
                                saveUserDataToCache(customerId, { bills, notifications, timestamp: Date.now() });
                                localStorage.removeItem(`notifications_${userPhone}`);
                            }
                        } catch (e) {
                            console.log('Error migrating old notifications:', e);
                        }
                    }
                }
                
                // Hiển thị ngay
                renderHomeData();
                renderBillsList();
                renderNotificationsList();
                // updateNotificationBadge(); // Đã gọi trong renderNotificationsList()
            }
            
            // 1. LẮNG NGHE HÓA ĐƠN - CHỈ HIỂN THỊ HÓA ĐƠN ĐÃ DUYỆT (bỏ orderBy)
            const billsQuery = query(
                collection(db, 'bills'), 
                where('customerId', '==', customerId)
                // Bỏ orderBy để tránh index error, sẽ sort ở client
            );
            
            let isFirstBillLoad = true;
            
            const billsUnsubscribe = onSnapshot(billsQuery, (snapshot) => {
                console.log(`📊 Bills changes: ${snapshot.docChanges().length} reads`);
                
                if (isFirstBillLoad) {
                    bills = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(bill => bill.approved === true)
                        .sort((a, b) => {
                            // Ưu tiên billDate, fallback createdAt, cuối cùng là period
                            const getTime = (bill) => {
                                if (bill.billDate) {
                                    if (bill.billDate.toDate) return bill.billDate.toDate().getTime();
                                    if (typeof bill.billDate === 'string' && bill.billDate.includes('/')) {
                                        const parts = bill.billDate.split('/');
                                        return new Date(parts[2], parts[1] - 1, parts[0]).getTime();
                                    }
                                    return new Date(bill.billDate).getTime();
                                }
                                if (bill.createdAt) {
                                    if (bill.createdAt.toDate) return bill.createdAt.toDate().getTime();
                                    return new Date(bill.createdAt).getTime();
                                }
                                // Fallback: từ period
                                const period = parseInt(bill.period) || 11;
                                return new Date(2025, period - 1, 1).getTime();
                            };
                            return getTime(b) - getTime(a); // Mới nhất trước
                        });
                    
                    // 🔥 LUÔN RENDER DỮ LIỆU MỚI NHẤT TỪ FIREBASE (KHÔNG SKIP)
                    console.log('🔄 First load - rendering fresh data from Firebase');
                    renderHomeData();
                    renderBillsList();
                    isFirstBillLoad = false;
                    
                    // 💾 Lưu vào cache SAU KHI ĐÃ RENDER
                    saveUserDataToCache(customerId, { 
                        bills, 
                        notifications,
                        timestamp: Date.now()
                    });
                    return;
                }
                
                // Real-time update
                const newBills = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(bill => bill.approved === true)
                    .sort((a, b) => {
                        // Ưu tiên billDate, fallback createdAt, cuối cùng là period
                        const getTime = (bill) => {
                            if (bill.billDate) {
                                if (bill.billDate.toDate) return bill.billDate.toDate().getTime();
                                if (typeof bill.billDate === 'string' && bill.billDate.includes('/')) {
                                    const parts = bill.billDate.split('/');
                                    return new Date(parts[2], parts[1] - 1, parts[0]).getTime();
                                }
                                return new Date(bill.billDate).getTime();
                            }
                            if (bill.createdAt) {
                                if (bill.createdAt.toDate) return bill.createdAt.toDate().getTime();
                                return new Date(bill.createdAt).getTime();
                            }
                            // Fallback: từ period
                            const period = parseInt(bill.period) || 11;
                            return new Date(2025, period - 1, 1).getTime();
                        };
                        return getTime(b) - getTime(a); // Mới nhất trước
                    });
                
                // Check for real changes including status updates
                const hasChanges = newBills.length !== bills.length || 
                    !newBills.every(nb => {
                        const ob = bills.find(bill => bill.id === nb.id);
                        return ob && ob.status === nb.status && ob.paid === nb.paid;
                    });
                
                if (hasChanges) {
                    console.log('🔄 Bills updated - status changes detected, FORCE UPDATE UI');
                    bills = newBills;
                    
                    // 🔥 CRITICAL: Force clear cache cũ để tránh conflict
                    localStorage.removeItem(`n_home_user_${customerId}`);
                    localStorage.removeItem(`userData_${customerId}`);
                    
                    // Force refresh UI to show payment status changes
                    renderHomeData();
                    renderBillsList();
                    
                    // Update notification badge if needed
                    updateNotificationBadge();
                    
                    // 💾 Lưu cache mới với timestamp mới
                    saveUserDataToCache(customerId, { 
                        bills, 
                        notifications,
                        timestamp: Date.now()
                    });
                }
            }, (error) => {
                console.error('❌ Bills listener error:', error.message || error);
            });
            
            activeListeners.push(billsUnsubscribe);

            // 2. LẮNG NGHE TRANSACTIONS - BẮT TRÚNG KHI WEB THU TIỀN (bỏ orderBy)
            const transactionsQuery = query(
                collection(db, 'transactions'),
                where('customerId', '==', customerId),
                where('type', '==', 'income') // Chỉ lắng nghe phiếu thu, bỏ orderBy
            );
            
            let isFirstTransactionLoad = true;
            
            onSnapshot(transactionsQuery, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const transactionData = { id: change.doc.id, ...change.doc.data() };
                    
                    if (change.type === 'added' && transactionData.approved && transactionData.billId) {
                        // Tạo IN-APP NOTIFICATION (không có push notification để tránh duplicate)
                        console.log('💰 Payment transaction created by admin:', transactionData.id);
                        
                        // Tính tổng tiền từ items
                        const totalAmount = transactionData.items 
                            ? transactionData.items.reduce((sum, item) => sum + (item.amount || 0), 0)
                            : 0;
                            
                        // Kiểm tra xem đã có thông báo cho transaction này chưa
                        const existingPaymentNotification = notifications.find(n => n.data?.transactionId === transactionData.id);
                        if (!existingPaymentNotification) {
                            // Tạo notification trong app (không push)
                            const notification = {
                                id: `payment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                type: 'payment_received',
                                title: 'Xác nhận thanh toán',
                                message: `Chúng tôi đã nhận được khoản thanh toán ${formatCurrency(totalAmount)} của bạn. Xin cảm ơn!`,
                                createdAt: transactionData.createdAt?.toDate ? transactionData.createdAt.toDate() : new Date(),
                                isRead: false, // LUÔN chưa đọc để user phải bấm đọc
                                data: { 
                                    transactionId: transactionData.id, 
                                    billId: transactionData.billId, 
                                    amount: totalAmount 
                                }
                            };
                            
                            // Thêm vào danh sách notifications
                            notifications.unshift(notification);
                            
                            // Chỉ hiển thị popup nếu KHÔNG phải load lần đầu
                            if (!isFirstTransactionLoad) {
                                showInAppNotification('Xác nhận thanh toán', notification.message);
                            }
                            
                            saveNotificationsToStorage();
                            renderNotificationsList();
                            
                            console.log('✅ Created in-app payment notification, isFirstLoad:', isFirstTransactionLoad);
                        }
                    }
                    
                    // 🗑️ XỬ LÝ KHI TRANSACTION BỊ XÓA (HỦY THU TIỀN)
                    if (change.type === 'removed' && transactionData.billId) {
                        console.log('🗑️ Transaction deleted by admin:', transactionData.id);
                        
                        // Tìm và xóa notification có transactionId tương ứng
                        const initialLength = notifications.length;
                        notifications = notifications.filter(notification => 
                            notification.data?.transactionId !== transactionData.id
                        );
                        
                        if (notifications.length < initialLength) {
                            console.log('✅ Đã xóa thông báo thanh toán do hủy thu tiền');
                            saveNotificationsToStorage();
                            renderNotificationsList();
                        } else {
                            console.log('ℹ️ Không tìm thấy thông báo thanh toán để xóa');
                        }
                    }
                });
                
                // Đánh dấu đã load xong lần đầu
                if (isFirstTransactionLoad) {
                    console.log('✅ First transaction load completed');
                    isFirstTransactionLoad = false;
                }
            });

            // 3. LẮNG NGHE TASKS - BẮT TRÚNG KHI WEB DUYỆT SỰ CỐ (toggleTaskStatus)
            const tasksQuery = query(
                collection(db, 'tasks'),
                where('customerId', '==', customerId),
                orderBy('createdAt', 'desc')
            );
            
            let isFirstTaskLoad = true;
            
            onSnapshot(tasksQuery, (snapshot) => {
                
                snapshot.docChanges().forEach((change) => {
                    const taskData = { id: change.doc.id, ...change.doc.data() };
                    
                    if (change.type === 'modified') {
                        // YÊU CẦU 4: KHI WEB DUYỆT SỰ CỐ (status: pending -> completed)
                        if (taskData.status === 'completed') {
                            console.log('✅ Task completed by admin:', taskData.id, taskData.title);
                            
                            // Kiểm tra xem đã có thông báo cho task này chưa
                            const existingTaskNotification = notifications.find(n => n.data?.taskId === taskData.id);
                            if (!existingTaskNotification) {
                                const notification = {
                                    id: `task_resolved_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                    type: 'issue_resolved',
                                    title: 'Sự cố đã được giải quyết',
                                    message: `Sự cố "${taskData.title}" đã được xử lý hoàn thành. Cảm ơn bạn đã phản hồi!`,
                                    createdAt: taskData.updatedAt?.toDate ? taskData.updatedAt.toDate() : new Date(),
                                    isRead: isFirstTaskLoad ? true : false, // Đánh dấu đã đọc nếu là load lần đầu
                                    data: { taskId: taskData.id }
                                };
                                
                                notifications.unshift(notification);
                                
                                // Chỉ hiển thị popup nếu KHÔNG phải load lần đầu
                                if (!isFirstTaskLoad) {
                                    showInAppNotification('Sự cố đã được giải quyết', notification.message);
                                }
                                
                                saveNotificationsToStorage();
                                renderNotificationsList();
                                
                                console.log('✅ Created task completion notification, isFirstLoad:', isFirstTaskLoad);
                            }
                        }
                    }
                });
                
                // Đánh dấu đã load xong lần đầu
                if (isFirstTaskLoad) {
                    console.log('✅ First task load completed');
                    isFirstTaskLoad = false;
                }
            });

            // 5. LẮNG NGHE THÔNG BÁO ADMIN - adminNotifications collection
            // Lắng nghe theo buildingId và room của khách hàng
            console.log('🔍 Searching contract for customer:', customerId);
            console.log('🔍 Available contracts:', contracts);
            const contract = contracts.find(c => c.representativeId === customerId);
            if (contract) {
                console.log('✅ Contract found! BuildingId:', contract.buildingId, 'Room:', contract.room);
                console.log('📍 Setting up admin notifications for:', contract.buildingId, contract.room);
                // Query đơn giản chỉ theo buildingId (bỏ orderBy để tránh index error)
                const adminNotificationsQuery = query(
                    collection(db, 'adminNotifications'),
                    where('buildingId', '==', contract.buildingId)
                );
            
                let isFirstNotificationLoad = true;
                
                console.log('🔗 Setting up admin notifications listener...');
                const unsubscribeAdmin = onSnapshot(adminNotificationsQuery, (snapshot) => {
                console.log('🔔 Firebase snapshot received, total docs:', snapshot.docs.length);
                
                snapshot.docChanges().forEach((change) => {
                // console.log('🔔 Document change detected:', change.type, change.doc.id, 'isFirstLoad:', isFirstNotificationLoad);
                
                const notificationData = { id: change.doc.id, ...change.doc.data() };
                // console.log('📋 Notification data:', notificationData);
                    
                    // Skip modified events để tránh spam khi mark as read
                    if (change.type === 'modified') {
                        // console.log('⏭️ Skipping modified notification:', change.doc.id);
                        return;
                    }
                    
                    // Filter room ở client side (query chỉ filter buildingId)
                    // QUAN TRỌNG: Chỉ hiện thông báo cho đúng khách hàng (customerId) và đúng phòng (room)
                    const isForThisCustomer = !notificationData.customerId || notificationData.customerId === customerId;
                    const isForThisRoom = notificationData.room === contract.room;
                    // console.log('🔔 Processing notification:', notificationData.type, 'customer match:', isForThisCustomer, 'room match:', isForThisRoom);
                    
                    if (change.type === 'added' && isForThisRoom && isForThisCustomer) {
                        // console.log('🔔 New customer notification received:', notificationData.type, notificationData.message);
                        
                        // Kiểm tra xem notification đã tồn tại chưa
                        const existingNotification = notifications.find(n => n.id === change.doc.id);
                        if (existingNotification) {
                            // console.log('⏭️ Notification already exists, skipping:', change.doc.id);
                            return;
                        }
                        
                        // Hiển thị thông báo admin với customerMessage
                        const messageToShow = notificationData.customerMessage || notificationData.message;
                        // console.log('🔔 Admin notification for customer:', messageToShow);
                        
                        // ⚡ OPTIMISTIC UPDATE: Reload bills ngay lập tức khi có thông báo bill approved
                        if (notificationData.type === 'bill_approved' && notificationData.billId && currentUser?.id) {
                            console.log('⚡ Bill approved notification - triggering IMMEDIATE bills reload');
                            // Reload ONLY bills immediately, không cần chờ Firestore listener
                            setTimeout(() => {
                                reloadBillsOnly(currentUser.id);
                            }, 50);
                        }
                        
                        // 🚫 FILTER: Ẩn thông báo tạo sự cố, chỉ hiện nghiệm thu
                        const issueCreationTypes = ['customer_issue', 'issue_created', 'issue_reported'];
                        // 🚫 FILTER: Ẩn payment notifications để tránh duplicate với transaction listener
                        const paymentTypes = ['payment_received', 'payment_confirmed'];
                        // 🚫 FILTER: Ẩn thông báo thu tiền admin (chỉ dành cho web admin)
                        const adminOnlyTypes = ['payment_collected'];
                        const shouldShowNotification = !issueCreationTypes.includes(notificationData.type) && 
                                                     !paymentTypes.includes(notificationData.type) &&
                                                     !adminOnlyTypes.includes(notificationData.type);
                        
                        if (!shouldShowNotification) {
                            console.log('🔇 Hiding notification type:', notificationData.type, '(handled elsewhere)');
                            return; // Không hiện thông báo được filter
                        }
                        
                        // Chỉ tạo thông báo nếu chưa tồn tại (tránh ghi đè trạng thái đã đọc)
                        const localExistingNotification = notifications.find(n => n.data?.firebaseId === change.doc.id);
                        if (!localExistingNotification) {
                            console.log('✅ Adding notification type:', notificationData.type, 'isFirstLoad:', isFirstNotificationLoad);
                            
                            // Tạo notification object
                            const notification = {
                                id: `${notificationData.type}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                type: notificationData.type,
                                title: notificationData.title,
                                message: messageToShow,
                                createdAt: notificationData.createdAt?.toDate ? notificationData.createdAt.toDate() : new Date(),
                                isRead: false, // LUÔN chưa đọc để user phải bấm đọc
                                data: { 
                                    billId: notificationData.billId,
                                    amount: notificationData.amount,
                                    taskId: notificationData.taskId,
                                    transactionId: notificationData.transactionId,
                                    firebaseId: change.doc.id // Lưu Firebase ID để có thể xóa sau
                                }
                            };
                            
                            // Thêm vào đầu danh sách
                            notifications.unshift(notification);
                            
                            // Sắp xếp theo THÁNG HÓA ĐƠN thay vì thời gian tạo
                            notifications.sort((a, b) => {
                                const getBillMonth = (notification) => {
                                    const message = notification.message || notification.title || '';
                                    const monthMatch = message.match(/tháng\s+(\d+)(?:-(\d+))?/i);
                                    if (monthMatch) {
                                        const month = parseInt(monthMatch[1]);
                                        const year = monthMatch[2] ? parseInt(monthMatch[2]) : 2025;
                                        return year * 100 + month;
                                    }
                                    if (notification.data?.billId && bills?.length > 0) {
                                        const bill = bills.find(b => b.id === notification.data.billId);
                                        if (bill?.period) return 2025 * 100 + parseInt(bill.period);
                                    }
                                    return 202511;
                                };
                                
                                const monthA = getBillMonth(a);
                                const monthB = getBillMonth(b);
                                
                                if (monthA === monthB) {
                                    const isPaymentA = (a.title || '').includes('Xác nhận thanh toán');
                                    const isPaymentB = (b.title || '').includes('Xác nhận thanh toán');
                                    if (isPaymentA && !isPaymentB) return -1;
                                    if (!isPaymentA && isPaymentB) return 1;
                                }
                                
                                return monthB - monthA; // Tháng mới trước
                            });
                            
                            // Chỉ hiển thị popup nếu KHÔNG phải load lần đầu
                            if (!isFirstNotificationLoad) {
                                showInAppNotification(notificationData.title, messageToShow);
                            }
                            
                            // Lưu và render NGAY LẬP TỨC
                            saveNotificationsToStorage();
                            
                            // 🔥 FORCE CLEAR DOM trước khi render lại
                            const listEl = document.getElementById('notifications-list');
                            if (listEl) {
                                listEl.innerHTML = '<div class="text-center py-4">Đang cập nhật...</div>';
                            }
                            
                            // Render với delay nhỏ để UI có thời gian update
                            setTimeout(() => {
                                renderNotificationsList();
                                console.log('🔄 Forced notification list refresh');
                            }, 10);
                        } else {
                            // console.log('⏭️ Notification already exists locally, skipping creation to preserve read status');
                        }
                    }
                    
                    // Xử lý khi thông báo bị xóa trên web admin (Bill bỏ duyệt)
                    if (change.type === 'removed' && isForThisRoom) {
                        console.log('🗑️ Admin notification deleted:', change.doc.id);
                        
                        // ⚡ OPTIMISTIC UPDATE: Khi notification bị xóa = bill bị bỏ duyệt → reload bills ngay
                        if (currentUser?.id) {
                            console.log('⚡ Notification deleted - triggering IMMEDIATE bills reload (bill unapproved)');
                            setTimeout(() => {
                                reloadBillsOnly(currentUser.id);
                            }, 50);
                        }
                        
                        // Tìm và xóa thông báo tương ứng trong app
                        removeNotificationByFirebaseId(change.doc.id);
                    }
                });
                
                // Đánh dấu đã load xong lần đầu
                if (isFirstNotificationLoad) {
                    console.log('✅ First notification load completed');
                    isFirstNotificationLoad = false;
                }
            }, (error) => {
                console.error('❌ Admin notifications listener error:', error.message || error);
                // Listener sẽ tự động reconnect, không cần handle thêm
            });
            
            // Lưu unsubscribe function
            activeListeners.push(unsubscribeAdmin);
            console.log('✅ Admin notifications listener added to cleanup list');
            
            } else {
                console.log('❌ No contract found for customer:', customerId);
            }
        }

        function showLogin() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('home-screen').classList.add('hidden');
        }

        async function showHome(customer) {
            currentUser = customer;
            customerData = customer; // Set global customerData for language system
            
            // 🔥 FORCE CLEAR CACHE KHI LOGIN ĐỂ LOAD DỮ LIỆU MỚI
            console.log('🗑️ Clearing cache on login to force fresh data load');
            localStorage.removeItem(`userData_${customer.id}`);
            
            // Clear app state
            bills = [];
            notifications = [];
            buildings = [];
            contracts = [];
            services = [];
            
            // Notifications are loaded from unified cache in setupRealtimeListeners
            // No need for separate loadNotificationsFromStorage() call
            
            // Badge will be updated when notifications are rendered
            // updateNotificationBadge();
            
            // Hiện giao diện ngay, chưa cần đợi data
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('home-screen').classList.remove('hidden');
            
            // Load data trong background
            await loadUserData(customer.id);
            renderHomeData();
            renderBillsList();
            
            // Update UI with current language
            updateAllUI();
            
            // Setup real-time listeners cho thông báo
            setupRealtimeListeners(customer.id);
            
            // Request notification permission - TẮT
            // requestNotificationPermission();
        }

        function renderHomeData() {
            perfMon.track('renderHomeData');
            
            // Render building info
            const buildingInfo = document.getElementById('building-info');
            if (contracts.length > 0) {
                const contract = contracts[0];
                const building = buildings.find(b => b.id === contract.buildingId);
                
                // Debug mapping
                console.log('🔍 Contract buildingId:', contract.buildingId);
                console.log('🏢 Available buildings:', buildings.map(b => ({ id: b.id, address: b.address })));
                console.log('🎯 Found building:', building);
                
                buildingInfo.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">${currentLanguage === 'en' ? 'Room:' : 'Phòng:'}</span>
                            <span class="font-bold text-gray-800">${contract.room || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between items-start">
                            <span class="text-gray-600">${currentLanguage === 'en' ? 'Address:' : 'Địa chỉ:'}</span>
                            <span class="font-semibold text-gray-800 text-right">${building?.address || 'N/A'}</span>
                        </div>
                    </div>
                `;
            } else {
                buildingInfo.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <p>${currentLanguage === 'en' ? 'No building information' : 'Chưa có thông tin toà nhà'}</p>
                    </div>
                `;
            }

            // Render contract duration info
            const contractDurationInfo = document.getElementById('contract-duration-info');
            if (contracts.length > 0) {
                const contract = contracts[0];
                
                // Format dates
                const formatDate = (dateStr) => {
                    if (!dateStr) return 'N/A';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('vi-VN');
                    } catch (e) {
                        return dateStr;
                    }
                };
                
                const startDate = formatDate(contract.startDate);
                const endDate = formatDate(contract.endDate);
                
                // Calculate remaining days
                const today = new Date();
                const contractEndDate = new Date(contract.endDate);
                const diffTime = contractEndDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let remainingText = '';
                let remainingClass = 'text-green-600';
                if (diffDays > 30) {
                    remainingText = `${diffDays} ngày`;
                    remainingClass = 'text-green-600';
                } else if (diffDays > 0) {
                    remainingText = `${diffDays} ngày`;
                    remainingClass = 'text-yellow-600';
                } else {
                    remainingText = 'Đã hết hạn';
                    remainingClass = 'text-red-600';
                }
                
                contractDurationInfo.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">${currentLanguage === 'en' ? 'Start Date:' : 'Bắt đầu:'}</span>
                            <span class="font-semibold text-gray-800">${startDate}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">${currentLanguage === 'en' ? 'End Date:' : 'Kết thúc:'}</span>
                            <span class="font-semibold text-gray-800">${endDate}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">${currentLanguage === 'en' ? 'Remaining:' : 'Còn lại:'}</span>
                            <span class="font-bold ${remainingClass}">${remainingText}</span>
                        </div>
                    </div>
                `;
            } else {
                contractDurationInfo.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <p>${currentLanguage === 'en' ? 'No contract information' : 'Chưa có thông tin hợp đồng'}</p>
                    </div>
                `;
            }

            // Render rent info (from first contract)
            const rentInfo = document.getElementById('rent-info');
            if (contracts.length > 0) {
                const contract = contracts[0];
                const building = buildings.find(b => b.id === contract.buildingId);
                
                // Debug: Log all contract fields to see what's available
                // console.log('All contract fields:', Object.keys(contract));
                // console.log('Contract data:', contract);
                
                rentInfo.innerHTML = `
                    <div class="space-y-0 -mx-5 -my-5">
                        <div class="flex justify-between items-center py-3 px-5 bg-white">
                            <div>
                                <p class="font-medium text-gray-800">${currentLanguage === 'en' ? 'Rent' : 'Tiền nhà'}</p>
                            </div>
                            <p class="font-bold text-gray-800">${formatCurrency(contract.rentPrice || contract.roomPrice || 0)} / ${currentLanguage === 'en' ? 'month' : 'tháng'}</p>
                        </div>
                        
                        <div class="flex justify-between items-center py-3 px-5 bg-gray-50">
                            <div>
                                <p class="font-medium text-gray-800">${currentLanguage === 'en' ? 'Deposit' : 'Tiền cọc'}</p>
                            </div>
                            <p class="font-bold text-gray-800">${formatCurrency(contract.deposit || 0)}</p>
                        </div>
                        

                        
                        ${contract.vehiclePrice ? `
                        <div class="flex justify-between items-center py-3 px-5 bg-white">
                            <div>
                                <p class="font-medium text-gray-800">${currentLanguage === 'en' ? 'Parking Fee' : 'Tiền xe'}</p>
                                <p class="text-xs text-gray-500">${currentLanguage === 'en' ? 'Quantity:' : 'Số lượng:'} ${contract.vehicleCount || 1}</p>
                            </div>
                            <p class="font-bold text-gray-800">${formatCurrency(contract.vehiclePrice)} / ${currentLanguage === 'en' ? 'vehicle' : 'xe'}</p>
                        </div>
                        ` : ''}
                        
                        ${contract.serviceDetails && contract.serviceDetails.length > 0 ? 
                            contract.serviceDetails.map((serviceDetail, index) => {
                                const service = services.find(s => s.id === serviceDetail.serviceId);
                                if (service) {
                                    const isElectric = service.name.toLowerCase().includes('điện');
                                    const isWater = service.name.toLowerCase().includes('nước');
                                    const isMetered = isElectric || (isWater && (service.unit === 'm³' || service.unit === 'khối'));
                                    const bgClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                                    
                                    // Translate service name
                                    const translateServiceName = (name) => {
                                        if (currentLanguage === 'en') {
                                            if (name.toLowerCase().includes('điện')) return 'Electricity';
                                            if (name.toLowerCase().includes('nước')) return 'Water';
                                            if (name.toLowerCase().includes('dịch vụ chung')) return 'Common Service';
                                            if (name.toLowerCase().includes('xe')) return 'Parking';
                                            return name; // Keep original if no translation
                                        }
                                        return name;
                                    };
                                    
                                    const translateUnit = (unit) => {
                                        if (currentLanguage === 'en') {
                                            if (unit === 'Người') return 'Person';
                                            if (unit === 'Phòng') return 'Room';
                                            if (unit === 'xe') return 'Vehicle';
                                            return unit;
                                        }
                                        return unit;
                                    };
                                    
                                    return `
                                    <div class="flex justify-between items-center py-3 px-5 ${bgClass}">
                                        <div>
                                            <p class="font-medium text-gray-800">${translateServiceName(service.name)}</p>
                                            ${isElectric && serviceDetail.initialReading ? `<p class="text-xs text-gray-500">${currentLanguage === 'en' ? 'Initial reading:' : 'Chỉ số đầu:'} ${serviceDetail.initialReading}</p>` : 
                                             isWater && serviceDetail.quantity ? `<p class="text-xs text-gray-500">${currentLanguage === 'en' ? 'Quantity:' : 'Số lượng:'} ${serviceDetail.quantity}</p>` :
                                             serviceDetail.quantity > 1 ? `<p class="text-xs text-gray-500">${currentLanguage === 'en' ? 'Quantity:' : 'Số lượng:'} ${serviceDetail.quantity}</p>` : ''}
                                        </div>
                                        <p class="font-bold text-gray-800">${formatCurrency(service.price || 0)} / ${translateUnit(service.unit || 'đơn vị')}</p>
                                    </div>
                                    `;
                                }
                                return '';
                            }).join('')
                        : ''}
                    </div>
                `;
            } else {
                rentInfo.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                    <p>${currentLanguage === 'en' ? 'No contract information' : 'Chưa có thông tin hợp đồng'}</p>
                </div>
                `;
            }

            // Render tenant info
            const tenantInfo = document.getElementById('tenant-info');
            if (currentUser) {
                tenantInfo.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">${currentLanguage === 'en' ? 'Full Name:' : 'Họ tên:'}</span>
                            <span class="font-bold text-gray-800">${currentUser.name || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">${currentLanguage === 'en' ? 'Phone Number:' : 'Số điện thoại:'}</span>
                            <span class="font-bold text-gray-800">${currentUser.phone || 'N/A'}</span>
                        </div>
                    </div>
                `;
            } else {
                tenantInfo.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <p>${currentLanguage === 'en' ? 'No tenant information' : 'Chưa có thông tin người thuê'}</p>
                    </div>
                `;
            }
        }

        function renderBillsList() {
            perfMon.track('renderBillsList');
            // console.log('📋 Rendering bills list with language:', currentLanguage);
            
            // 🔥 ĐẢMBẢO SẮP XẾP TRƯỚC KHI RENDER
            bills.sort((a, b) => {
                const getTime = (bill) => {
                    if (bill.billDate) {
                        if (bill.billDate.toDate) return bill.billDate.toDate().getTime();
                        if (typeof bill.billDate === 'string' && bill.billDate.includes('/')) {
                            const parts = bill.billDate.split('/');
                            return new Date(parts[2], parts[1] - 1, parts[0]).getTime();
                        }
                        return new Date(bill.billDate).getTime();
                    }
                    if (bill.createdAt) {
                        if (bill.createdAt.toDate) return bill.createdAt.toDate().getTime();
                        return new Date(bill.createdAt).getTime();
                    }
                    const period = parseInt(bill.period) || 11;
                    return new Date(2025, period - 1, 1).getTime();
                };
                return getTime(b) - getTime(a); // Mới nhất trước
            });
            
            // Render bills
            const billsList = document.getElementById('bills-list-page');
            if (!billsList) {
                console.error('bills-list-page element not found');
                return;
            }
            
            if (bills.length === 0) {
                billsList.innerHTML = `
                    <div class="bg-white rounded-xl p-8 text-center text-gray-500 shadow-sm">
                        <div class="w-20 h-20 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                            <svg class="w-10 h-10 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <p class="font-medium text-gray-700">${currentLanguage === 'en' ? 'No bills yet' : 'Chưa có hóa đơn nào'}</p>
                        <p class="text-sm text-gray-500 mt-1">${currentLanguage === 'en' ? 'Your bills will appear here' : 'Hóa đơn của bạn sẽ xuất hiện tại đây'}</p>
                    </div>
                `;
            } else {
                // Sắp xếp bills theo thời gian mới nhất với fallback tốt hơn
                const sortedBills = bills.sort((a, b) => {
                    // Ưu tiên billDate, fallback createdAt, cuối cùng là period + năm
                    const getDateA = () => {
                        if (a.billDate) {
                            if (a.billDate.toDate) return a.billDate.toDate();
                            if (typeof a.billDate === 'string' && a.billDate.includes('/')) {
                                const parts = a.billDate.split('/');
                                return new Date(parts[2], parts[1] - 1, parts[0]);
                            }
                            return new Date(a.billDate);
                        }
                        if (a.createdAt) {
                            if (a.createdAt.toDate) return a.createdAt.toDate();
                            return new Date(a.createdAt);
                        }
                        // Fallback: tạo date từ period (tháng hiện tại)
                        const period = parseInt(a.period) || new Date().getMonth() + 1;
                        return new Date(2025, period - 1, 1);
                    };
                    
                    const getDateB = () => {
                        if (b.billDate) {
                            if (b.billDate.toDate) return b.billDate.toDate();
                            if (typeof b.billDate === 'string' && b.billDate.includes('/')) {
                                const parts = b.billDate.split('/');
                                return new Date(parts[2], parts[1] - 1, parts[0]);
                            }
                            return new Date(b.billDate);
                        }
                        if (b.createdAt) {
                            if (b.createdAt.toDate) return b.createdAt.toDate();
                            return new Date(b.createdAt);
                        }
                        // Fallback: tạo date từ period (tháng hiện tại)
                        const period = parseInt(b.period) || new Date().getMonth() + 1;
                        return new Date(2025, period - 1, 1);
                    };
                    
                    const dateA = getDateA();
                    const dateB = getDateB();
                    
                    // Mới nhất trước (dateB - dateA)
                    return dateB.getTime() - dateA.getTime();
                });

                billsList.innerHTML = sortedBills.map(bill => {
                    const building = buildings.find(b => b.id === bill.buildingId);
                    
                    // Xác định trạng thái và màu sắc
                    const isPaid = bill.status === 'paid';
                    const statusBadge = isPaid 
                        ? `<span class="bg-green-600 text-white px-3 py-1 rounded-full text-xs font-medium">${t('paid')}</span>`
                        : `<span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-medium">${t('unpaid')}</span>`;
                    
                    // Format ID hóa đơn
                    const billCode = bill.code || `#INV${bill.id?.slice(-6)?.toUpperCase() || ''}`;
                    
                    // Format tiêu đề hóa đơn - keep data values (month, year) unchanged
                    const billTitle = currentLanguage === 'en' 
                        ? `Monthly rent bill ${bill.period} - 2025`
                        : `Hóa đơn tiền nhà tháng ${bill.period} - 2025`;
                    
                    return `
                        <div class="bill-card bg-white rounded-xl p-4 shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all duration-200" data-bill-id="${bill.id}">
                            <!-- Header -->
                            <div class="mb-3">
                                <h3 class="font-bold text-gray-900 text-base">${billTitle}</h3>
                            </div>
                            
                            <!-- Mã hóa đơn và trạng thái -->
                            <div class="flex items-center justify-between mb-3">
                                <p class="text-green-600 font-medium text-sm">${billCode}</p>
                                ${statusBadge}
                            </div>
                            
                            <!-- Chi tiết dịch vụ -->
                            <div class="space-y-2 mb-4 text-sm">
                                ${bill.services?.map(service => {
                                    const serviceName = service.serviceName || service.name;
                                    const translatedName = translateBillServiceName(serviceName);
                                    return `
                                    <div class="flex justify-between items-center py-1">
                                        <span class="text-gray-600">${translatedName}</span>
                                        <span class="font-medium text-gray-800">${formatCurrency(service.amount || 0)}</span>
                                    </div>
                                `;
                                }).join('') || `
                                    <div class="text-center text-gray-500 py-2 text-sm">
                                        ${currentLanguage === 'en' ? 'No service details' : 'Chưa có chi tiết dịch vụ'}
                                    </div>
                                `}
                            </div>
                            
                            <!-- Tổng tiền và QR thanh toán -->
                            <div class="border-t pt-3">
                                <div class="flex justify-between items-center">
                                    <div class="flex-1">
                                    </div>
                                    <span class="font-bold text-xl text-gray-900">${formatCurrency(bill.totalAmount || 0)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Thêm event listeners cho các bill cards
                setTimeout(() => {
                    document.querySelectorAll('.bill-card').forEach(card => {
                        card.addEventListener('click', function() {
                            const billId = this.getAttribute('data-bill-id');
                            if (billId) {
                                showBillDetail(billId);
                            }
                        });
                    });
                }, 100);
            }
        }

        function showBillDetail(billId) {
            console.log('🔍 showBillDetail called with ID:', billId);
            console.log('📋 All bills:', bills);
            
            const bill = bills.find(b => b.id === billId);
            if (!bill) {
                console.error('❌ Bill not found with ID:', billId);
                return;
            }
            
            console.log('✅ Found bill:', bill);
            console.log('📅 billDate:', bill.billDate);
            console.log('📅 dueDate:', bill.dueDate);
            console.log('📅 createdAt:', bill.createdAt);

            const building = buildings.find(b => b.id === bill.buildingId);
            const contract = contracts.find(c => c.representativeId === currentUser.id);
            
            // Format ngày tháng - LẤY ĐÚNG TỪ BILL
            const formatDateVN = (date) => {
                return date.toLocaleDateString('vi-VN', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric' 
                });
            };
            
            // Helper function để parse date an toàn
            const parseDate = (dateValue, fieldName) => {
                console.log(`🔍 Parsing ${fieldName}:`, dateValue, typeof dateValue);
                
                if (!dateValue) return null;
                
                // Nếu là Firebase Timestamp
                if (dateValue.toDate && typeof dateValue.toDate === 'function') {
                    const result = dateValue.toDate();
                    console.log(`✅ ${fieldName} parsed from Timestamp:`, result);
                    return result;
                }
                
                // Nếu là string format DD/MM/YYYY
                if (typeof dateValue === 'string') {
                    const parts = dateValue.split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1; // JS month is 0-indexed
                        const year = parseInt(parts[2]);
                        const result = new Date(year, month, day);
                        console.log(`✅ ${fieldName} parsed from string DD/MM/YYYY:`, result);
                        return result;
                    }
                }
                
                // Fallback: try native Date parse
                try {
                    const result = new Date(dateValue);
                    console.log(`⚠️ ${fieldName} parsed with fallback:`, result);
                    return result;
                } catch (e) {
                    console.error(`❌ Failed to parse ${fieldName}:`, e);
                    return null;
                }
            };
            
            // Lấy ngày tạo từ billDate (ưu tiên) hoặc createdAt
            let createdDate = parseDate(bill.billDate, 'billDate');
            if (!createdDate || createdDate.getFullYear() < 2000) {
                createdDate = parseDate(bill.createdAt, 'createdAt') || new Date();
            }
            
            // Lấy hạn thanh toán từ bill.dueDate (ngày đã nhập)
            let dueDate;
            if (bill.dueDate && bill.period && createdDate) {
                // Tạo dueDate từ bill.dueDate, bill.period và năm từ createdDate
                const year = createdDate.getFullYear();
                const month = parseInt(bill.period) || createdDate.getMonth() + 1;
                const day = parseInt(bill.dueDate) || 1;
                dueDate = new Date(year, month - 1, day);
                console.log(`✅ dueDate from bill.dueDate:`, dueDate);
            } else if (contract && contract.paymentDay) {
                // Fallback: lấy từ contract paymentDay
                const year = createdDate.getFullYear();
                const month = parseInt(bill.period) || createdDate.getMonth() + 1;
                dueDate = new Date(year, month - 1, contract.paymentDay);
                console.log(`✅ dueDate calculated from contract paymentDay:`, dueDate);
            } else {
                // Fallback: +3 ngày từ ngày tạo
                dueDate = new Date(createdDate);
                dueDate.setDate(dueDate.getDate() + 3);
                console.log(`⚠️ dueDate fallback (+3 days):`, dueDate);
            }
            
            console.log('📅 Final createdDate:', createdDate);
            console.log('📅 Final dueDate:', dueDate);

            // Format period (có thể là "11-2025" hoặc "11" hoặc number 11)
            let periodDisplay = '';
            if (bill.period) {
                const periodStr = String(bill.period);
                if (periodStr.includes('-')) {
                    periodDisplay = periodStr; // Đã có format "11-2025"
                } else {
                    periodDisplay = `${periodStr}-2025`; // Chỉ có tháng, thêm năm
                }
            } else {
                periodDisplay = 'N/A';
            }
            
            // Lấy services từ bill (không fallback hardcode)
            const services = bill.services || [];
            
            if (services.length === 0) {
                console.warn('⚠️ Bill has no services data:', bill.id);
            }



            const content = `
                <!-- Header hóa đơn -->
                <div class="text-center mb-4 pb-3 border-b">
                    <h2 class="text-lg font-bold">${currentLanguage === 'en' ? `Monthly Bill ${periodDisplay}` : `Hóa Đơn Tháng ${periodDisplay}`}</h2>
                </div>
                
                <!-- Thông tin cơ bản -->
                <div class="mb-4 text-sm space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">${currentLanguage === 'en' ? 'Room:' : 'Phòng:'}</span>
                        <span class="font-semibold">${bill.room || contract?.room}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">${currentLanguage === 'en' ? 'Bill Number:' : 'Số hóa đơn:'}</span>
                        <span class="font-semibold text-green-600">${bill.code || `INV${bill.id?.slice(-6)?.toUpperCase()}`}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">${currentLanguage === 'en' ? 'Created Date:' : 'Ngày tạo:'}</span>
                        <span class="font-semibold">${formatDateVN(createdDate)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">${currentLanguage === 'en' ? 'Due Date:' : 'Hạn thanh toán:'}</span>
                        <span class="font-semibold">${formatDateVN(dueDate)}</span>
                    </div>
                </div>

                <!-- Chi tiết dịch vụ -->
                <div class="mb-4">
                    <h3 class="font-semibold text-gray-800 mb-3">${currentLanguage === 'en' ? 'Service Details' : 'Chi tiết dịch vụ'}</h3>
                    <div class="space-y-3">
                        ${services.map((service, index) => {
                            const serviceName = service.serviceName || service.name || `Dịch vụ ${index + 1}`;
                            const displayedUnitPrice = service.unitPrice || service.price || 0;
                            const quantity = service.quantity !== undefined ? service.quantity : (service.usage !== undefined ? service.usage : 1);
                            const amount = service.amount !== undefined ? service.amount : (displayedUnitPrice * quantity);
                            
                            // TÍNH ĐƠN GIÁ GỐC từ dữ liệu thực tế
                            let originalUnitPrice = displayedUnitPrice;
                            if (service.type === 'rent' && service.fromDate && service.toDate && amount > 0) {
                                // TIỀN NHÀ: Tính ngược từ amount và số ngày THỰC TẾ
                                const fromDate = new Date(service.fromDate);
                                const toDate = new Date(service.toDate);
                                const dayCount = Math.ceil((toDate - fromDate) / (1000 * 60 * 60 * 24)) + 1;
                                
                                // SỐ NGÀY THỰC TẾ TRONG THÁNG (28/29/30/31)
                                const totalDaysInMonth = new Date(fromDate.getFullYear(), fromDate.getMonth() + 1, 0).getDate();
                                
                                originalUnitPrice = Math.round((amount * totalDaysInMonth) / dayCount);
                            }
                            
                            // Tạo ghi chú chi tiết
                            let detailNote = '';
                            if (service.type === 'rent') {
                                // TIỀN NHÀ: Chỉ hiển thị đơn giá gốc + khoảng thời gian với tỷ lệ
                                detailNote = `${currentLanguage === 'en' ? 'Unit Price:' : 'Đơn giá:'} ${formatCurrency(originalUnitPrice)}`;
                                if (service.fromDate && service.toDate) {
                                    const fromDateShort = service.fromDate.split('-').slice(1).reverse().join('-'); // DD-MM
                                    const toDateShort = service.toDate.split('-').slice(1).reverse().join('-'); // DD-MM
                                    const dayCount = Math.ceil((new Date(service.toDate) - new Date(service.fromDate)) / (1000 * 60 * 60 * 24)) + 1;
                                    
                                    // TÍNH SỐ NGÀY TRONG THÁNG THỰC TẾ (28/29/30/31)  
                                    const fromDate = new Date(service.fromDate);
                                    const totalDaysInMonth = new Date(fromDate.getFullYear(), fromDate.getMonth() + 1, 0).getDate();
                                    
                                    detailNote += `<br>(Từ ${fromDateShort} đến ${toDateShort}) = ${dayCount}/${totalDaysInMonth} ngày`;
                                }
                            } else if (service.type === 'electric' && service.oldReading !== undefined && service.newReading !== undefined) {
                                // TIỀN ĐIỆN: KHÔI PHỤC LOGIC CŨ - Hiển thị đơn giá × số lượng điện + chỉ số
                                const electricUsage = service.newReading - service.oldReading;
                                detailNote = `${currentLanguage === 'en' ? 'Unit Price:' : 'Đơn giá:'} ${formatCurrency(originalUnitPrice)} × ${electricUsage}`;
                                detailNote += `<br>${currentLanguage === 'en' ? 'Reading:' : 'Chỉ số:'} ${service.oldReading} → ${service.newReading}`;
                            } else if (service.type === 'water_meter' && service.oldReading !== undefined && service.newReading !== undefined) {
                                // TIỀN NƯỚC: Hiển thị đơn giá × số lượng nước + chỉ số
                                const waterUsage = service.newReading - service.oldReading;
                                if (waterUsage > 0) {
                                    detailNote = `${currentLanguage === 'en' ? 'Unit Price:' : 'Đơn giá:'} ${formatCurrency(originalUnitPrice)} × ${waterUsage}`;
                                } else {
                                    detailNote = `${currentLanguage === 'en' ? 'Unit Price:' : 'Đơn giá:'} ${formatCurrency(originalUnitPrice)}`;
                                }
                                detailNote += `<br>${currentLanguage === 'en' ? 'Reading:' : 'Chỉ số:'} ${service.oldReading} → ${service.newReading}`;
                            } else if (service.type === 'custom' && service.fromDate && service.toDate) {
                                // DỊCH VỤ TÙY CHỈNH: Kiểm tra có phải tròn tháng không
                                const fromDate = new Date(service.fromDate);
                                const toDate = new Date(service.toDate);
                                const isFullMonth = (fromDate.getDate() === 1) && 
                                    (toDate.getDate() === new Date(toDate.getFullYear(), toDate.getMonth() + 1, 0).getDate());
                                
                                if (quantity > 1) {
                                    detailNote = `${currentLanguage === 'en' ? 'Unit Price:' : 'Đơn giá:'} ${formatCurrency(originalUnitPrice)} × ${quantity}`;
                                } else {
                                    detailNote = `${currentLanguage === 'en' ? 'Unit Price:' : 'Đơn giá:'} ${formatCurrency(originalUnitPrice)}`;
                                }
                                
                                // CHỈ HIỂN THỊ KHOẢNG THỜI GIAN KHI KHÔNG PHẢI TRÒN THÁNG
                                if (!isFullMonth) {
                                    const fromDateShort = service.fromDate.split('-').slice(1).reverse().join('-'); // DD-MM
                                    const toDateShort = service.toDate.split('-').slice(1).reverse().join('-'); // DD-MM
                                    const dayCount = Math.ceil((toDate - fromDate) / (1000 * 60 * 60 * 24)) + 1;
                                    
                                    // TÍNH SỐ NGÀY TRONG THÁNG THỰC TẾ (28/29/30/31)
                                    const totalDaysInMonth = new Date(fromDate.getFullYear(), fromDate.getMonth() + 1, 0).getDate();
                                    
                                    detailNote += `<br>(Từ ${fromDateShort} đến ${toDateShort}) = ${dayCount}/${totalDaysInMonth} ngày`;
                                }
                            } else {
                                // DỊCH VỤ KHÁC: Kiểm tra có fromDate/toDate không và có phải tròn tháng không
                                if (quantity > 1) {
                                    detailNote = `${currentLanguage === 'en' ? 'Unit Price:' : 'Đơn giá:'} ${formatCurrency(originalUnitPrice)} × ${quantity}`;
                                } else {
                                    detailNote = `${currentLanguage === 'en' ? 'Unit Price:' : 'Đơn giá:'} ${formatCurrency(originalUnitPrice)}`;
                                }
                                
                                // HIỂN THỊ KHOẢNG THỜI GIAN NÉU CÓ VÀ KHÔNG PHẢI TRÒN THÁNG
                                if (service.fromDate && service.toDate) {
                                    const fromDate = new Date(service.fromDate);
                                    const toDate = new Date(service.toDate);
                                    const isFullMonth = (fromDate.getDate() === 1) && 
                                        (toDate.getDate() === new Date(toDate.getFullYear(), toDate.getMonth() + 1, 0).getDate());
                                    
                                    if (!isFullMonth) {
                                        const fromDateShort = service.fromDate.split('-').slice(1).reverse().join('-'); // DD-MM
                                        const toDateShort = service.toDate.split('-').slice(1).reverse().join('-'); // DD-MM
                                        const dayCount = Math.ceil((toDate - fromDate) / (1000 * 60 * 60 * 24)) + 1;
                                        
                                        // TÍNH SỐ NGÀY TRONG THÁNG THỰC TẾ (28/29/30/31)
                                        const totalDaysInMonth = new Date(fromDate.getFullYear(), fromDate.getMonth() + 1, 0).getDate();
                                        
                                        detailNote += `<br>(Từ ${fromDateShort} đến ${toDateShort}) = ${dayCount}/${totalDaysInMonth} ngày`;
                                    }
                                }
                            }
                            
                            return `
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="font-medium text-gray-800">${translateBillServiceName(serviceName)}</span>
                                        <span class="font-bold text-gray-900">${formatCurrency(amount)}</span>
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        ${detailNote}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <!-- Tổng kết -->
                <div class="border-t pt-4 mb-4">
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">${currentLanguage === 'en' ? 'Total:' : 'Tổng cộng:'}</span>
                            <span class="font-semibold">${formatCurrency(bill.totalAmount || 0)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">${currentLanguage === 'en' ? 'Paid:' : 'Đã thanh toán:'}</span>
                            <span class="font-semibold">${formatCurrency(bill.paidAmount || 0)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-t">
                            <span class="font-bold text-lg ${(bill.status === 'paid' || (bill.paidAmount || 0) >= (bill.totalAmount || 0)) ? 'text-green-600' : 'text-red-600'}">${currentLanguage === 'en' ? 'Remaining:' : 'Còn lại:'}</span>
                            <span class="font-bold text-xl ${(bill.status === 'paid' || (bill.paidAmount || 0) >= (bill.totalAmount || 0)) ? 'text-green-600' : 'text-red-600'}">${formatCurrency((bill.totalAmount || 0) - (bill.paidAmount || 0))}</span>
                        </div>
                    </div>
                </div>

                <!-- Trạng thái thanh toán -->
                ${(bill.status === 'unpaid' && (bill.paidAmount || 0) < (bill.totalAmount || 0)) ? `
                    <div class="text-center bg-red-50 rounded-lg p-4">
                        <div class="text-red-600 mb-2">
                            <svg class="w-12 h-12 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <p class="font-semibold text-red-600 mb-1">${currentLanguage === 'en' ? 'UNPAID' : 'CHƯA THANH TOÁN'}</p>
                        <p class="text-sm text-gray-600 mb-3">${currentLanguage === 'en' ? 'Please pay on time' : 'Vui lòng thanh toán đúng hạn'}</p>
                        <button onclick="showQRPayment('${bill.id}')" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700">
                            ${currentLanguage === 'en' ? 'Pay Now' : 'Thanh toán'}
                        </button>
                    </div>
                ` : `
                    <div class="text-center bg-green-50 rounded-lg p-4">
                        <div class="text-green-600 mb-2">
                            <svg class="w-12 h-12 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <p class="font-semibold text-green-600">${currentLanguage === 'en' ? 'PAID' : 'ĐÃ THANH TOÁN'}</p>
                        <p class="text-sm text-gray-600 mt-1">${currentLanguage === 'en' ? 'Thank you for your timely payment' : 'Cảm ơn bạn đã thanh toán đúng hạn'}</p>
                    </div>
                `}
            `;

            document.getElementById('bill-detail-content').innerHTML = content;
            
            // Hide other screens and show bill detail
            document.getElementById('bills-screen').classList.add('hidden');
            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('bill-detail-screen').classList.remove('hidden');
            
            // Scroll to top of bill detail screen
            const billDetailScreen = document.getElementById('bill-detail-screen');
            if (billDetailScreen) {
                billDetailScreen.scrollTop = 0;
            }

            // Generate VietQR code if unpaid
            if (bill.status === 'unpaid') {
                setTimeout(() => {
                    const YOUR_BANK_ID = "970416"; // ACB Bank
                    const YOUR_ACCOUNT_NO = "113366668888"; 
                    const qrContent = `THANHTOAN PHONG${bill.room} T${bill.period}${new Date().getFullYear()}`;
                    const qrUrl = `https://img.vietqr.io/image/${YOUR_BANK_ID}-${YOUR_ACCOUNT_NO}-qr_only.jpg?amount=${bill.totalAmount}&addInfo=${encodeURIComponent(qrContent)}`;
                    
                    const qrImg = document.createElement('img');
                    qrImg.src = qrUrl;
                    qrImg.className = 'w-24 h-24 border rounded-lg';
                    qrImg.alt = 'QR Code thanh toán';
                    
                    const qrContainer = document.getElementById('qr-code-container');
                    if (qrContainer) {
                        qrContainer.innerHTML = '';
                        qrContainer.appendChild(qrImg);
                    }
                }, 100);
            }
        }

        function closeBillDetail() {
            document.getElementById('bill-detail-screen').classList.add('hidden');
            document.getElementById('bills-screen').classList.remove('hidden');
        }

        // QR Payment Functions
        let currentPaymentData = null;
        
        async function showQRPayment(billId) {
            const bill = bills.find(b => b.id === billId);
            if (!bill) {
                alert('Không tìm thấy hóa đơn');
                return;
            }
            
            const building = buildings.find(b => b.id === bill.buildingId);
            if (!building || !building.accountId) {
                alert('Chưa có thông tin tài khoản ngân hàng');
                return;
            }
            
            // Lấy thông tin tài khoản từ building
            console.log('🔍 Loading account info for building:', building.id);
            
            try {
                const accountsQuery = query(collection(db, 'accounts'), where('__name__', '==', building.accountId));
                const accountsSnapshot = await getDocs(accountsQuery);
                
                if (accountsSnapshot.empty) {
                    alert('Không tìm thấy thông tin tài khoản');
                    return;
                }
                
                const account = { id: accountsSnapshot.docs[0].id, ...accountsSnapshot.docs[0].data() };
                console.log('✅ Account found:', account);
                
                if (account.bank === 'Cash') {
                    alert('Vui lòng thanh toán bằng tiền mặt');
                    return;
                }
                
                // Bank ID mapping
                const BANK_ID_MAP = {
                    'VietcomBank': '970436',
                    'BIDV': '970418', 
                    'VietinBank': '970415',
                    'Agribank': '970405',
                    'ACB': '970416',
                    'Techcombank': '970407',
                    'MBBank': '970422',
                    'TPBank': '970423',
                    'Sacombank': '970403',
                    'HDBank': '970437',
                    'VPBank': '970432',
                    'SHB': '970443',
                    'Eximbank': '970431',
                    'MSB': '970426',
                    'OCB': '970448',
                    'Nam A Bank': '970428'
                };
                
                const bankId = BANK_ID_MAP[account.bank] || '970416';
                const accountNumber = account.accountNumber;
                const accountName = account.accountHolder || 'KHACH HANG';
                const amount = bill.totalAmount - (bill.paidAmount || 0);
                
                // Sử dụng QR content giống web index thay vì tự tạo
                const customer = currentUser;
                let qrContent = 'CHUYEN KHOAN';
                if (customer && customer.name) {
                    // Chuyển tên thành chữ hoa, bỏ dấu để phù hợp với format ngân hàng
                    const customerName = customer.name
                        .toUpperCase()
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '') // Bỏ dấu tiếng Việt
                        .replace(/Đ/g, 'D')
                        .replace(/đ/g, 'd');
                    qrContent = `${customerName} CHUYEN KHOAN`;
                }
                
                // Tạo QR URL với nội dung giống web index
                const qrUrl = `https://img.vietqr.io/image/${bankId}-${accountNumber}-qr_only.jpg?amount=${amount}&addInfo=${encodeURIComponent(qrContent)}&accountName=${encodeURIComponent(accountName)}`;
                
                // Lưu data để dùng cho copy và download
                currentPaymentData = {
                    qrUrl: qrUrl,
                    accountName: accountName,
                    accountNumber: accountNumber,
                    amount: amount,
                    description: qrContent, // Sử dụng qrContent thay vì description cũ
                    billId: bill.id
                };
                
                // Hiển thị màn hình QR payment
                document.getElementById('payment-qr-image').src = qrUrl;
                document.getElementById('payment-account-name').textContent = accountName;
                document.getElementById('payment-account-number').textContent = accountNumber;
                document.getElementById('payment-amount').textContent = formatCurrency(amount);
                
                // Hide bill detail, show QR payment
                document.getElementById('bill-detail-screen').classList.add('hidden');
                const qrScreen = document.getElementById('qr-payment-screen');
                qrScreen.classList.remove('hidden');
                
                // Scroll to top
                setTimeout(() => {
                    qrScreen.scrollTop = 0;
                }, 0);
                
            } catch (error) {
                console.error('Error loading account:', error);
                alert('Lỗi tải thông tin tài khoản');
            }
        }
        
        function closeQRPayment() {
            document.getElementById('qr-payment-screen').classList.add('hidden');
            document.getElementById('bill-detail-screen').classList.remove('hidden');
        }
        
        function copyAccountNumber() {
            if (!currentPaymentData) return;
            navigator.clipboard.writeText(currentPaymentData.accountNumber).then(() => {
                showToast('Đã sao chép số tài khoản', 'success');
            });
        }
        
        function copyAmount() {
            if (!currentPaymentData) return;
            // Copy số tiền không có VNĐ, chỉ số
            const amountNumber = currentPaymentData.amount.toString().replace(/\./g, '');
            navigator.clipboard.writeText(amountNumber).then(() => {
                showToast('Đã sao chép số tiền', 'success');
            });
        }
        
        async function downloadQR() {
            if (!currentPaymentData) return;
            
            try {
                showToast('Đang tải ảnh QR...', 'info');
                
                // Lấy ảnh QR từ element hiện tại
                const qrImg = document.getElementById('payment-qr-image');
                if (!qrImg || !qrImg.src) {
                    showToast('Không tìm thấy mã QR để tải', 'error');
                    return;
                }
                
                // Tạo canvas để vẽ ảnh QR
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Tạo image element mới để load ảnh
                const img = new Image();
                img.crossOrigin = 'anonymous'; // Để tránh CORS issue
                
                img.onload = function() {
                    // Đặt kích thước canvas bằng kích thước ảnh
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // Vẽ ảnh lên canvas
                    ctx.drawImage(img, 0, 0);
                    
                    // Chuyển canvas thành blob
                    canvas.toBlob(function(blob) {
                        if (blob) {
                            // Tạo URL từ blob
                            const url = URL.createObjectURL(blob);
                            
                            // Tạo link download
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = `QR_Thanh_Toan_Phong_${currentPaymentData.room || 'Unknown'}_${new Date().getTime()}.jpg`;
                            
                            // Trigger download
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            // Dọn dẹp
                            URL.revokeObjectURL(url);
                            
                            showToast('✅ Đã lưu mã QR vào thư viện!', 'success');
                        } else {
                            showToast('Lỗi khi tạo file ảnh', 'error');
                        }
                    }, 'image/jpeg', 0.9);
                };
                
                img.onerror = function() {
                    console.log('Canvas method failed, trying fetch method...');
                    // Fallback: Dùng fetch để tải ảnh
                    downloadQRWithFetch();
                };
                
                // Load ảnh từ URL
                img.src = currentPaymentData.qrUrl;
                
            } catch (error) {
                console.error('Lỗi download QR:', error);
                showToast('Lỗi khi tải mã QR', 'error');
            }
        }

        // Phương pháp fallback dùng fetch
        async function downloadQRWithFetch() {
            try {
                const response = await fetch(currentPaymentData.qrUrl, {
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const blob = await response.blob();
                
                // Tạo URL từ blob
                const url = URL.createObjectURL(blob);
                
                // Tạo link download
                const link = document.createElement('a');
                link.href = url;
                link.download = `QR_Thanh_Toan_Phong_${currentPaymentData.room || 'Unknown'}_${new Date().getTime()}.jpg`;
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Dọn dẹp
                URL.revokeObjectURL(url);
                
                showToast('✅ Đã lưu mã QR vào thư viện!', 'success');
                
            } catch (error) {
                console.error('Fetch method also failed:', error);
                // Cuối cùng dùng phương pháp cũ nếu tất cả đều fail
                downloadQRFallback();
            }
        }

        // Phương pháp cuối cùng (giống như trước)
        function downloadQRFallback() {
            const link = document.createElement('a');
            link.href = currentPaymentData.qrUrl;
            link.download = `QR_Thanh_Toan_Phong_${currentPaymentData.room || 'Unknown'}_${new Date().getTime()}.jpg`;
            link.target = '_blank'; // Mở trong tab mới
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Mã QR đã được mở. Nhấn giữ ảnh để lưu vào thư viện.', 'info');
        }

        async function refreshData() {
            if (currentUser) {
                // 🔥 FORCE REFRESH: XÓA CACHE VÀ LOAD DỮ LIỆU MỚI
                console.log('🔄 Force refresh - clearing all cache');
                
                // Clear cache
                localStorage.removeItem(`n_home_user_${currentUser.id}`);
                localStorage.removeItem(`userData_${currentUser.id}`);
                
                // Clear app state
                bills = [];
                notifications = [];
                buildings = [];
                contracts = [];
                services = [];
                
                // Reload fresh data from Firebase
                await loadUserData(currentUser.id);
                renderHomeData();
                renderBillsList();
                renderNotificationsList();
                
                alert('✅ Đã làm mới dữ liệu từ server!');
            }
        }

        function showScreen(screenName) {
            // Hide all screens
            const homeScreen = document.getElementById('home-screen');
            const billsScreen = document.getElementById('bills-screen');
            const notificationsScreen = document.getElementById('notifications-screen');
            const createIssueScreen = document.getElementById('create-issue-screen');
            const issueFormScreen = document.getElementById('issue-form-screen');
            const profileScreen = document.getElementById('profile-screen');
            const billDetailScreen = document.getElementById('bill-detail-screen');
            const qrPaymentScreen = document.getElementById('qr-payment-screen');
            
            if (homeScreen) homeScreen.classList.add('hidden');
            if (billsScreen) billsScreen.classList.add('hidden');
            if (notificationsScreen) notificationsScreen.classList.add('hidden');
            if (createIssueScreen) createIssueScreen.classList.add('hidden');
            if (issueFormScreen) issueFormScreen.classList.add('hidden');
            if (profileScreen) profileScreen.classList.add('hidden');
            if (billDetailScreen) billDetailScreen.classList.add('hidden');
            if (qrPaymentScreen) qrPaymentScreen.classList.add('hidden');
            
            // Show selected screen
            if (screenName === 'home' && homeScreen) {
                homeScreen.classList.remove('hidden');
                renderHomeData();
            } else if (screenName === 'bills' && billsScreen) {
                billsScreen.classList.remove('hidden');
                renderBillsList();
            } else if (screenName === 'notifications' && notificationsScreen) {
                notificationsScreen.classList.remove('hidden');
                renderNotificationsList();
            } else if (screenName === 'create-issue' && createIssueScreen) {
                createIssueScreen.classList.remove('hidden');
            } else if (screenName === 'profile' && profileScreen) {
                console.log('🔧 Showing profile screen');
                profileScreen.classList.remove('hidden');
                loadProfileData();
            }
        }

        // YÊU CẦU 3: CHỨC NĂNG TẠO SỰ CỐ
        window.showCreateIssueScreen = async function() {
            console.log('🔔 showCreateIssueScreen called');
            showScreen('create-issue');
            
            // Update navigation (remove active from all, don't add to any since this is a separate screen)
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            console.log('📞 About to load customer issues...');
            // Load and display issues
            await loadCustomerIssues();
            console.log('✅ Issues loaded and displayed');
        };

        window.closeIssueScreen = function() {
            // Cleanup realtime listener when leaving issues screen
            if (issuesUnsubscribe) {
                issuesUnsubscribe();
                issuesUnsubscribe = null;
                console.log('🔌 Unsubscribed from issues listener');
            }
            
            showScreen('home');
            
            // Update navigation to home
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector('.nav-item').classList.add('active'); // First item is home
        };

        // Listener for realtime issues updates
        let issuesUnsubscribe = null;

        // Load customer's reported issues with realtime sync
        async function loadCustomerIssues() {
            if (!currentUser) {
                console.log('❌ No current user, cannot load issues');
                return;
            }
            
            try {
                console.log('📋 Setting up realtime listener for customer:', currentUser.id);
                
                // Unsubscribe from previous listener if exists
                if (issuesUnsubscribe) {
                    issuesUnsubscribe();
                    console.log('🔌 Unsubscribed from previous listener');
                }
                
                // Query tasks created by this customer (without orderBy to avoid index requirement)
                const tasksQuery = query(
                    collection(db, 'tasks'),
                    where('customerId', '==', currentUser.id)
                );
                
                // Setup realtime listener - auto updates when data changes
                issuesUnsubscribe = onSnapshot(tasksQuery, (snapshot) => {
                    console.log('🔄 Realtime update received');
                    
                    const issues = [];
                    snapshot.forEach((doc) => {
                        issues.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Sort by createdAt in JavaScript
                    issues.sort((a, b) => {
                        const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
                        const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
                        return dateB - dateA; // Descending order (newest first)
                    });
                    
                    console.log('✅ Loaded issues count:', issues.length);
                    
                    // Show empty state or issues list
                    const emptyState = document.getElementById('empty-issues-state');
                    const listContainer = document.getElementById('issues-list-container');
                    
                    if (!emptyState || !listContainer) {
                        console.error('❌ Cannot find empty state or list container elements');
                        return;
                    }
                    
                    if (issues.length === 0) {
                        console.log('📭 No issues found, showing empty state');
                        emptyState.classList.remove('hidden');
                        listContainer.classList.add('hidden');
                    } else {
                        console.log('📋 Issues found, showing list');
                        emptyState.classList.add('hidden');
                        listContainer.classList.remove('hidden');
                        renderIssuesList(issues);
                    }
                }, (error) => {
                    console.error('❌ Error in realtime listener:', error);
                    showToast('Lỗi đồng bộ dữ liệu', 'error');
                });
                
            } catch (error) {
                console.error('❌ Error setting up realtime listener:', error);
                showToast('Lỗi tải danh sách sự cố', 'error');
            }
        }

        // Render issues list
        function renderIssuesList(issues) {
            // console.log('🎨 Rendering issues list:', issues.length, 'items');
            const listContainer = document.getElementById('issues-list');
            if (!listContainer) {
                console.error('❌ Cannot find issues-list element');
                return;
            }
            
            listContainer.innerHTML = issues.map((issue, idx) => {
                // console.log(`Rendering issue ${idx}:`, issue);
                
                const statusConfig = {
                    'pending': { label: t('statusPending'), bg: 'bg-yellow-100', text: 'text-yellow-800' },
                    'in-progress': { label: t('statusInProgress'), bg: 'bg-blue-100', text: 'text-blue-800' },
                    'completed': { label: t('statusCompleted'), bg: 'bg-green-100', text: 'text-green-800' },
                    'cancelled': { label: t('statusCancelled'), bg: 'bg-gray-100', text: 'text-gray-800' }
                };
                
                const status = statusConfig[issue.status] || statusConfig['pending'];
                let formattedDate = 'N/A';
                try {
                    const date = issue.createdAt?.toDate ? issue.createdAt.toDate() : new Date(issue.createdAt);
                    formattedDate = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                } catch (e) {
                    console.warn('Error formatting date for issue:', issue.id, e);
                }
                
                return `
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" onclick="viewIssueDetail('${issue.id}')">
                        <div class="flex items-start justify-between mb-2">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${status.bg} ${status.text}">
                                ${status.label}
                            </span>
                            <span class="text-xs text-gray-500">${formattedDate}</span>
                        </div>
                        <h3 class="font-semibold text-gray-900 mb-1">${issue.title || 'Sự cố'}</h3>
                        <p class="text-sm text-gray-600 line-clamp-2">${issue.description || ''}</p>
                    </div>
                `;
            }).join('');
            
            // console.log('✅ Rendered HTML to issues-list container');
        }

        // View issue detail (placeholder for future implementation)
        window.viewIssueDetail = function(issueId) {
            console.log('View issue detail:', issueId);
            showToast('Chức năng xem chi tiết đang được phát triển', 'info');
        };

        window.backToHome = function() {
            showScreen('home');
            
            // Update navigation to home
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector('.nav-item').classList.add('active'); // First item is home
        };

        window.showIssueForm = function() {
            // Hide create-issue screen, show form screen
            document.getElementById('create-issue-screen').classList.add('hidden');
            document.getElementById('issue-form-screen').classList.remove('hidden');
            
            // Reset form
            const descField = document.getElementById('issue-description');
            if (descField) descField.value = '';
            selectedImages = [];
            updateImagePreview();
            updateImageCounter();
        };

        window.backToIssueScreen = function() {
            // Hide form screen, show create-issue screen
            document.getElementById('issue-form-screen').classList.add('hidden');
            document.getElementById('create-issue-screen').classList.remove('hidden');
        };

        // Handle image upload
        let selectedImages = [];
        
        window.handleImageUpload = function(input) {
            const files = Array.from(input.files);
            const maxImages = 5;
            
            // Kiểm tra số lượng ảnh
            if (selectedImages.length + files.length > maxImages) {
                alert(`Chỉ được chọn tối đa ${maxImages} ảnh`);
                return;
            }
            
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    selectedImages.push(file);
                }
            });
            
            updateImagePreview();
            updateImageCounter();
        };
        
        function updateImagePreview() {
            const preview = document.getElementById('image-preview');
            if (!preview) return;
            
            preview.innerHTML = '';
            
            selectedImages.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'relative';
                    imageDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Preview" class="w-full h-20 object-cover rounded-lg border">
                        <button type="button" onclick="removeImage(${index})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
                            ×
                        </button>
                    `;
                    preview.appendChild(imageDiv);
                };
                reader.readAsDataURL(file);
            });
        }
        
        window.removeImage = function(index) {
            selectedImages.splice(index, 1);
            updateImagePreview();
            updateImageCounter();
        };
        
        function updateImageCounter() {
            const counter = document.querySelector('label[for="issue-images"]');
            if (counter) {
                counter.textContent = `Hình ảnh (${selectedImages.length}/5)`;
            }
        }

        window.submitIssue = async function() {
            const description = document.getElementById('issue-description').value.trim();
            
            if (!description) {
                alert('Vui lòng nhập mô tả sự cố');
                return;
            }

            try {
                const contract = contracts[0];
                const building = buildings.find(b => b.id === contract?.buildingId);
                
                // Lấy tên người đại diện - ưu tiên từ currentUser vì contract chỉ có ID
                const representativeName = currentUser?.name || 'Khách hàng';
                const representativePhone = currentUser?.phone || '';
                
                console.log('👤 Representative info:', {
                    name: representativeName,
                    phone: representativePhone,
                    contractId: contract?.id,
                    representativeId: contract?.representativeId
                });
                
                // UPLOAD ẢNH LÊN FIREBASE STORAGE
                const imageUrls = [];
                if (selectedImages.length > 0) {
                    console.log('📤 Starting upload for', selectedImages.length, 'images...');
                    showToast(`Đang upload ${selectedImages.length} ảnh...`, 'info');
                    
                    let uploadedCount = 0;
                    let failedCount = 0;
                    
                    for (let i = 0; i < selectedImages.length; i++) {
                        const file = selectedImages[i];
                        const timestamp = Date.now();
                        const fileName = `issues/${currentUser.id}/${timestamp}_${i}_${file.name}`;
                        const storageRef = ref(storage, fileName);
                        
                        try {
                            console.log(`⏳ Uploading image ${i + 1}/${selectedImages.length}: ${file.name}`);
                            await uploadBytes(storageRef, file);
                            const url = await getDownloadURL(storageRef);
                            imageUrls.push(url);
                            uploadedCount++;
                            console.log(`✅ Uploaded ${i + 1}/${selectedImages.length}: ${url}`);
                            showToast(`Đã upload ${uploadedCount}/${selectedImages.length} ảnh`, 'success');
                        } catch (uploadError) {
                            failedCount++;
                            console.error(`❌ Failed to upload image ${i + 1}:`, uploadError);
                            showToast(`Lỗi upload ảnh ${i + 1}: ${uploadError.message}`, 'error');
                        }
                    }
                    
                    console.log(`✅ Upload completed: ${uploadedCount} success, ${failedCount} failed`);
                    console.log('📸 Image URLs:', imageUrls);
                    
                    if (failedCount > 0) {
                        showToast(`Upload hoàn tất: ${uploadedCount} thành công, ${failedCount} thất bại`, 'warning');
                    } else {
                        showToast(`Upload thành công ${uploadedCount} ảnh!`, 'success');
                    }
                }
                
                // YÊU CẦU 3: TẠO SỰ CỐ TRONG FIREBASE (sẽ được web admin nhận và xử lý)
                const taskData = {
                    title: description.substring(0, 50) + (description.length > 50 ? '...' : ''), // Tự động tạo title từ mô tả
                    description: description,
                    customerId: currentUser.id,
                    buildingId: contract?.buildingId || '',
                    room: contract?.room || '',
                    priority: 'medium', // Mặc định là trung bình
                    status: 'pending', // Trạng thái chờ xử lý
                    type: 'issue', // Loại sự cố từ khách
                    contact: representativePhone,
                    images: imageUrls.length, // Số lượng ảnh
                    imageUrls: imageUrls, // Array URLs của ảnh đã upload
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                console.log('🔧 Creating issue:', taskData);
                
                // 1. Lưu task vào Firebase collection 'tasks' (để web admin quản lý)
                const taskRef = await addDoc(collection(db, 'tasks'), taskData);
                console.log('✅ Task created with ID:', taskRef.id);
                
                // 2. Tạo notification cho web admin (hiển thị trong mục Thông báo)
                const notificationData = {
                    title: `${t('issueFromRoom')} ${contract?.room || 'N/A'}`,
                    message: description, // Hiện toàn bộ nội dung mô tả chi tiết của khách báo
                    type: 'customer_issue',
                    priority: 'medium',
                    buildingId: contract?.buildingId || '',
                    room: contract?.room || '',
                    customerId: currentUser.id,
                    customerName: representativeName,
                    taskId: taskRef.id, // Link đến task vừa tạo
                    isRead: false,
                    createdAt: new Date(),
                    // Metadata để web có thể filter theo building/room
                    metadata: {
                        customerPhone: representativePhone,
                        buildingCode: building?.code || 'N/A',
                        issueDescription: description, // Lưu toàn bộ mô tả không cắt bớt
                        imageCount: imageUrls.length
                    }
                };
                
                console.log('📢 Creating notification for web admin:', notificationData);
                
                // Lưu notification vào Firebase collection 'adminNotifications' (để web admin đọc được)
                const notificationRef = await addDoc(collection(db, 'adminNotifications'), notificationData);
                console.log('✅ Notification created with ID:', notificationRef.id);
                
                // Reset form
                const descField = document.getElementById('issue-description');
                if (descField) descField.value = '';
                selectedImages = [];
                updateImagePreview();
                updateImageCounter();
                
                // Hiện thông báo thành công
                showToast('Đã gửi sự cố thành công! Chúng tôi sẽ xử lý trong thời gian sớm nhất.', 'success');
                
                // Quay về màn hình danh sách sự cố
                setTimeout(async () => {
                    document.getElementById('issue-form-screen').classList.add('hidden');
                    document.getElementById('create-issue-screen').classList.remove('hidden');
                    await loadCustomerIssues(); // Reload issues list
                }, 1000);
                
                return { 
                    task: { id: taskRef.id, ...taskData },
                    notification: { id: notificationRef.id, ...notificationData }
                };
                
            } catch (error) {
                console.error('Error creating issue:', error);
                showToast('Lỗi gửi sự cố. Vui lòng thử lại.', 'error');
                throw error;
            }
        };

        // Global functions
        window.handleLogin = async function() {
            const phone = document.getElementById('phone-input').value.trim();
            
            if (!phone) {
                alert('Vui lòng nhập số điện thoại');
                return;
            }

            if (!/^0[0-9]{9}$/.test(phone)) {
                alert('Số điện thoại phải có 10 chữ số và bắt đầu bằng 0');
                return;
            }

            const loginBtn = document.getElementById('login-btn');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Đang đăng nhập...';

            try {
                const customer = await loadCustomerData(phone);
                if (!customer) {
                    alert('Số điện thoại không tồn tại trong hệ thống');
                    return;
                }

                localStorage.setItem('userPhone', phone);
                // requestNotificationPermission(); // TẮT POPUP THÔNG BÁO
                await showHome(customer);
                updateAppInteractionState(); // Enable interaction sau khi login
            } catch (error) {
                console.error('Login error:', error);
                alert('Đăng nhập thất bại. Vui lòng thử lại.');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Đăng Nhập';
            }
        };

        window.logout = function() {
            localStorage.removeItem('userPhone');
            currentUser = null;
            bills = [];
            updateAppInteractionState(); // Disable interaction khi logout
            showLogin();
            location.reload();
        };

        window.showBillDetail = showBillDetail;
        window.closeBillDetail = closeBillDetail;
        window.refreshData = refreshData;
        
        // Export QR Payment functions
        window.showQRPayment = showQRPayment;
        window.closeQRPayment = closeQRPayment;
        window.copyAccountNumber = copyAccountNumber;
        window.copyAmount = copyAmount;
        window.downloadQR = downloadQR;
        
        // Go to Bills Page
        window.goToBillsPage = function() {
            // Switch to bills tab
            showScreen('bills');
            
            // Update active state in bottom nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            // Find and activate the bills nav item (3rd item - index 2)
            const navItems = document.querySelectorAll('.nav-item');
            if (navItems[2]) {
                navItems[2].classList.add('active');
            }
        };
        
        // Bottom Navigation
        window.switchTab = function(tab) {
            // Kiểm tra đăng nhập - chỉ cho phép tab home nếu chưa đăng nhập
            if (!currentUser && tab !== 'home') {
                console.log('❌ Chưa đăng nhập, chặn chuyển tab:', tab);
                // Giữ active state cho home tab
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector('.nav-item[onclick="switchTab(\'home\')"]')?.classList.add('active');
                return;
            }
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked item if event exists
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
            
            // Handle tab switching
            switch(tab) {
                case 'home':
                    // Cleanup issues listener when leaving
                    if (issuesUnsubscribe) {
                        issuesUnsubscribe();
                        issuesUnsubscribe = null;
                    }
                    showScreen('home');
                    // Set home tab as active
                    document.querySelector('.nav-item[onclick="switchTab(\'home\')"]')?.classList.add('active');
                    break;
                case 'notifications':
                    // Cleanup issues listener when leaving
                    if (issuesUnsubscribe) {
                        issuesUnsubscribe();
                        issuesUnsubscribe = null;
                    }
                    showNotificationsScreen();
                    // Set notifications tab as active
                    document.querySelector('.nav-item[onclick="switchTab(\'notifications\')"]')?.classList.add('active');
                    break;
                case 'bills':
                    // Cleanup issues listener when leaving
                    if (issuesUnsubscribe) {
                        issuesUnsubscribe();
                        issuesUnsubscribe = null;
                    }
                    showScreen('bills');
                    renderBillsList(); // Refresh bills data
                    // Set bills tab as active
                    document.querySelector('.nav-item[onclick="switchTab(\'bills\')"]')?.classList.add('active');
                    break;
                case 'feedback':
                    showCreateIssueScreen();
                    // Set feedback tab as active
                    document.querySelector('.nav-item[onclick="switchTab(\'feedback\')"]')?.classList.add('active');
                    break;
                case 'profile':
                    // Cleanup issues listener when leaving
                    if (issuesUnsubscribe) {
                        issuesUnsubscribe();
                        issuesUnsubscribe = null;
                    }
                    showProfileScreen();
                    break;
            }
        };

        // Function to control app interaction based on login status
        function updateAppInteractionState() {
            const homeScreen = document.getElementById('home-screen');
            const bottomNav = document.querySelector('.bottom-nav');
            const body = document.body;
            
            if (!currentUser) {
                // Chưa đăng nhập - disable scroll và interaction
                console.log('🔒 Chưa đăng nhập - disable interaction');
                body.classList.add('no-scroll');
                homeScreen?.classList.add('disabled-interaction');
                
                // Disable tất cả nav items except home
                document.querySelectorAll('.nav-item').forEach((item, index) => {
                    if (index !== 0) { // home is first item (index 0)
                        item.style.opacity = '0.5';
                        item.style.pointerEvents = 'none';
                    }
                });
            } else {
                // Đã đăng nhập - enable lại tất cả
                console.log('🔓 Đã đăng nhập - enable interaction');
                body.classList.remove('no-scroll');
                homeScreen?.classList.remove('disabled-interaction');
                
                // Enable tất cả nav items
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.style.opacity = '1';
                    item.style.pointerEvents = 'auto';
                });
            }
        }

        // Setup event listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('phone-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            
            // Event delegation for notification clicks
            document.addEventListener('click', (e) => {
                console.log('🖱️ Document click detected:', e.target);
                
                const notificationItem = e.target.closest('.notification-item');
                if (notificationItem) {
                    console.log('🎯 Found notification item:', notificationItem);
                    
                    const notificationId = notificationItem.getAttribute('data-notification-id');
                    const isUnread = notificationItem.getAttribute('data-is-unread') === 'true';
                    
                    console.log('� Notification data:', { notificationId, isUnread });
                    
                    if (notificationId && isUnread) {
                        console.log('✅ Calling markNotificationAsRead...');
                        markNotificationAsRead(notificationId, isUnread);
                    } else {
                        console.log('⏭️ Skipping: already read or no ID');
                    }
                } else {
                    console.log('❌ Not a notification item');
                }
            });
        });

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' VNĐ';
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else if (typeof timestamp === 'string') {
                date = new Date(timestamp);
            } else {
                date = new Date(timestamp);
            }
            return date.toLocaleDateString('vi-VN');
        }

        // Hàm hiển thị toast notification
        function showToast(message, type = 'success') {
            // Tạo toast element
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : (type === 'info' ? 'bg-blue-500' : 'bg-green-600');
            toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium transform transition-all duration-300 translate-x-full ${bgColor}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // --- NOTIFICATION SYSTEM ---
        let notifications = [];
        let shownPopupNotifications = new Set(); // Cache để tránh duplicate popup

        function requestNotificationPermission() {
            console.log('🔇 Notification permissions disabled by user request');
            return; // TẮT TẤT CẢ POPUP THÔNG BÁO
        }

        let lastNotificationTime = 0;
        const NOTIFICATION_COOLDOWN = 10000; // 10 giây cooldown
        
        function showNotification(title, body) {
            console.log('🔔 Attempting to show notification:', title);
            console.log('🔔 Notification permission:', Notification.permission);
            
            // Debounce - tránh spam notifications
            const now = Date.now();
            if (now - lastNotificationTime < NOTIFICATION_COOLDOWN) {
                console.log('⏱️ Notification cooldown active, skipping...');
                return;
            }
            lastNotificationTime = now;
            
            if (!('Notification' in window)) {
                console.log('❌ Browser không hỗ trợ notifications');
                return;
            }
            
            // Tự động yêu cầu quyền nếu chưa có - TẮT
            if (Notification.permission === 'default') {
                console.log('🔇 Auto notification request disabled');
                return; // KHÔNG TỰ ĐỘNG XIN QUYỀN
            }
            
            if (Notification.permission === 'granted') {
                displayPushNotification(title, body);
            } else if (Notification.permission === 'denied') {
                console.log('⚠️ Quyền thông báo bị từ chối - hiện alert thay thế');
                // Fallback: hiện alert nếu bị từ chối quyền
                setTimeout(() => {
                    alert(`📢 ${title}\n${body}`);
                }, 100);
            }
        }
        
        function displayPushNotification(title, body) {
            try {
                console.log('✅ Hiển thị push notification:', title);
                
                // Tạo unique tag để tránh ghi đè notifications
                const uniqueTag = `n-home-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
                
                const notification = new Notification(title, {
                    body: body,
                    icon: '/icon-nen-xanh.jpg',
                    tag: uniqueTag,
                    badge: '/icon-nen-xanh.jpg',
                    requireInteraction: false, // Không yêu cầu tương tác (tránh lỗi)
                    renotify: true, // Luôn hiển thị notification mới
                    vibrate: [200, 100, 200], // Rung nhẹ hơn
                    // Không dùng actions vì chỉ support trong Service Worker
                    data: {
                        timestamp: Date.now(),
                        url: window.location.href
                    }
                });
                
                // Tự động đóng sau 10 giây (dài hơn để người dùng thấy)
                setTimeout(() => {
                    if (notification) {
                        notification.close();
                    }
                }, 10000);
                
                // Click để mở app
                notification.onclick = function(event) {
                    event.preventDefault();
                    window.focus();
                    notification.close();
                };
                
                console.log('✅ Push notification hiển thị thành công');
            } catch (error) {
                console.error('❌ Lỗi tạo push notification:', error);
            }
        }        // 4 loại thông báo chính THEO YÊU CẦU
        // Debounce để tránh spam notification
        let notificationDebounce = {};
        
        window.createNotification = function(type, title, message, data = {}) {
            // Tạo debounce key để tránh duplicate
            const debounceKey = `${type}_${data.billId || data.taskId || Date.now()}`;
            
            // Nếu notification này vừa được tạo trong 2 giây qua, bỏ qua
            if (notificationDebounce[debounceKey] && Date.now() - notificationDebounce[debounceKey] < 2000) {
                return;
            }
            notificationDebounce[debounceKey] = Date.now();
            
            // Tạo unique ID dựa trên Firebase ID nếu có, nếu không thì dùng timestamp
            const uniqueId = data.firebaseId || `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            const notification = {
                id: uniqueId,
                type: type, // 'bill_approved', 'payment_received', 'issue_created', 'issue_resolved'
                title: title,
                message: message,
                data: data,
                isRead: false, // Mọi thông báo mới đều chưa đọc
                createdAt: new Date().toISOString()
            };
            
            // Kiểm tra xem thông báo đã tồn tại chưa (theo ID)
            const existingIndex = notifications.findIndex(n => n.id === uniqueId);
            if (existingIndex !== -1) {
                // console.log('⚠️ Notification already exists, keeping read status...');
                // Giữ nguyên trạng thái isRead nếu notification đã tồn tại
                notification.isRead = notifications[existingIndex].isRead;
                notifications[existingIndex] = notification;
            } else {
                // console.log('✅ Adding new notification');
                notifications.unshift(notification);
            }
            
            saveNotificationsToStorage();
            
            // ✅ CẬP NHẬT UI NGAY LẬP TỨC với force refresh
            const listEl = document.getElementById('notifications-list');
            if (listEl) {
                listEl.innerHTML = '<div class="text-center py-4">Đang cập nhật...</div>';
            }
            setTimeout(() => {
                renderNotificationsList();
            }, 10);
            
            // console.log('🔔 Creating notification popup for:', title);
            // console.log('🔔 Total notifications after add:', notifications.length);
            
            // Chỉ hiện popup nếu chưa từng hiện cho notification này
            const popupKey = uniqueId + '_' + title + '_' + message.substring(0, 50);
            if (!shownPopupNotifications.has(popupKey)) {
                // console.log('🔔 Showing popup for new notification:', uniqueId);
                shownPopupNotifications.add(popupKey);
                showNotification(title, message);
                
                // Tự động xóa khỏi cache sau 5 phút để tránh memory leak
                setTimeout(() => {
                    shownPopupNotifications.delete(popupKey);
                }, 5 * 60 * 1000);
            } else {
                console.log('⏭️ Skipping duplicate popup for:', uniqueId);
            }
            
            return notification;
        };

        // Hàm tạo sự cố/công việc (sẽ được gọi từ UI của khách hàng)
        window.createIssue = async function(issueData) {
            try {
                const taskData = {
                    title: issueData.title,
                    description: issueData.description,
                    customerId: currentUser.id,
                    buildingId: issueData.buildingId || contracts[0]?.buildingId,
                    roomNumber: issueData.roomNumber || contracts[0]?.roomNumber,
                    priority: issueData.priority || 'medium',
                    status: 'pending',
                    type: 'issue', // Phân loại là sự cố từ khách
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                // Lưu vào Firebase
                const docRef = await addDoc(collection(db, 'tasks'), taskData);
                
                showToast('Đã gửi báo cáo sự cố thành công!');
                
                return { id: docRef.id, ...taskData };
            } catch (error) {
                console.error('Error creating issue:', error);
                showToast('Lỗi gửi báo cáo sự cố', 'error');
                throw error;
            }
        };

        function saveNotificationsToStorage() {
            // Sử dụng unified cache system thay vì dual storage
            if (currentUser?.id) {
                const existingCache = loadUserDataFromCache(currentUser.id) || {};
                existingCache.notifications = notifications;
                saveUserDataToCache(currentUser.id, existingCache);
                console.log('💾 Saved notifications to unified cache system');
            }
        }

        function removeNotificationByFirebaseId(firebaseId) {
            console.log('🗑️ Attempting to remove notification with Firebase ID:', firebaseId);
            const initialLength = notifications.length;
            
            // Xóa thông báo có firebaseId tương ứng
            notifications = notifications.filter(notification => 
                notification.data?.firebaseId !== firebaseId
            );
            
            const removedCount = initialLength - notifications.length;
            console.log('🗑️ Removed', removedCount, 'notification(s) from local storage');
            
            if (removedCount > 0) {
                saveNotificationsToStorage();
                
                // Refresh danh sách thông báo nếu đang hiển thị
                if (!document.getElementById('notifications-screen').classList.contains('hidden')) {
                    renderNotificationsList();
                }
                
                showToast('Thông báo đã được xóa', 'info');
            }
        }

        function loadNotificationsFromStorage() {
            // Đã được load trong setupRealtimeListeners từ unified cache system
            // Không cần load riêng nữa để tránh conflict
            console.log('📖 Notifications already loaded from unified cache system');
        }

        // Hàm xóa tất cả thông báo cũ (để test)
        window.clearAllNotifications = function() {
            const userPhone = localStorage.getItem('userPhone');
            if (userPhone) {
                // Xóa old notification storage
                localStorage.removeItem(`notifications_${userPhone}`);
            }
            
            // Clear from unified cache system
            if (currentUser?.id) {
                const existingCache = loadUserDataFromCache(currentUser.id) || {};
                existingCache.notifications = [];
                saveUserDataToCache(currentUser.id, existingCache);
            }
            
            notifications = [];
            renderNotificationsList();
            // updateNotificationBadge(); // Đã gọi trong renderNotificationsList()
            console.log('✅ Đã xóa tất cả thông báo khỏi cả 2 hệ thống storage');
        };
        
        // 🔍 DEBUG: Performance stats
        window.getPerformanceStats = function() {
            console.table(perfMon.calls);
            return perfMon.calls;
        };
        
        // 🧪 Test performance impact
        window.testRenderPerformance = function() {
            console.time('renderAll');
            renderHomeData();
            renderBillsList(); 
            renderNotificationsList();
            console.timeEnd('renderAll');
            console.log('Performance stats:', perfMon.calls);
        };
        
        // 🔧 DEBUG: Kiểm tra thứ tự sắp xếp
        window.checkSortOrder = function() {
            console.log('📊 BILLS SORT ORDER:');
            bills.forEach((bill, index) => {
                const date = bill.billDate?.toDate?.() || bill.createdAt?.toDate?.() || new Date(bill.createdAt || 0);
                console.log(`${index + 1}. ${bill.id?.slice(-6)} - Tháng ${bill.period} - ${date.toLocaleString('vi-VN')}`);
            });
            
            console.log('🔔 NOTIFICATIONS READ STATUS:');
            notifications.forEach((notif, index) => {
                const date = notif.createdAt instanceof Date ? notif.createdAt : (notif.createdAt?.toDate?.() || new Date(notif.createdAt));
                const readStatus = notif.isRead ? '✅ ĐÃ ĐỌC' : '🔴 CHƯA ĐỌC';
                console.log(`${index + 1}. ${readStatus} - ${notif.title} - ${date.toLocaleString('vi-VN')}`);
            });
        };
        
        // 🔍 DEBUG: Kiểm tra trạng thái thông báo chi tiết
        window.checkNotificationStatus = function() {
            console.log('🔔 DETAILED NOTIFICATION STATUS:');
            console.log(`Total notifications: ${notifications.length}`);
            
            const unreadCount = notifications.filter(n => !n.isRead).length;
            const readCount = notifications.filter(n => n.isRead).length;
            
            console.log(`📊 Summary: ${unreadCount} chưa đọc, ${readCount} đã đọc`);
            console.log('\n📋 Chi tiết:');
            
            notifications.forEach((notif, index) => {
                console.log(`${index + 1}. ID: ${notif.id}`);
                console.log(`   Title: ${notif.title}`);
                console.log(`   Status: ${notif.isRead ? '✅ ĐÃ ĐỌC' : '🔴 CHƯA ĐỌC'}`);
                console.log(`   Type: ${notif.type || 'N/A'}`);
                console.log(`   Created: ${notif.createdAt}`);
                console.log('---');
            });
        };
        
        // ⚡ QUICK FIX: Sắp xếp theo tháng hóa đơn
        window.fixNotifications = function() {
            console.log('🚨 SORTING BY BILL MONTH...');
            
            // In ra thông báo hiện tại
            notifications.forEach((n, i) => {
                const message = n.message || n.title || '';
                const monthMatch = message.match(/tháng\s+(\d+)/i);
                const month = monthMatch ? monthMatch[1] : '?';
                console.log(`${i+1}. ${n.title} (Tháng ${month})`);
            });
            
            // Force sort by BILL MONTH
            notifications.sort((a, b) => {
                const getBillMonth = (notification) => {
                    const message = notification.message || notification.title || '';
                    const monthMatch = message.match(/tháng\s+(\d+)/i);
                    if (monthMatch) {
                        return parseInt(monthMatch[1]);
                    }
                    return 11; // default
                };
                
                const monthA = getBillMonth(a);
                const monthB = getBillMonth(b);
                
                // Cùng tháng thì "Xác nhận thanh toán" trước "Thông báo hóa đơn"
                if (monthA === monthB) {
                    const isPaymentA = (a.title || '').includes('Xác nhận thanh toán');
                    const isPaymentB = (b.title || '').includes('Xác nhận thanh toán');
                    if (isPaymentA && !isPaymentB) return -1;
                    if (!isPaymentA && isPaymentB) return 1;
                    return 0;
                }
                
                return monthB - monthA; // Tháng mới trước
            });
            
            console.log('📅 After sort by MONTH:');
            notifications.forEach((n, i) => {
                const message = n.message || n.title || '';
                const monthMatch = message.match(/tháng\s+(\d+)/i);
                const month = monthMatch ? monthMatch[1] : '?';
                console.log(`${i+1}. ${n.title} (Tháng ${month})`);
            });
            
            // Force clear và render
            const listEl = document.getElementById('notifications-list');
            if (listEl) listEl.innerHTML = '';
            
            setTimeout(() => {
                renderNotificationsList();
                console.log('✅ FIXED BY MONTH!');
            }, 50);
        };
        
        // 🧪 TEST: Simulate bill unapproved (xóa thông báo)
        window.testBillUnapproved = function(billId) {
            if (!billId) {
                console.log('❌ Cần cung cấp billId. VD: testBillUnapproved("bill_id_here")');
                return;
            }
            
            console.log('🧪 Simulating bill unapproved - tìm và xóa thông báo bill_approved cho:', billId);
            
            // Tìm thông báo với billId này
            const notificationToRemove = notifications.find(n => 
                n.data?.billId === billId && n.type === 'bill_approved'
            );
            
            if (notificationToRemove) {
                console.log('🗑️ Tìm thấy thông báo, đang xóa:', notificationToRemove.title);
                
                // Xóa khỏi local array
                const index = notifications.indexOf(notificationToRemove);
                notifications.splice(index, 1);
                
                // Update storage và render
                saveNotificationsToStorage();
                renderNotificationsList();
                
                console.log('✅ Đã xóa thông báo bill_approved khỏi app');
            } else {
                console.log('❌ Không tìm thấy thông báo bill_approved cho billId:', billId);
                console.log('📋 Available notifications:');
                notifications.forEach(n => {
                    console.log(`- ${n.title} (type: ${n.type}, billId: ${n.data?.billId})`);
                });
            }
        };
        
        // 🧪 TEST: Comprehensive flow test
        window.testCompleteFlow = function(billId) {
            if (!billId) {
                console.log('❌ Usage: testCompleteFlow("bill_id_here")');
                console.log('📋 Available bills:');
                bills.forEach(bill => {
                    console.log(`- ${bill.id}: Tháng ${bill.period} (${bill.status})`);
                });
                return;
            }
            
            console.log('🧪 TESTING COMPLETE FLOW FOR BILL:', billId);
            
            // Show current notifications
            console.log('\n📋 Current notifications:');
            notifications.forEach((n, i) => {
                const relatedToBill = n.data?.billId === billId;
                const marker = relatedToBill ? '🎯' : '  ';
                console.log(`${marker} ${i+1}. ${n.title} (type: ${n.type}, billId: ${n.data?.billId})`);
            });
            
            console.log('\n🔄 EXPECTED BEHAVIOR:');
            console.log('1. Duyệt HĐ → Có thông báo "Thông báo hóa đơn"');
            console.log('2. Thu tiền → Có thông báo "Xác nhận thanh toán"');
            console.log('3. Hủy thu tiền → Xóa thông báo "Xác nhận thanh toán" + Xóa phiếu thu');
            console.log('4. Bỏ duyệt HĐ → Xóa thông báo "Thông báo hóa đơn" + Ẩn HĐ');
            console.log('\n✅ Tất cả thông báo và phiếu thu liên quan PHẢI biến mất!');
        };
        
        // 🔄 FORCE SORT: Ép buộc sắp xếp lại
        window.forceSortAndRender = function() {
            console.log('🔄 Force sorting and rendering...');
            
            // Force sort bills
            bills.sort((a, b) => {
                const getTime = (bill) => {
                    if (bill.billDate?.toDate) return bill.billDate.toDate().getTime();
                    if (bill.createdAt?.toDate) return bill.createdAt.toDate().getTime();
                    if (bill.createdAt) return new Date(bill.createdAt).getTime();
                    return new Date(2025, (parseInt(bill.period) || 11) - 1, 1).getTime();
                };
                return getTime(b) - getTime(a);
            });
            
            // Force sort notifications  
            notifications.sort((a, b) => {
                const getTime = (notif) => {
                    if (notif.createdAt instanceof Date) return notif.createdAt.getTime();
                    if (notif.createdAt?.toDate) return notif.createdAt.toDate().getTime();
                    return new Date(notif.createdAt || Date.now()).getTime();
                };
                return getTime(b) - getTime(a);
            });
            
            // Re-render everything
            renderHomeData();
            renderBillsList();
            renderNotificationsList();
            
            console.log('✅ Forced sort and render completed');
        };
        
        // 🐛 Debug bill status sync
        window.debugBillStatus = function() {
            console.log('=== BILL STATUS DEBUG ===');
            console.log('Bills in memory:', bills.map(b => ({
                id: b.id, 
                status: b.status, 
                paid: b.paid,
                code: b.code || b.billNumber
            })));
            
            const cache = loadUserDataFromCache(currentUser?.id);
            console.log('Bills in cache:', cache?.bills?.map(b => ({
                id: b.id, 
                status: b.status, 
                paid: b.paid,
                code: b.code || b.billNumber
            })));
        };
        
        // 🚀 Optimized DOM utilities
        const $ = {
            navItems: null,
            getNavItems() {
                if (!this.navItems) {
                    this.navItems = document.querySelectorAll('.nav-item');
                }
                return this.navItems;
            },
            updateNavActiveState(activeTab) {
                this.getNavItems().forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('onclick')?.includes(activeTab)) {
                        item.classList.add('active');
                    }
                });
            }
        };

        // Hàm tạo thông báo test
        window.createTestNotification = function() {
            createNotification(
                'payment_received',
                'Test Thông báo',
                'Đây là thông báo test để kiểm tra hệ thống hoạt động.',
                { test: true }
            );
            renderNotificationsList();
            console.log('✅ Đã tạo thông báo test');
        };

        // Hàm test push notification trực tiếp
        window.testPushNotification = function() {
            if (Notification.permission === 'granted') {
                displayPushNotification(
                    '🔔 Test Push Notification',
                    'Đây là test push notification xuất hiện trên màn hình điện thoại! 📱'
                );
                console.log('✅ Đã test push notification');
            } else {
                console.log('❌ Cần quyền thông báo để test');
                requestNotificationPermission();
            }
        };
        
        // Hàm tạo nhiều loại thông báo test khác nhau
        window.testAllNotifications = function() {
            const testTypes = [
                { type: 'bill_approved', title: '💰 Hóa đơn mới', message: 'Bạn có hóa đơn tháng 11 cần thanh toán.' },
                { type: 'payment_received', title: '✅ Thanh toán thành công', message: 'Hóa đơn của bạn đã được thanh toán.' },
                { type: 'issue_resolved', title: '🔧 Sự cố đã xử lý', message: 'Sự cố điện trong phòng đã được khắc phục.' },
                { type: 'announcement', title: '📢 Thông báo', message: 'Sẽ cắt điện bảo trì từ 8h-10h ngày mai.' }
            ];
            
            testTypes.forEach((test, index) => {
                setTimeout(() => {
                    createNotification(test.type, test.title, test.message, { test: true, index: index });
                }, index * 2000); // Cách nhau 2 giây
            });
            
            console.log('✅ Đang test tất cả loại thông báo...');
        };

        // Debug function
        window.debugNotifications = function() {
            console.log('=== NOTIFICATION DEBUG ===');
            console.log('📱 User phone:', localStorage.getItem('userPhone'));
            console.log('🔢 Notifications count:', notifications.length);
            console.log('📋 Notifications:', notifications);
            console.log('🏠 Current user:', currentUser);
            console.log('💰 Bills count:', bills.length);
            console.log('==========================');
        };

        window.markAllAsRead = function() {
            notifications.forEach(n => n.isRead = true);
            saveNotificationsToStorage();
            renderNotificationsList();
        };

        // Mark notification as read when clicked
        window.markNotificationAsRead = async function(notificationId, isCurrentlyUnread) {
            console.log('🖱️ markNotificationAsRead called:', { notificationId, isCurrentlyUnread });
            
            // Tìm notification trong local array
            const localNotification = notifications.find(n => n.id === notificationId);
            if (!localNotification) {
                console.log('❌ Notification not found:', notificationId);
                return;
            }
            
            if (localNotification.isRead) {
                console.log('⏭️ Already read, skipping');
                return;
            }
            
            console.log('🔄 Marking notification as read:', notificationId);
            
            try {
                // Skip Firestore update - chỉ update local state để tránh lỗi permission
                // Vì adminNotifications được tạo bởi admin, user không có quyền update
                // const notificationRef = doc(db, 'adminNotifications', notificationId);
                // await updateDoc(notificationRef, { isRead: true });
                
                console.log('Skipping Firestore update - updating local state only');
                
                // Update local data
                const localIndex = notifications.findIndex(n => n.id === notificationId);
                console.log('🔍 Finding notification in local array:', localIndex, 'total notifications:', notifications.length);
                
                if (localIndex !== -1) {
                    console.log('✅ Found notification, updating isRead to true');
                    notifications[localIndex].isRead = true;
                } else {
                    console.log('❌ Notification not found in local array!');
                }
                
                // Update localStorage using consistent key
                saveNotificationsToStorage();
                console.log('💾 Updated localStorage');
                
                // Re-render notifications list
                // console.log('🎨 Re-rendering notifications list...');
                renderNotificationsList();
                console.log('✅ Done marking as read');
                
            } catch (error) {
                console.error('Error in markNotificationAsRead:', error.message || error);
                // Continue with local update even if Firestore fails
            }
        };

        function showNotificationsScreen() {
            showScreen('notifications');
        }

        // Debounce để tránh render quá nhiều
        let renderNotificationsTimeout = null;
        
        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            if (!badge) return;
            
            const unreadCount = notifications.filter(n => !n.isRead).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function renderNotificationsList() {
            // Debounce để tránh spam rendering
            if (renderNotificationsTimeout) {
                clearTimeout(renderNotificationsTimeout);
            }
            
            renderNotificationsTimeout = setTimeout(() => {
                _actualRenderNotificationsList();
            }, 50);
        }
        
        function _actualRenderNotificationsList() {
            perfMon.track('renderNotificationsList');
            const startTime = performance.now();
            const listEl = document.getElementById('notifications-list');
            if (!listEl) return;
            
            // 🔥 ĐẢMBẢO SẮP XẾP THEO THÁNG HÓA ĐƠN TRƯỚC KHI RENDER
            notifications.sort((a, b) => {
                const getBillMonth = (notification) => {
                    // Tìm tháng từ message content
                    const message = notification.message || notification.title || '';
                    const monthMatch = message.match(/tháng\s+(\d+)(?:-(\d+))?/i);
                    if (monthMatch) {
                        const month = parseInt(monthMatch[1]);
                        const year = monthMatch[2] ? parseInt(monthMatch[2]) : 2025;
                        return year * 100 + month;
                    }
                    
                    // Fallback: từ bill data
                    if (notification.data?.billId && bills?.length > 0) {
                        const bill = bills.find(b => b.id === notification.data.billId);
                        if (bill?.period) return 2025 * 100 + parseInt(bill.period);
                    }
                    
                    return 202511; // Default tháng 11/2025
                };
                
                const monthA = getBillMonth(a);
                const monthB = getBillMonth(b);
                
                // Cùng tháng thì "Xác nhận thanh toán" trước "Thông báo hóa đơn"
                if (monthA === monthB) {
                    const isPaymentA = (a.title || '').includes('Xác nhận thanh toán');
                    const isPaymentB = (b.title || '').includes('Xác nhận thanh toán');
                    
                    if (isPaymentA && !isPaymentB) return -1;
                    if (!isPaymentA && isPaymentB) return 1;
                }
                
                return monthB - monthA; // Tháng mới nhất trước
            });
            
            // Cập nhật badge
            updateNotificationBadge();
            
            if (notifications.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-20 h-20 mx-auto mb-4 bg-gray-50 rounded-full flex items-center justify-center border border-gray-200">
                            <svg class="w-10 h-10 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                <path d="m18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                            </svg>
                        </div>
                        <p class="text-gray-500">${currentLanguage === 'en' ? 'No notifications' : 'Chưa có thông báo nào'}</p>
                    </div>
                `;
                return;
            }

            // Sắp xếp theo THÁNG HÓA ĐƠN (mới nhất trước) thay vì thời gian tạo
            const sortedNotifications = [...notifications].sort((a, b) => {
                const getBillMonth = (notification) => {
                    // Tìm tháng từ message content
                    const message = notification.message || notification.title || '';
                    
                    // Pattern: "tháng X-YYYY" hoặc "tháng X"
                    const monthMatch = message.match(/tháng\s+(\d+)(?:-(\d+))?/i);
                    if (monthMatch) {
                        const month = parseInt(monthMatch[1]);
                        const year = monthMatch[2] ? parseInt(monthMatch[2]) : 2025;
                        return year * 100 + month; // VD: 2025*100 + 11 = 202511
                    }
                    
                    // Fallback: tìm từ data.billId nếu có
                    if (notification.data?.billId && bills?.length > 0) {
                        const bill = bills.find(b => b.id === notification.data.billId);
                        if (bill?.period) {
                            const period = parseInt(bill.period);
                            return 2025 * 100 + period;
                        }
                    }
                    
                    // Fallback cuối: dùng thời gian tạo
                    if (notification.createdAt) {
                        const date = notification.createdAt instanceof Date ? 
                            notification.createdAt : 
                            (notification.createdAt.toDate ? notification.createdAt.toDate() : new Date(notification.createdAt));
                        return date.getFullYear() * 100 + (date.getMonth() + 1);
                    }
                    
                    return 202511; // Default tháng 11/2025
                };
                
                const monthA = getBillMonth(a);
                const monthB = getBillMonth(b);
                
                // Nếu cùng tháng, sắp xếp theo loại: "Xác nhận thanh toán" trước "Thông báo hóa đơn"
                if (monthA === monthB) {
                    const isPaymentA = (a.title || '').includes('Xác nhận thanh toán');
                    const isPaymentB = (b.title || '').includes('Xác nhận thanh toán');
                    
                    if (isPaymentA && !isPaymentB) return -1; // A (payment) lên trước
                    if (!isPaymentA && isPaymentB) return 1;  // B (payment) lên trước
                    
                    // Cùng loại thì sắp xếp theo thời gian tạo
                    const timeA = a.createdAt instanceof Date ? a.createdAt.getTime() : 
                        (a.createdAt?.toDate ? a.createdAt.toDate().getTime() : new Date(a.createdAt).getTime());
                    const timeB = b.createdAt instanceof Date ? b.createdAt.getTime() : 
                        (b.createdAt?.toDate ? b.createdAt.toDate().getTime() : new Date(b.createdAt).getTime());
                    return timeB - timeA;
                }
                
                // Tháng mới nhất trước (monthB - monthA)
                return monthB - monthA;
            });

            // Virtual scrolling cho danh sách dài
            const maxVisible = 50; // Chỉ render tối đa 50 items
            const visibleNotifications = sortedNotifications.slice(0, maxVisible);
            
            listEl.innerHTML = visibleNotifications.map(notification => {
                const dateTime = formatDateTime(notification.createdAt);
                const isUnread = !notification.isRead;
                
                // Translate notification content
                const translatedTitle = translateNotificationTitle(notification.title);
                const translatedMessage = translateNotificationMessage(notification.message);
                
                return `
                    <div class="notification-item bg-white p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 ${isUnread ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''}" 
                         data-notification-id="${notification.id}" 
                         data-is-unread="${isUnread}"
                         onclick="markNotificationAsRead('${notification.id}', ${isUnread});">
                        <div class="flex items-start gap-3">
                            <div class="w-12 h-12 rounded-lg bg-green-600 flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                    <path d="m18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-semibold text-gray-900 text-base mb-1 ${isUnread ? 'font-bold' : ''}">${translatedTitle}</h3>
                                <p class="text-gray-600 text-sm leading-relaxed mb-2">${translatedMessage}</p>
                                <div class="flex items-center text-gray-400 text-xs">
                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                                    </svg>
                                    ${dateTime}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Hiển thị thông báo nếu có nhiều hơn maxVisible
            if (notifications.length > maxVisible) {
                listEl.innerHTML += `
                    <div class="text-center py-4 bg-gray-50 border-t">
                        <p class="text-gray-600 text-sm">Hiển thị ${maxVisible}/${notifications.length} thông báo mới nhất</p>
                        <button onclick="clearAllNotifications()" class="mt-2 text-blue-600 text-sm hover:underline">
                            Xóa tất cả để cải thiện hiệu suất
                        </button>
                    </div>
                `;
            }
            
            const endTime = performance.now();
            if (endTime - startTime > 50) {
                console.warn(`⚠️ Slow notifications render: ${(endTime - startTime).toFixed(1)}ms for ${visibleNotifications.length}/${notifications.length} items`);
            }
        }

        function translateNotificationTitle(title) {
            if (currentLanguage === 'en') {
                if (title.includes('Thông báo hóa đơn')) {
                    return 'Bill Notification';
                }
                return title;
            }
            return title;
        }

        function translateNotificationMessage(message) {
            if (currentLanguage === 'en') {
                if (message.includes('Bạn có hóa đơn tiền nhà tháng')) {
                    return message
                        .replace('Bạn có hóa đơn tiền nhà tháng', 'You have a monthly rent bill for')
                        .replace('cần thanh toán', 'that needs payment')
                        .replace('Vui lòng kiểm tra và thanh toán đúng hạn', 'Please check and pay on time');
                }
                return message;
            }
            return message;
        }

        // Global function to translate service names in bills
        function translateBillServiceName(name) {
            if (currentLanguage === 'en') {
                const lowerName = name.toLowerCase();
                if (lowerName.includes('tiền nhà') || lowerName.includes('thuê phòng') || lowerName.includes('rent')) return 'Rent';
                if (lowerName.includes('tiền điện') || lowerName.includes('điện')) return 'Electricity';
                if (lowerName.includes('tiền nước') || lowerName.includes('nước')) return 'Water';
                if (lowerName.includes('dịch vụ chung') || lowerName.includes('common')) return 'Common Service';
                if (lowerName.includes('tiền xe') || lowerName.includes('parking')) return 'Parking';
                return name;
            }
            return name;
        }

        function getNotificationIcon(type) {
            switch(type) {
                case 'bill_approved':
                    return '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>';
                case 'payment_received':
                    return '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4z"/><path d="M9 12a1 1 0 102 0V8a1 1 0 10-2 0v4z"/><path d="M9 15a1 1 0 011-1h0a1 1 0 110 2h0a1 1 0 01-1-1z"/></svg>';
                case 'issue_created':
                    return '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>';
                case 'issue_resolved':
                    return '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>';
                default:
                    return '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>';
            }
        }

        function getNotificationIconColor(type) {
            switch(type) {
                case 'bill_approved': return 'bg-blue-500';
                case 'payment_received': return 'bg-green-600';
                case 'issue_created': return 'bg-orange-500';
                case 'issue_resolved': return 'bg-green-600';
                default: return 'bg-gray-500';
            }
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${day}-${month}-${year} ${hours}:${minutes}`;
        }

        function formatTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Vừa xong';
            if (diffMins < 60) return `${diffMins} phút trước`;
            if (diffHours < 24) return `${diffHours} giờ trước`;
            if (diffDays < 7) return `${diffDays} ngày trước`;
            return date.toLocaleDateString('vi-VN');
        }

        // --- PROFILE FUNCTIONS ---
        
        window.showProfileScreen = function() {
            console.log('🔧 showProfileScreen called');
            showScreen('profile');
            
            // Update navigation to profile
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector('.nav-item[onclick="switchTab(\'profile\')"]')?.classList.add('active');
        };

        function loadProfileData() {
            console.log('🔧 loadProfileData called', currentUser);
            if (currentUser) {
                document.getElementById('profile-name').textContent = currentUser.name || 'Khách hàng';
                document.getElementById('profile-fullname').textContent = currentUser.name || 'Chưa cập nhật';
                document.getElementById('profile-phone').textContent = currentUser.phone || 'Chưa cập nhật';
                
                // Load avatar if exists
                const savedAvatar = localStorage.getItem(`avatar_${currentUser.phone}`);
                if (savedAvatar) {
                    document.getElementById('profile-avatar').src = savedAvatar;
                }
                
                // Load language preference
                const savedLanguage = localStorage.getItem('app_language') || 'vi';
                const languageRadio = document.querySelector(`input[name="language"][value="${savedLanguage}"]`);
                if (languageRadio) {
                    languageRadio.checked = true;
                }
            } else {
                console.log('❌ No currentUser data');
            }
        }

        window.changeAvatar = function() {
            document.getElementById('avatar-input').click();
        };

        window.handleAvatarChange = function(input) {
            const file = input.files[0];
            if (file) {
                // Kiểm tra kích thước file (max 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    alert('Ảnh quá lớn! Vui lòng chọn ảnh nhỏ hơn 2MB');
                    return;
                }
                
                // Kiểm tra loại file
                if (!file.type.startsWith('image/')) {
                    alert('Vui lòng chọn file ảnh!');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const avatarImg = document.getElementById('profile-avatar');
                    avatarImg.src = e.target.result;
                    
                    // Lưu vào localStorage
                    if (currentUser?.phone) {
                        localStorage.setItem(`avatar_${currentUser.phone}`, e.target.result);
                        showToast('Đã cập nhật ảnh đại diện!', 'success');
                    }
                };
                reader.readAsDataURL(file);
            }
        };

        // Debug function to check all screens
        window.debugScreens = function() {
            console.log('=== SCREEN DEBUG ===');
            const screens = ['home-screen', 'bills-screen', 'notifications-screen', 'create-issue-screen', 'issue-form-screen', 'profile-screen'];
            screens.forEach(screenId => {
                const element = document.getElementById(screenId);
                console.log(`${screenId}:`, element ? 'EXISTS' : 'NOT FOUND', element?.classList.contains('hidden') ? 'HIDDEN' : 'VISIBLE');
            });
            console.log('====================');
        };

        // Language change handler
        document.addEventListener('change', (e) => {
            if (e.target.name === 'language') {
                const selectedLanguage = e.target.value;
                localStorage.setItem('app_language', selectedLanguage);
                
                // TODO: Implement language change logic
                showToast(`Đã chọn ngôn ngữ: ${e.target.parentElement.textContent.trim()}`, 'success');
                
                // Placeholder for future language implementation
                console.log('Selected language:', selectedLanguage);
            }
        });

        // Auto refresh - TẮTĐI VÌ ĐÃ CÓ REAL-TIME LISTENERS
        // setInterval(async () => {
        //     if (currentUser) {
        //         await loadUserData(currentUser.id);
        //         renderHomeData();
        //         renderBillsList();
        //     }
        // }, 30000);

        // Initialize app when page loads
        // Initialize language system
        function initLanguageSystem() {
            // Set initial language from localStorage
            const savedLang = localStorage.getItem('language') || 'vi';
            currentLanguage = savedLang;
            
            // Set radio button state
            const radioButtons = document.querySelectorAll('input[name="language"]');
            radioButtons.forEach(radio => {
                radio.checked = radio.value === savedLang;
            });
            
            // Add event listeners for language change
            radioButtons.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        switchLanguage(e.target.value);
                    }
                });
            });
        }

        initApp();
        
        // Test function for manual language switch
        window.testLanguageSwitch = function(lang) {
            console.log('🧪 Manual language switch test:', lang);
            switchLanguage(lang);
        };
        
        // 🧪 Cache test functions
        window.clearUserCache = function() {
            const userPhone = localStorage.getItem('userPhone');
            if (userPhone) {
                localStorage.removeItem(`n_home_user_${userPhone}`);
                console.log('🗑️ Đã xóa cache user:', userPhone);
            }
        };
        
        window.getUserCacheInfo = function() {
            const userPhone = localStorage.getItem('userPhone');
            if (!userPhone) return 'Chưa đăng nhập';
            
            const cached = localStorage.getItem(`n_home_user_${userPhone}`);
            if (!cached) return 'Chưa có cache';
            
            try {
                const cacheData = JSON.parse(cached);
                return {
                    user: userPhone,
                    version: cacheData.version,
                    timestamp: new Date(cacheData.timestamp).toLocaleString(),
                    size: `${(cached.length / 1024).toFixed(1)} KB`,
                    bills: cacheData.data?.bills?.length || 0,
                    notifications: cacheData.data?.notifications?.length || 0
                };
            } catch (error) {
                return 'Cache bị lỗi';
            }
        };
        
        function updateBillDetailScreen() {
            // console.log('💳 Updating bill detail screen, current language:', currentLanguage);
            
            const titleEl = document.getElementById('bill-detail-title');
            if (titleEl) {
                titleEl.textContent = currentLanguage === 'en' ? 'Bill Details' : 'Chi tiết hóa đơn';
            }
        }

        function updateIssueFormScreen() {
            console.log('📝 Updating issue form screen, current language:', currentLanguage);
            
            const titleEl = document.getElementById('report-issue-title');
            if (titleEl) {
                titleEl.textContent = t('reportIssueTitle');
            }
            
            const infoTitle = document.getElementById('issue-info-title');
            if (infoTitle) {
                infoTitle.textContent = t('issueInfo');
            }
            
            const descLabel = document.getElementById('description-label');
            if (descLabel) {
                descLabel.textContent = t('detailedDescription') + ' *';
            }
            
            const textarea = document.getElementById('issue-description');
            if (textarea) {
                textarea.placeholder = t('descriptionPlaceholder');
            }
            
            const imagesLabel = document.getElementById('images-label');
            if (imagesLabel) {
                const count = imagesLabel.textContent.match(/\((\d+)\/5\)/)?.[1] || '0';
                imagesLabel.textContent = `${t('images')} (${count}/5)`;
            }
            
            const addImageText = document.getElementById('add-image-text');
            if (addImageText) {
                addImageText.textContent = t('addImage');
            }
            
            const chooseBtn = document.getElementById('choose-device-btn');
            if (chooseBtn) {
                chooseBtn.textContent = t('chooseFromDevice');
            }
            
            const submitBtn = document.getElementById('submit-issue-btn');
            if (submitBtn) {
                submitBtn.textContent = t('submitIssueBtn');
            }
            
            const cancelBtn = document.getElementById('cancel-btn');
            if (cancelBtn) {
                cancelBtn.textContent = t('cancel');
            }
        }

        // Initialize language system when DOM is ready
        document.addEventListener('DOMContentLoaded', initLanguageSystem);
        
        // Fix English flag after page load
        setTimeout(() => {
            const englishFlag = document.querySelector('input[value="en"]').parentElement.querySelector('.text-2xl');
            if (englishFlag && englishFlag.textContent.includes('�')) {
                englishFlag.textContent = 'EN';
                englishFlag.className = 'w-8 h-6 mr-2 bg-blue-600 text-white text-xs rounded flex items-center justify-center font-bold';
            }
        }, 1000);
    </script>

    </div> <!-- End app-container -->

    <!-- PWA Install & Service Worker -->
    <script>
        // Service Worker Registration cho Firebase Messaging
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/firebase-messaging-sw.js')
                    .then(registration => {
                        console.log('✅ Firebase Messaging Service Worker registered:', registration.scope);
                        
                        // Cấu hình Firebase Messaging với service worker
                        if (messaging) {
                            messaging.useServiceWorker(registration);
                        }
                    })
                    .catch(error => {
                        console.log('❌ Firebase Messaging SW registration failed:', error);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        const installPrompt = document.getElementById('install-prompt');
        const installButton = document.getElementById('install-button');
        const installCancelBtn = document.getElementById('install-cancel-btn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Chỉ show install prompt khi KHÔNG phải localhost (để test production)
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1';
            
            if (!isLocalhost && installPrompt) {
                installPrompt.style.display = 'flex';
            }
        });

        if (installButton) {
            installButton.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response: ${outcome}`);
                    deferredPrompt = null;
                }
                if (installPrompt) {
                    installPrompt.style.display = 'none';
                }
            });
        }

        if (installCancelBtn) {
            installCancelBtn.addEventListener('click', () => {
                if (installPrompt) {
                    installPrompt.style.display = 'none';
                }
            });
        }

        // Hide install prompt when already installed
        window.addEventListener('appinstalled', () => {
            console.log('✅ PWA installed successfully!');
            if (installPrompt) {
                installPrompt.style.display = 'none';
            }
            deferredPrompt = null;
        });

        // Check if running as PWA
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('✅ Running as PWA!');
        }
    </script>

    <!-- Firebase Cloud Messaging (FCM) -->
    <script>
        // Firebase Configuration cho FCM - PHẢI KHỚP VỚI js/firebase.js và firebase-messaging-sw.js
        const fcmFirebaseConfig = {
            apiKey: "AIzaSyA2m1K7pijNC1yirw_t36Rc3HnzCsD8pCs",
            authDomain: "nha-tro-53ca7.firebaseapp.com",
            projectId: "nha-tro-53ca7",
            storageBucket: "nha-tro-53ca7.firebasestorage.app",
            messagingSenderId: "415886594203",
            appId: "1:415886594203:web:f3cda09037973176c9763e",
            measurementId: "G-Y5GSRYP4XC"
        };

        // VAPID Key từ Firebase Console (Project Settings > Cloud Messaging > Web Push certificates)
        const vapidKey = 'BHj9JZW39U-e3JhrHcwEYxgKpLcSTD0JyaFw54agm3CvaXXCYD4q3HBM9_rVv9iOXRs6a2fIhSEeybftXNtrhmc';

        // Khởi tạo Firebase cho FCM (chỉ khi chưa được khởi tạo)
        if (!firebase.apps.length) {
            firebase.initializeApp(fcmFirebaseConfig);
        }
        
        // Khởi tạo Firebase Messaging
        const messaging = firebase.messaging();
        
        // Biến lưu FCM token
        window.fcmToken = null;

        // Hàm xin quyền thông báo và lấy FCM token
        async function requestNotificationPermission() {
            console.log('🔇 FCM notifications disabled by user request');
            return null; // TẮT TẤT CẢ POPUP THÔNG BÁO FCM
        }

        // Lưu FCM token vào hồ sơ khách hàng trong Firestore
        async function saveFCMTokenToProfile(token) {
            try {
                if (window.customerData && window.customerData.id) {
                    await setDoc(doc(db, 'customers', window.customerData.id), {
                        fcmToken: token,
                        lastTokenUpdate: new Date(),
                        deviceInfo: {
                            userAgent: navigator.userAgent,
                            platform: navigator.platform,
                            language: navigator.language
                        }
                    }, { merge: true });
                    
                    console.log('✅ Đã lưu FCM token vào Firestore');
                } else {
                    console.log('⚠️ Chưa có thông tin khách hàng để lưu FCM token');
                }
            } catch (error) {
                console.error('❌ Lỗi khi lưu FCM token:', error);
            }
        }

        // Thông báo test để xác minh hoạt động
        function showTestNotification() {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('🎉 N-Home đã sẵn sàng!', {
                    body: 'Bạn sẽ nhận được thông báo khi có hóa đơn mới hoặc sự cố được xử lý.',
                    icon: '/icon-nen-xanh.jpg',
                    tag: 'test-notification'
                });
                console.log('✅ Đã gửi thông báo test');
            }
        }

        // Xử lý thông báo khi app đang mở (foreground messages)
        messaging.onMessage((payload) => {
            console.log('🔔 Nhận thông báo khi app đang mở:', payload);
            
            const title = payload.notification?.title || payload.data?.title || 'Thông báo mới';
            const body = payload.notification?.body || payload.data?.body || 'Bạn có thông báo mới';
            
            // Tạo thông báo tùy chỉnh trong app
            showInAppNotification(title, body);
            
            // Làm mới dữ liệu khi nhận thông báo
            if (typeof loadData === 'function') {
                loadData();
            }
        });

        // Hiển thị thông báo trong app (custom notification banner)
        function showInAppNotification(title, body) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-white border-l-4 border-green-500 rounded-lg shadow-lg p-4 max-w-sm z-50 notification-popup';
            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 2L3 7v11h4v-6h6v6h4V7l-7-5z"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-900 text-sm">${title}</h4>
                        <p class="text-gray-600 text-sm mt-1">${body}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Tự động xóa sau 5 giây
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }



        // Tự động xin quyền thông báo khi khách hàng đăng nhập thành công
        const originalLoadCustomerData = window.loadCustomerData;
        if (originalLoadCustomerData) {
            window.loadCustomerData = async function(phone, password) {
                const result = await originalLoadCustomerData(phone, password);
                
                if (result && window.customerData) {
                    // Đợi 2 giây rồi xin quyền thông báo - TẮT
                    // setTimeout(() => {
                    //     requestNotificationPermission();
                    // }, 2000);
                }
                
                return result;
            };
        }
    </script>
</body>
</html>