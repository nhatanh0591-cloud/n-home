<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N-Home - Kh√°ch H√†ng</title>
    <meta name="description" content="·ª®ng d·ª•ng xem h√≥a ƒë∆°n v√† thanh to√°n ti·ªÅn nh√† tr·ªç">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest-customer.json" crossorigin="use-credentials">
    
    <!-- Theme Color - Tr√πng v·ªõi logo #23904f -->
    <meta name="theme-color" content="#23904f">
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#23904f">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#23904f">
    
    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="N-Home">
    <link rel="apple-touch-icon" href="/icon-nen-xanh.jpg">
    <link rel="apple-touch-startup-image" href="/icon-nen-xanh.jpg">
    
    <!-- Android -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Icons -->
    <link rel="icon" type="image/jpeg" sizes="192x192" href="/icon-nen-xanh.jpg">
    <link rel="icon" type="image/jpeg" sizes="512x512" href="/icon-nen-xanh.jpg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- üîá DISABLE ALL CONSOLE LOGS FOR PRODUCTION -->
    <script>
        // Developer mode: Add ?debug=1 to URL to enable logs
        const isDev = window.location.hostname === 'localhost' || 
                     window.location.hostname === '127.0.0.1' || 
                     new URLSearchParams(window.location.search).has('debug');
        
        if (!isDev) {
            // Production: Disable console spam
            console.log = function() {};
            console.warn = function() {};
            console.info = function() {};
            console.debug = function() {};
        }
        // Always keep console.error for critical debugging
        
        // üßπ Cleanup on page unload to prevent memory leaks
        window.addEventListener('beforeunload', () => {
            activeListeners.forEach(unsubscribe => {
                if (typeof unsubscribe === 'function') {
                    unsubscribe();
                }
            });
            if (renderNotificationsTimeout) {
                clearTimeout(renderNotificationsTimeout);
            }
        });
        
        // üö® Global error handlers ƒë·ªÉ tr√°nh crash app
        window.addEventListener('error', (event) => {
            console.error('üö® Global JS Error:', event.error?.message || event.message);
            // Kh√¥ng ƒë·ªÉ error crash app
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('üö® Unhandled Promise Rejection:', event.reason?.message || event.reason);
            event.preventDefault(); // Prevent console error
        });
    </script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #e5e7eb;
            min-height: 100vh;
        }
        .app-container {
            max-width: 400px;
            margin: 0 auto;
            background: #f3f4f6;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            overflow-x: hidden;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #1e6b3a, #23904f);
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 16px;
        }
        .status-paid { background: #dcfce7; color: #23904f; }
        .status-unpaid { background: #fef3c7; color: #d97706; }
        .hidden { display: none; }
        
        /* Bills Screen Styles */
        #bills-screen {
            background: #f8fafc;
            height: 100vh;
            overflow: hidden;
        }
        
        #bills-screen .content-wrapper {
            height: 100vh;
            overflow-y: auto;
            padding-bottom: 100px;
        }
        
        /* Custom scrollbar for bills list */
        #bills-list-page {
            padding-bottom: 20px;
        }
        
        /* ·∫®n thanh cu·ªôn cho mobile */
        #bills-list-page::-webkit-scrollbar {
            width: 0;
            display: none;
        }
        
        /* ·∫®n thanh cu·ªôn cho t·∫•t c·∫£ c√°c m√†n h√¨nh */
        
        /* Hide VN/EN labels but keep radio buttons */
        .language-code {
            display: none !important;
        }
        ::-webkit-scrollbar {
            width: 0;
            display: none;
        }
        
        /* ƒê·∫£m b·∫£o v·∫´n c√≥ th·ªÉ scroll tr√™n mobile */
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            width: 100%;
            max-width: 400px;
            border-radius: 20px 20px 0 0;
            padding: 2px 0;
        }
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 0;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .nav-item.active {
            color: #23904f;
        }
        .nav-item:not(.active) {
            color: #9ca3af;
        }
        .nav-item:hover {
            background: #f9fafb;
        }
        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }
        .nav-label {
            font-size: 11px;
            font-weight: 500;
        }
        .content-wrapper {
            padding-bottom: 85px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: relative;
        }
        
        #notifications-screen .content-wrapper {
            padding-bottom: 80px;
        }
        .wallet-float {
            margin-top: -32px;
            background: white;
            padding: 6px;
            border-radius: 50%;
        }
        
        /* Ensure all screens stay within app container */
        #home-screen,
        #login-screen {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: relative;
        }
        
        #notifications-screen {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }
        
        /* Fix notifications screen layout */
        #notifications-screen {
            background: white;
            height: 100vh;
            overflow: hidden;
        }
        
        #notifications-screen .content-wrapper {
            height: 100vh;
            padding-bottom: 80px;
            padding-top: 0;
        }
        
        /* QR Payment Screen Styles */
        #qr-payment-screen {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: #f0f9ff;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Disable scroll and interaction when not logged in */
        .no-scroll {
            overflow: hidden !important;
            touch-action: none !important;
        }
        
        .disabled-interaction {
            pointer-events: none !important;
            user-select: none !important;
        }
        
        .disabled-interaction .content-wrapper {
            overflow: hidden !important;
            height: 100vh !important;
        }
        
        #qr-payment-screen .content-wrapper {
            height: 100vh;
            padding-bottom: 80px;
            padding-top: 0;
        }
        
        
        /* Create Issue Screen Styles */
        #create-issue-screen {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            height: 100vh;
            overflow: visible;
        }
        
        #create-issue-screen .content-wrapper {
            height: 100vh;
            padding-bottom: 100px;
            padding-top: 0;
        }
        
        /* Custom styles for issue screen to match sample exactly */
        #create-issue-screen .issue-illustration {
            width: 200px !important;
            height: 200px !important;
            max-width: 200px !important;
            max-height: 200px !important;
            object-fit: contain;
            margin: 0 auto;
        }
        
        #create-issue-screen .issue-title {
            font-size: 1.1rem; /* 17.6px */
            font-weight: 700;
            line-height: 1.3;
            color: #374151;
            margin-bottom: 0.75rem;
        }
        
        #create-issue-screen .issue-description {
            font-size: 0.8rem; /* 12.8px */
            line-height: 1.4;
            color: #6B7280;
            margin-bottom: 1.25rem;
            padding: 0 0.5rem;
        }
        
        /* Line clamp utility for text truncation */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Issue Form Screen Styles */
        #issue-form-screen {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: #f8fafc;
            height: 100vh;
            overflow: hidden;
        }
        
        #create-issue-screen .content-wrapper {
            height: 100vh;
            padding-bottom: 80px;
            padding-top: 0;
        }
        
        /* Line clamp utility for text truncation */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Issue Form Screen Styles */
        #issue-form-screen {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: #f8fafc;
            height: 100vh;
            overflow: hidden;
        }
        
        #issue-form-screen .content-wrapper {
            height: 100vh;
            padding-bottom: 80px;
            padding-top: 0;
        }
        
        #notifications-list {
            max-height: calc(100vh - 140px);
            background: white;
        }
        
        /* Bill Detail Screen */
        #bill-detail-screen {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 400px;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }
        
        /* Profile Screen Styles */
        #profile-screen {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: #f0f9ff;
            height: 100vh;
            overflow: hidden;
        }
        
        #profile-screen .content-wrapper {
            height: 100vh;
            padding-bottom: 80px;
            padding-top: 0;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Loading Screen -->
        <div id="loading-screen" class="gradient-bg h-screen flex items-center justify-center">
            <div class="text-center text-white">
                <div class="w-16 h-16 mx-auto mb-4 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                    <div class="w-8 h-8 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                </div>
                <p class="text-lg">ƒêang k·∫øt n·ªëi...</p>
            </div>
        </div>

        <!-- Install Button (Hidden by default) -->
        <div id="install-prompt" class="hidden fixed top-4 left-4 right-4 bg-white rounded-lg shadow-lg p-4 z-50 animate-bounce">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                        <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L9 5.414V17a1 1 0 102 0V5.414l5.293 5.293a1 1 0 001.414-1.414l-7-7z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">C√†i ƒë·∫∑t ·ª©ng d·ª•ng</p>
                        <p class="text-xs text-gray-600">Truy c·∫≠p nhanh h∆°n</p>
                    </div>
                </div>
                <button id="install-button" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                    C√†i ƒë·∫∑t
                </button>
            </div>
        </div>

        <!-- Login Screen -->
        <div id="login-screen" class="hidden gradient-bg h-screen">
            <div class="pt-20 px-6">
                <div class="text-center text-white mb-10">
                    <img src="/icon-nen-xanh.jpg" alt="N-Home Logo" class="w-16 h-16 rounded-full mx-auto mb-4">
                    <h1 class="text-2xl font-bold mb-2">N-Home</h1>
                    <p class="text-white text-opacity-80">Ki·ªÉm So√°t Chi Ph√≠ v√† Th√¥ng Tin Thu√™ Nh√†</p>
                </div>

                <div class="card">
                    <h2 class="text-xl font-bold mb-2">ƒêƒÉng Nh·∫≠p</h2>
                    <p class="text-gray-600 mb-6">Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ xem th√¥ng tin h√≥a ƒë∆°n</p>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="tel" id="phone-input" placeholder="0961512412" maxlength="10" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <button id="login-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 font-semibold">
                        ƒêƒÉng Nh·∫≠p
                    </button>
                </div>
            </div>
        </div>

        <!-- Home Screen -->
        <div id="home-screen" class="hidden">
            <div class="content-wrapper">
            <!-- Header -->

            
            <!-- Building Info -->
            <div class="px-6 mb-3">
                <h2 class="text-lg font-semibold mb-3 text-gray-700" id="room-info-header">Th√¥ng tin t√≤a nh√†</h2>
                <div class="card" id="building-info">
                    <!-- Loading skeleton -->
                    <div class="animate-pulse">
                        <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
                        <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                    </div>
                </div>
            </div>

            <!-- Bills List -->
            <div class="px-6">
                <!-- Ti·ªÅn thu√™ v√† c√°c kho·∫£n ph√≠ -->
                <div class="mb-3">
                    <h2 class="text-lg font-semibold mb-3 text-gray-700" id="rent-header">Ti·ªÅn thu√™ v√† c√°c kho·∫£n ph√≠</h2>
                    <div class="card" id="rent-info">
                        <!-- Loading skeleton -->
                        <div class="animate-pulse">
                            <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
                            <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tenant Info -->
            <div class="px-6 mb-3">
                <h2 class="text-lg font-semibold mb-3 text-gray-700" id="tenant-header">Ng∆∞·ªùi thu√™</h2>
                <div class="card" id="tenant-info">
                    <!-- Loading skeleton -->
                    <div class="animate-pulse">
                        <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
                        <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Bills Screen -->
        <div id="bills-screen" class="hidden bg-gray-100 min-h-screen">
            <div class="content-wrapper">
                <!-- Header v·ªõi ti√™u ƒë·ªÅ ·ªü gi·ªØa -->
                <div class="bg-green-600 text-white px-4 py-4 flex items-center justify-center sticky top-0 z-50 shadow-lg h-16">
                    <h1 class="text-xl font-bold" id="bills-title">H√≥a ƒë∆°n</h1>
                </div>

                <!-- Bills List Container -->
                <div class="px-4 py-4 pb-20">
                    <div id="bills-list-page" class="space-y-4">
                        <!-- Bills will be rendered here -->
                        <div class="bg-white rounded-xl p-4 shadow-sm animate-pulse">
                            <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
                            <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation Bar -->
        <div class="bottom-nav">
                <div class="flex">
                    <div class="nav-item active" onclick="switchTab('home')">
                        <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M4 4h7v7H4V4zm9 0h7v7h-7V4zM4 13h7v7H4v-7zm9 0h7v7h-7v-7z"/>
                        </svg>
                    </div>                    <div class="nav-item" onclick="switchTab('notifications')" style="position: relative;">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        <!-- Badge s·ªë th√¥ng b√°o ch∆∞a ƒë·ªçc -->
                        <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold hidden">0</span>
                    </div>
                    
                    <div class="nav-item" onclick="switchTab('bills')">
                        <div class="wallet-float">
                            <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center" style="box-shadow: 0 4px 12px rgba(5, 150, 105, 0.4);">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-item" onclick="switchTab('feedback')">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 11l3 3 3-3"/>
                        </svg>
                    </div>
                    
                    <div class="nav-item" onclick="switchTab('profile')">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"/>
                            <path stroke-linecap="round" d="M8 14s1.5 2 4 2 4-2 4-2M9 9h.01M15 9h.01"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Screen -->
        <div id="notifications-screen" class="hidden">
            <div class="content-wrapper flex flex-col">
                <!-- Header -->
                <div class="px-4 py-4 flex-shrink-0 bg-green-600 text-white h-16 flex items-center sticky top-0 z-50 shadow-lg">
                    <div class="relative flex justify-end items-center w-full">
                        <div class="absolute inset-0 flex items-center justify-center">
                            <h1 class="text-xl font-bold text-white" id="notifications-title">H·ªôp th∆∞</h1>
                        </div>
                        <button onclick="markAllAsRead()" class="text-white w-8 h-8 flex items-center justify-center relative z-10">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 7l2 2 4-4"/>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 7h9"/>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 17l2 2 4-4"/>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 17h9"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Notifications List -->
                <div class="flex-1 overflow-y-auto bg-white pb-32" id="notifications-list" style="min-height: 100%;">
                    <!-- Loading skeleton -->
                    <div class="animate-pulse">
                        <div class="h-16 bg-gray-200 rounded-lg mb-3"></div>
                        <div class="h-16 bg-gray-200 rounded-lg mb-3"></div>
                        <div class="h-16 bg-gray-200 rounded-lg"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Issue Screen -->
        <div id="create-issue-screen" class="hidden">
            <div class="content-wrapper flex flex-col">
                <!-- Header -->
                <div class="px-4 pt-4 pb-4 flex-shrink-0 bg-green-600 text-white">
                    <div class="flex items-center justify-center relative">
                        <h1 class="text-xl font-bold" id="issues-header-title">Ph·∫£n √°nh</h1>
                        <button onclick="showIssueForm()" class="absolute right-0 w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Empty State (shown when no issues) -->
                <div id="empty-issues-state" class="flex-1 overflow-y-auto bg-gray-50 flex flex-col" style="min-height: 100%;">
                    <!-- Illustration -->
                    <div class="flex-1 flex justify-center items-center px-6 pt-2 pb-2">
                        <img src="images/plumber-illustration.png" 
                             alt="Th·ª£ s·ª≠a ch·ªØa" 
                             class="issue-illustration">
                    </div>
                    
                    <!-- Bottom Text and Button Section -->
                    <div class="text-center px-6 pb-32 pt-2">
                        <h2 class="issue-title" id="need-help-title">
                            B·∫°n ƒëang c·∫ßn tr·ª£ gi√∫p ch·ª©? ü§î
                        </h2>
                        <p class="issue-description" id="help-text">
                            N·∫øu b·∫°n g·∫∑p ph·∫£i v·∫•n ƒë·ªÅ, h√£y t·∫°o ph·∫£n √°nh ƒë·ªÉ qu·∫£n l√Ω t√≤a nh√† n·∫Øm th√¥ng tin v√† x·ª≠ l√Ω ngay cho b·∫°n nh√©!
                        </p>
                        
                        <!-- Create Issue Button -->
                        <button onclick="showIssueForm()" class="bg-green-600 hover:bg-green-700 text-white py-2.5 px-6 rounded-xl font-medium text-sm transition-colors w-40 mx-auto block" id="create-feedback-btn">
                            T·∫°o ph·∫£n √°nh
                        </button>
                    </div>
                </div>

                <!-- Issues List (shown when there are issues) -->
                <div id="issues-list-container" class="flex-1 overflow-y-auto bg-gray-50 px-4 py-4 hidden">
                    <div id="issues-list" class="space-y-3 pb-20">
                        <!-- Issues will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Issue Form Screen -->
        <div id="issue-form-screen" class="hidden">
            <div class="content-wrapper flex flex-col">
                <!-- Header -->
                <div class="px-4 pt-4 pb-4 flex-shrink-0 bg-green-600 text-white">
                    <div class="flex items-center justify-between">
                        <button onclick="backToIssueScreen()" class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <h1 class="text-xl font-bold" id="report-issue-title">B√°o c√°o s·ª± c·ªë</h1>
                        <div class="w-10 h-10"></div>
                    </div>
                </div>

                <!-- Form Content -->
                <div class="flex-1 overflow-y-auto bg-white px-3 py-2 pb-32" style="min-height: 100%;">
                    <div class="bg-white rounded-xl p-3 shadow-sm">
                        <h2 class="text-base font-semibold mb-3 text-gray-900" id="issue-info-title">Th√¥ng tin s·ª± c·ªë</h2>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1.5" id="description-label">M√¥ t·∫£ chi ti·∫øt *</label>
                                <textarea id="issue-description" rows="4" placeholder="M√¥ t·∫£ chi ti·∫øt v·∫•n ƒë·ªÅ b·∫°n g·∫∑p ph·∫£i..." 
                                          class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none text-sm"></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1.5" id="images-label">H√¨nh ·∫£nh (0/5)</label>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                                    <div class="mb-2">
                                        <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                    </div>
                                    <p class="text-xs text-gray-600 mb-1.5" id="add-image-text">Th√™m ·∫£nh</p>
                                    <input type="file" id="issue-images" multiple accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                                    <button type="button" onclick="document.getElementById('issue-images').click()" class="text-green-600 hover:text-green-700 text-xs font-medium" id="choose-device-btn">
                                        Ch·ªçn t·ª´ thi·∫øt b·ªã
                                    </button>
                                </div>
                                <div id="image-preview" class="mt-2 grid grid-cols-3 gap-2"></div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 mt-4">
                            <button onclick="submitIssue()" class="flex-1 bg-green-600 text-white py-2.5 px-3 rounded-lg hover:bg-green-700 font-semibold text-sm" id="submit-issue-btn">
                                G·ª≠i s·ª± c·ªë
                            </button>
                            <button onclick="backToIssueScreen()" class="px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium text-sm" id="cancel-btn">
                                H·ªßy
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Payment Screen -->
        <div id="qr-payment-screen" class="hidden">
            <div class="content-wrapper flex flex-col">
                <!-- Header -->
                <div class="px-4 pt-4 pb-4 flex-shrink-0 bg-green-600 text-white">
                    <div class="flex items-center justify-between">
                        <button onclick="closeQRPayment()" class="w-8 h-8 flex items-center justify-center">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <h1 class="text-xl font-bold" id="payment-title">THANH TO√ÅN</h1>
                        <div class="w-8 h-8"></div> <!-- Spacer -->
                    </div>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto bg-white px-4 py-4">
                    <!-- QR Code Container -->
                    <div class="bg-white rounded-xl p-4 shadow-sm mb-4">
                        <div class="border-4 border-green-600 rounded-lg p-3 mb-4 w-64 h-64 mx-auto flex items-center justify-center">
                            <img id="payment-qr-image" src="" alt="QR Code" class="w-full h-full object-contain">
                        </div>
                        
                        <!-- Download Button -->
                        <button onclick="downloadQR()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold mb-4 flex items-center justify-center hover:bg-green-700 transition-colors">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                            </svg>
                            <span id="download-text">üíæ L∆∞u v√†o th∆∞ vi·ªán</span>
                        </button>
                    </div>
                    
                    <!-- Payment Info -->
                    <div class="bg-white rounded-xl p-4 shadow-sm space-y-4">
                        <div>
                            <p class="text-sm text-gray-600 mb-1" id="account-name-label">T√™n t√†i kho·∫£n</p>
                            <p id="payment-account-name" class="text-base font-bold text-gray-900"></p>
                        </div>
                        
                        <div>
                            <p class="text-sm text-gray-600 mb-1" id="account-number-label">S·ªë t√†i kho·∫£n</p>
                            <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                                <p id="payment-account-number" class="text-base font-bold text-gray-900"></p>
                                <button onclick="copyAccountNumber()" class="text-green-600 font-medium text-sm" id="copy-account-btn">Sao ch√©p</button>
                            </div>
                        </div>
                        
                        <div>
                            <p class="text-sm text-gray-600 mb-1" id="amount-label">S·ªë ti·ªÅn</p>
                            <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                                <p id="payment-amount" class="text-base font-bold text-gray-900"></p>
                                <button onclick="copyAmount()" class="text-green-600 font-medium text-sm" id="copy-amount-btn">Sao ch√©p</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Screen -->
        <div id="profile-screen" class="hidden">
            <div class="content-wrapper flex flex-col">
                <!-- Header -->
                <div class="px-4 py-4 flex-shrink-0 bg-green-600 text-white h-16 flex items-center justify-center">
                    <h1 class="text-xl font-bold">C√° nh√¢n</h1>
                </div>
                
                <!-- Profile Content -->
                <div class="flex-1 overflow-hidden bg-gray-50 px-3 py-2 pb-32" style="min-height: 100%;">
                    <!-- Avatar Section -->
                    <div class="bg-white rounded-xl p-4 shadow-sm mb-3 text-center">
                        <div class="relative inline-block mb-2">
                            <img id="profile-avatar" src="/icon-nen-xanh.jpg" alt="Avatar" class="w-32 h-32 rounded-full border-4 border-green-100 shadow-lg">
                            <button onclick="changeAvatar()" class="absolute bottom-0 right-0 w-10 h-10 bg-green-600 rounded-full flex items-center justify-center shadow-lg">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </button>
                            <input type="file" id="avatar-input" accept="image/*" class="hidden" onchange="handleAvatarChange(this)">
                        </div>
                        <h2 id="profile-name" class="text-lg font-bold text-gray-800">ƒêang t·∫£i...</h2>
                    </div>

                    <!-- Personal Info Section -->
                    <div class="bg-white rounded-xl p-3 shadow-sm mb-3">
                        <h3 class="text-base font-semibold text-gray-800 mb-3 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                            </svg>
                            <span class="translate" data-key="personalInfo">Th√¥ng tin c√° nh√¢n</span>
                        </h3>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-gray-600 text-sm translate" data-key="fullName">H·ªç t√™n:</span>
                                <span id="profile-fullname" class="font-semibold text-gray-800 text-sm">ƒêang t·∫£i...</span>
                            </div>
                            <div class="flex justify-between items-center py-2">
                                <span class="text-gray-600 text-sm translate" data-key="phoneNumber">S·ªë ƒëi·ªán tho·∫°i:</span>
                                <span id="profile-phone" class="font-semibold text-gray-800 text-sm">ƒêang t·∫£i...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Language Section -->
                    <div class="bg-white rounded-xl p-2 shadow-sm mb-2">
                        <h3 class="text-sm font-semibold text-gray-800 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7 2a1 1 0 011 1v1h3a1 1 0 110 2H9.578a18.87 18.87 0 01-1.724 4.78c.29.354.596.696.914 1.026a1 1 0 11-1.44 1.389c-.188-.196-.373-.396-.554-.6a19.098 19.098 0 01-3.107 3.567 1 1 0 01-1.334-1.49 17.087 17.087 0 003.13-3.733 18.992 18.992 0 01-1.487-2.494 1 1 0 111.79-.89c.234.47.489.928.764 1.372.417-.934.752-1.913.997-2.927H3a1 1 0 110-2h3V3a1 1 0 011-1zm6 6a1 1 0 01.894.553l2.991 5.982a.869.869 0 01.02.037l.99 1.98a1 1 0 11-1.79.895L15.383 16h-4.764l-.724 1.447a1 1 0 11-1.788-.894l.99-1.98.019-.038 2.99-5.982A1 1 0 0113 8zm-1.382 6h2.764L13 11.236 11.618 14z" clip-rule="evenodd"/>
                            </svg>
                            <span id="language-header" class="translate" data-key="language">Ng√¥n ng·ªØ</span>
                        </h3>
                        <div class="space-y-1">
                            <label class="flex items-center py-1 cursor-pointer" onclick="switchLanguage('vi')">
                                <input type="radio" name="language" value="vi" class="mr-2" checked>
                                <span class="flex items-center text-sm">
                                    <span class="text-xl mr-2">üáªüá≥</span>
                                    <span>Ti·∫øng Vi·ªát</span>
                                </span>
                            </label>
                            <label class="flex items-center py-2 cursor-pointer" onclick="switchLanguage('en')">
                                <input type="radio" name="language" value="en" class="mr-3">
                                <span class="flex items-center">
                                    <span class="text-2xl mr-2">ÔøΩÔøΩ</span>
                                    <span>English</span>
                                </span>
                            </label>
                        </div>
                    </div>

                    <!-- Logout Section -->
                    <div class="bg-white rounded-xl p-2 shadow-sm">
                        <button onclick="logout()" class="w-full flex items-center justify-center py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                            </svg>
                            <span class="text-sm font-semibold">ƒêƒÉng xu·∫•t</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bill Detail Screen -->
        <div id="bill-detail-screen" class="hidden bg-gray-100 min-h-screen">
            <!-- Header -->
            <div class="bg-green-600 text-white px-4 py-4 flex items-center justify-between sticky top-0 z-10">
                <button onclick="closeBillDetail()" class="w-8 h-8 flex items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <h1 class="text-xl font-bold" id="bill-detail-title">Chi ti·∫øt h√≥a ƒë∆°n</h1>
                <div class="w-8 h-8"></div> <!-- Spacer -->
            </div>

            <!-- Content -->
            <div class="px-4 py-4 pb-20">
                <div id="bill-detail-content" class="bg-white rounded-xl p-4 shadow-sm">
                    <!-- Bill detail content -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js';
        import { getFirestore, collection, query, where, getDocs, orderBy, onSnapshot, addDoc, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.17.1/firebase-storage.js';

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyA2m1K7pijNC1yirw_t36Rc3HnzCsD8pCs",
            authDomain: "nha-tro-53ca7.firebaseapp.com",
            projectId: "nha-tro-53ca7",
            storageBucket: "nha-tro-53ca7.firebasestorage.app",
            messagingSenderId: "415886594203",
            appId: "1:415886594203:web:f3cda09037973176c9763e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        let currentUser = null;
        let customerData = null;
        let bills = [];
        let buildings = [];
        let contracts = [];
        let services = [];
        
        // üö® PERFORMANCE MONITOR - Track excessive function calls
        const perfMon = {
            calls: {},
            track(fn) {
                this.calls[fn] = (this.calls[fn] || 0) + 1;
                if (this.calls[fn] % 20 === 0) {
                    console.warn(`üêå ${fn} called ${this.calls[fn]} times - possible performance issue!`);
                }
            }
        };
        
        // üíæ DOM CACHE - Cache frequently used elements
        let domCache = {
            navItems: null,
            init() {
                this.navItems = document.querySelectorAll('.nav-item');
            },
            getNavItems() {
                if (!this.navItems) this.init();
                return this.navItems;
            }
        };

        // Language System - Only translate labels, not data values
        const translations = {
            vi: {
                // Navigation
                home: "Trang ch·ªß",
                bills: "H√≥a ƒë∆°n",
                notifications: "H·ªôp th∆∞",
                issues: "S·ª± c·ªë",
                profile: "C√° nh√¢n",
                
                // Home screen
                welcome: "Xin ch√†o",
                roomInfo: "Th√¥ng tin ph√≤ng",
                monthlyRent: "Ti·ªÅn thu√™ v√† c√°c kho·∫£n ph√≠",
                tenantInfo: "Ng∆∞·ªùi thu√™",
                
                // Bills screen
            billsTitle: "H√≥a ƒë∆°n",
            month: "Th√°ng",
            amount: "S·ªë ti·ªÅn",
            status: "Tr·∫°ng th√°i",
            paid: "ƒê√£ thanh to√°n",
            unpaid: "Ch∆∞a thanh to√°n",
            billDetail: "Chi ti·∫øt h√≥a ƒë∆°n",
            
            // Bill detail labels
            roomLabel: "Ph√≤ng",
            billNumber: "S·ªë h√≥a ƒë∆°n",
            createdDate: "Ng√†y t·∫°o",
            dueDate: "H·∫°n thanh to√°n",
            serviceDetails: "Chi ti·∫øt d·ªãch v·ª•",
            unitPrice: "ƒê∆°n gi√°",
            reading: "Ch·ªâ s·ªë",
            quantity: "S·ªë l∆∞·ª£ng",
            total: "T·ªïng c·ªông",
            paid_amount: "ƒê√£ thanh to√°n",
            remaining: "C√≤n l·∫°i",
            paidStatus: "ƒê√É THANH TO√ÅN",
            unpaidStatus: "CH∆ØA THANH TO√ÅN",
            payButton: "Thanh to√°n",
            paymentNote: "Vui l√≤ng thanh to√°n ƒë√∫ng h·∫°n",
            thankNote: "C·∫£m ∆°n b·∫°n ƒë√£ thanh to√°n ƒë√∫ng h·∫°n",                // Notifications screen
                notificationsTitle: "H·ªôp th∆∞",
                markAllRead: "ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc",
                billNotificationTitle: "Th√¥ng b√°o h√≥a ƒë∆°n",
                
                // Issues screen
                issuesTitle: "S·ª± c·ªë ƒë√£ b√°o",
                reportIssue: "B√°o s·ª± c·ªë",
                description: "M√¥ t·∫£",
                submitIssue: "G·ª≠i b√°o c√°o",
                issueSubmitted: "ƒê√£ g·ª≠i b√°o c√°o s·ª± c·ªë th√†nh c√¥ng!",
                needHelp: "B·∫°n ƒëang c·∫ßn tr·ª£ gi√∫p ch·ª© ?",
                createFeedback: "T·∫°o ph·∫£n √°nh",
                helpText: "N·∫øu b·∫°n g·∫∑p ph·∫£i v·∫•n ƒë·ªÅ, h√£y t·∫°o ph·∫£n √°nh ƒë·ªÉ qu·∫£n l√Ω to√† nh√† n·∫Øm th√¥ng tin v√† x·ª≠ l√Ω ngay cho b·∫°n nh√©!",
                
                // Issue form
                reportIssueTitle: "B√°o c√°o s·ª± c·ªë",
                issueInfo: "Th√¥ng tin s·ª± c·ªë",
                detailedDescription: "M√¥ t·∫£ chi ti·∫øt",
                descriptionPlaceholder: "M√¥ t·∫£ chi ti·∫øt v·∫•n ƒë·ªÅ b·∫°n g·∫∑p ph·∫£i...",
                images: "H√¨nh ·∫£nh",
                addImage: "Th√™m ·∫£nh",
                chooseFromDevice: "Ch·ªçn t·ª´ thi·∫øt b·ªã",
                submitIssueBtn: "G·ª≠i s·ª± c·ªë",
                cancel: "H·ªßy",
                
                // Issue status
                statusPending: "Ch·ªù x·ª≠ l√Ω",
                statusInProgress: "ƒêang x·ª≠ l√Ω",
                statusCompleted: "ƒê√£ ho√†n th√†nh",
                statusCancelled: "ƒê√£ h·ªßy",
                
                // Issue notification
                issueFromRoom: "S·ª± c·ªë t·ª´ ph√≤ng",
                
                // Profile language section
                languageSection: "Ng√¥n ng·ªØ",
                
                // Profile screen
                profileTitle: "Th√¥ng tin c√° nh√¢n",
                personalInfo: "Th√¥ng tin c√° nh√¢n",
                fullName: "H·ªç t√™n:",
                phoneNumber: "S·ªë ƒëi·ªán tho·∫°i:",
                language: "Ng√¥n ng·ªØ",
                loading: "ƒêang t·∫£i...",
                vietnamese: "Ti·∫øng Vi·ªát",
                english: "English",
                logout: "ƒêƒÉng xu·∫•t",
                
                // Payment screen
                paymentTitle: "THANH TO√ÅN",
                download: "T·∫£i xu·ªëng",
                accountName: "T√™n t√†i kho·∫£n",
                accountNumber: "S·ªë t√†i kho·∫£n",
                amount: "S·ªë ti·ªÅn",
                copy: "Sao ch√©p",
                
                // Common
                close: "ƒê√≥ng",
                save: "L∆∞u",
                loading: "ƒêang t·∫£i..."
            },
            en: {
                // Navigation
                home: "Home",
                bills: "Bills",
                notifications: "Notifications",
                issues: "Issues",
                profile: "Profile",
                
                // Home screen
                welcome: "Hello",
                roomInfo: "Room Information",
                monthlyRent: "Rent and Fees",
                tenantInfo: "Tenant",
                
                // Bills screen
            billsTitle: "Bills",
            month: "Month",
            amount: "Amount",
            status: "Status",
            paid: "Paid",
            unpaid: "Unpaid",
            billDetail: "Bill Details",
            
            // Bill detail labels
            roomLabel: "Room",
            billNumber: "Bill Number",
            createdDate: "Created Date",
            dueDate: "Due Date",
            serviceDetails: "Service Details",
            unitPrice: "Unit Price",
            reading: "Reading",
            quantity: "Quantity",
            total: "Total",
            paid_amount: "Paid",
            remaining: "Remaining",
            paidStatus: "PAID",
            unpaidStatus: "UNPAID",
            payButton: "Pay Now",
            paymentNote: "Please pay on time",
            thankNote: "Thank you for your timely payment",                // Notifications screen
                notificationsTitle: "Notifications",
                markAllRead: "Mark All Read",
                billNotificationTitle: "Bill Notification",
                
                // Issues screen
                issuesTitle: "Reported Issues",
                reportIssue: "Report Issue",
                description: "Description",
                submitIssue: "Submit Report", 
                issueSubmitted: "Issue report submitted successfully!",
                needHelp: "Do you need help?",
                createFeedback: "Create Report",
                helpText: "If you encounter any issues, please create a report so the building management can be informed and handle it promptly for you!",
                
                // Issue form
                reportIssueTitle: "Report Issue",
                issueInfo: "Issue Information",
                detailedDescription: "Detailed Description",
                descriptionPlaceholder: "Describe the issue you encountered in detail...",
                images: "Images",
                addImage: "Add Image",
                chooseFromDevice: "Choose from Device",
                submitIssueBtn: "Submit Issue",
                cancel: "Cancel",
                
                // Issue status
                statusPending: "Pending",
                statusInProgress: "In Progress",
                statusCompleted: "Completed",
                statusCancelled: "Cancelled",
                
                // Issue notification
                issueFromRoom: "Issue from room",
                
                // Profile language section
                languageSection: "Language",
                
                // Profile screen
                profileTitle: "Profile",
                personalInfo: "Personal Information",
                fullName: "Full Name:",
                phoneNumber: "Phone Number:",
                language: "Language",
                loading: "Loading...",
                vietnamese: "Ti·∫øng Vi·ªát",
                english: "English",
                logout: "Logout",
                
                // Payment screen
                paymentTitle: "PAYMENT",
                download: "Download",
                accountName: "Account Name",
                accountNumber: "Account Number",
                amount: "Amount",
                copy: "Copy",
                
                // Common
                close: "Close",
                save: "Save",
                loading: "Loading..."
            }
        };

        let currentLanguage = localStorage.getItem('language') || 'vi';

        function t(key) {
            return translations[currentLanguage]?.[key] || translations.vi[key] || key;
        }

        function switchLanguage(lang) {
            console.log('üåê Switching language to:', lang);
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            
            // Update visual selection state
            document.querySelectorAll('[onclick*="switchLanguage"]').forEach(element => {
                const isSelected = element.onclick.toString().includes(`'${lang}'`);
                if (isSelected) {
                    element.classList.add('bg-green-100', 'border-l-4', 'border-green-500');
                    element.classList.remove('hover:bg-gray-50');
                } else {
                    element.classList.remove('bg-green-100', 'border-l-4', 'border-green-500');
                    element.classList.add('hover:bg-gray-50');
                }
            });
            
            // Update all UI elements
            updateAllUI();
            
            // Force re-render content with new language
            // console.log('üîÑ Force re-rendering content...');
            if (notifications.length > 0) {
                renderNotificationsList();
            }
            if (bills.length > 0) {
                renderBillsList();
            }
            
            // Re-render issues list if exists
            const issuesContainer = document.getElementById('issues-list');
            if (issuesContainer && typeof issues !== 'undefined' && issues.length > 0) {
                renderIssuesList(issues);
            }
            
            // Update home screen content if needed
            if (typeof renderHomeData === 'function') {
                renderHomeData();
            }
        }

        function updateAllUI() {
            // Update navigation labels
            updateNavigationLabels();
            
            // Update all screens - detect current active screen
            const screens = ['home', 'bills', 'notifications', 'feedback', 'profile'];
            
            // Try to find active screen
            let activeScreen = null;
            for (const screen of screens) {
                const element = document.querySelector(`#${screen}-screen`);
                if (element && !element.classList.contains('hidden') && !element.style.display.includes('none')) {
                    activeScreen = screen;
                    console.log('üéØ Found active screen:', screen, element);
                    break;
                }
            }
            
            // Force update all screens for language change
            console.log('üîÑ Force updating all screens for language change');
            updateHomeScreen();
            updateBillsScreen();
            updateNotificationsScreen();
            updateIssuesScreen();
            updateProfileScreen();
            updatePaymentScreen();
            updateBillDetailScreen();
            updateIssueFormScreen();
            
            // If we found an active screen, update it again
            if (activeScreen) {
                console.log('üéØ Additionally updating active screen:', activeScreen);
                updateScreenContent(activeScreen);
            }
        }

        function updateNavigationLabels() {
            // Update bottom navigation text (they are in spans, not direct text)
            const navItems = document.querySelectorAll('.nav-item');
            const labels = ['home', 'notifications', 'bills', 'feedback', 'profile'];
            
            // Note: Your navigation doesn't have text labels, only icons
            // If you want to add labels, you can modify the HTML structure
        }

        function updateScreenContent(screenId) {
            switch(screenId) {
                case 'home':
                    updateHomeScreen();
                    break;
                case 'bills':
                    updateBillsScreen();
                    break;
                case 'notifications':
                    updateNotificationsScreen();
                    break;
                case 'feedback':
                case 'issues':
                    updateIssuesScreen();
                    break;
                case 'profile':
                    updateProfileScreen();
                    break;
                case 'payment':
                    updatePaymentScreen();
                    break;
                case 'bill-detail':
                    updateBillDetailScreen();
                    break;
                case 'create-issue':
                    updateIssueFormScreen();
                    break;
            }
        }

        function updateHomeScreen() {
            // Update headers with IDs - welcome message removed
            const roomInfoHeader = document.getElementById('room-info-header');
            if (roomInfoHeader) {
                roomInfoHeader.textContent = t('roomInfo');
            }
            
            const rentHeader = document.getElementById('rent-header');
            if (rentHeader) {
                rentHeader.textContent = t('monthlyRent');
            }
            
            const tenantHeader = document.getElementById('tenant-header');
            if (tenantHeader) {
                tenantHeader.textContent = t('tenantInfo');
            }
            
            // Update profile header
            const profileHeader = document.querySelector('#profile-screen h1');
            if (profileHeader) {
                profileHeader.textContent = t('profileTitle');
            }
        }

        function updateBillsScreen() {
            // console.log('üí≥ Updating bills screen, current language:', currentLanguage);
            
            const titleEl = document.getElementById('bills-title');
            if (titleEl) {
                const newTitle = t('billsTitle');
                console.log('üè∑Ô∏è Updating bills title from', titleEl.textContent, 'to', newTitle);
                titleEl.textContent = newTitle;
            }
            
            // Re-render bills to update status labels and service names
            // console.log('üîÑ Re-rendering bills list...');
            if (bills.length > 0) {
                renderBillsList();
            }
        }

        function updateNotificationsScreen() {
            // console.log('üìß Updating notifications screen, current language:', currentLanguage);
            
            const titleEl = document.querySelector('#notifications-title');
            if (titleEl) {
                const newTitle = t('notificationsTitle');
                console.log('üè∑Ô∏è Updating title from', titleEl.textContent, 'to', newTitle);
                titleEl.textContent = newTitle;
            }
            
            // Re-render notifications to update content  
            // console.log('üîÑ Re-rendering notifications list...');
            renderNotificationsList();
        }

        function updateIssuesScreen() {
            // C·∫≠p nh·∫≠t title header
            const titleEl = document.getElementById('issues-header-title');
            if (titleEl) {
                titleEl.textContent = t('issues');
            }
            
            // C·∫≠p nh·∫≠t "B·∫°n ƒëang c·∫ßn tr·ª£ gi√∫p ch·ª©?"
            const helpTitleEl = document.getElementById('need-help-title');
            if (helpTitleEl) {
                helpTitleEl.textContent = t('needHelp');
            }
            
            // C·∫≠p nh·∫≠t text m√¥ t·∫£
            const helpTextEl = document.getElementById('help-text');
            if (helpTextEl) {
                helpTextEl.textContent = t('helpText');
            }
            
            // C·∫≠p nh·∫≠t n√∫t "T·∫°o ph·∫£n √°nh"
            const createFeedbackBtn = document.getElementById('create-feedback-btn');
            if (createFeedbackBtn) {
                createFeedbackBtn.textContent = t('createFeedback');
            }
            
            const helpDescEl = document.getElementById('help-description');
            if (helpDescEl) {
                helpDescEl.textContent = t('helpText');
            }
            
            const createBtn = document.getElementById('create-feedback-btn');
            if (createBtn) {
                createBtn.textContent = t('createFeedback');
            }
        }

        function updateProfileScreen() {
            // Update title
            const titleEl = document.querySelector('#profile-screen h1');
            if (titleEl) {
                titleEl.textContent = t('profileTitle');
            }
            
            // Update all elements with translate class in profile screen
            const translateElements = document.querySelectorAll('#profile-screen .translate');
            translateElements.forEach(element => {
                const key = element.getAttribute('data-key');
                if (key && translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });
            
            // Update language section header using ID selector
            const languageHeaderSpan = document.getElementById('language-header');
            if (languageHeaderSpan) {
                languageHeaderSpan.textContent = t('languageSection');
            }
            
            const logoutBtn = document.querySelector('#profile-screen .text-red-600 span');
            if (logoutBtn) {
                logoutBtn.textContent = t('logout');
            }
        }

        function updatePaymentScreen() {
            console.log('üí≥ Updating payment screen, current language:', currentLanguage);
            
            const titleEl = document.getElementById('payment-title');
            if (titleEl) {
                titleEl.textContent = t('paymentTitle');
            }
            
            const downloadEl = document.getElementById('download-text');
            if (downloadEl) {
                downloadEl.textContent = t('download');
            }
            
            const accountNameLabel = document.getElementById('account-name-label');
            if (accountNameLabel) {
                accountNameLabel.textContent = t('accountName');
            }
            
            const accountNumberLabel = document.getElementById('account-number-label');
            if (accountNumberLabel) {
                accountNumberLabel.textContent = t('accountNumber');
            }
            
            const amountLabel = document.getElementById('amount-label');
            if (amountLabel) {
                amountLabel.textContent = t('amount');
            }
            
            const copyBtns = document.querySelectorAll('#copy-account-btn, #copy-amount-btn');
            copyBtns.forEach(btn => {
                btn.textContent = t('copy');
            });
        }

        // Initialize app
        async function initApp() {
            try {
                await signInAnonymously(auth);
                
                const savedPhone = localStorage.getItem('userPhone');
                if (savedPhone) {
                    const customer = await loadCustomerData(savedPhone);
                    if (customer) {
                        await showHome(customer);
                        updateAppInteractionState(); // Enable interaction n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p
                        return;
                    }
                }
                
                showLogin();
                updateAppInteractionState(); // Disable interaction n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
            } catch (error) {
                console.error('Init error:', error);
                showLogin();
                updateAppInteractionState(); // Disable interaction khi c√≥ l·ªói
            } finally {
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        async function loadCustomerData(phone) {
            try {
                const q = query(collection(db, 'customers'), where('phone', '==', phone));
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    return { id: doc.id, ...doc.data() };
                }
                return null;
            } catch (error) {
                console.error('Error loading customer:', error);
                return null;
            }
        }

        async function loadUserData(customerId) {
            try {
                // console.log('Loading data for customer ID:', customerId);
                
                // Load t·ª´ cache tr∆∞·ªõc (n·∫øu c√≥)
                const cachedData = localStorage.getItem(`userData_${customerId}`);
                if (cachedData) {
                    const parsed = JSON.parse(cachedData);
                    buildings = parsed.buildings || [];
                    contracts = parsed.contracts || [];
                    // CH·ªà LOAD H√ìA ƒê∆†N ƒê√É DUY·ªÜT T·ª™ CACHE
                    bills = (parsed.bills || []).filter(bill => bill.approved === true);
                    // console.log('‚úÖ Loaded from cache - approved bills only:', bills.length);
                    renderHomeData(); // Hi·ªán data cache tr∆∞·ªõc
                }
                
                // Load song song ƒë·ªÉ nhanh h∆°n
                const [contractsSnapshot, billsSnapshot] = await Promise.all([
                    getDocs(query(collection(db, 'contracts'), where('representativeId', '==', customerId))),
                    getDocs(query(collection(db, 'bills'), where('customerId', '==', customerId)))
                ]);
                
                contracts = contractsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // CH·ªà LOAD H√ìA ƒê∆†N ƒê√É DUY·ªÜT
                bills = billsSnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(bill => bill.approved === true);
                // console.log('‚úÖ Loaded bills from Firestore - approved only:', bills.length);
                
                // Load services if needed
                const servicesSnapshot = await getDocs(collection(db, 'services'));
                services = servicesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load buildings t·ª´ c·∫£ bills v√† contracts
                const buildingIdsFromBills = bills.map(b => b.buildingId).filter(id => id);
                const buildingIdsFromContracts = contracts.map(c => c.buildingId).filter(id => id);
                const buildingIds = [...new Set([...buildingIdsFromBills, ...buildingIdsFromContracts])];
                
                console.log('üè¢ Building IDs to load:', buildingIds);
                console.log('üìã Contracts:', contracts.map(c => ({ id: c.id, buildingId: c.buildingId })));
                
                if (buildingIds.length > 0) {
                    const buildingsPromises = buildingIds.map(id => 
                        getDocs(query(collection(db, 'buildings'), where('__name__', '==', id)))
                    );
                    const buildingsResults = await Promise.all(buildingsPromises);
                    buildings = buildingsResults.flatMap(snap => 
                        snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    );
                    console.log('üè¢ Loaded buildings:', buildings.map(b => ({ id: b.id, address: b.address })));
                } else {
                    buildings = [];
                    console.log('‚ö†Ô∏è No building IDs found in contracts or bills');
                }
                
                // L∆∞u cache
                localStorage.setItem(`userData_${customerId}`, JSON.stringify({
                    buildings, contracts, bills, timestamp: Date.now()
                }));
                
                // console.log('‚úÖ Loaded fresh data - Bills:', bills.length);

            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // ‚ö° OPTIMIZED: Function ƒë·ªÉ ch·ªâ reload bills (d√πng cho optimistic update)
        async function reloadBillsOnly(customerId) {
            try {
                console.log('üîÑ Reloading bills only for customer:', customerId);
                const billsSnapshot = await getDocs(query(collection(db, 'bills'), where('customerId', '==', customerId)));
                bills = billsSnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(bill => bill.approved === true);
                
                console.log('‚úÖ Bills reloaded - approved only:', bills.length);
                
                // Update cache v·ªõi bills m·ªõi
                const cachedData = localStorage.getItem(`userData_${customerId}`);
                if (cachedData) {
                    const parsed = JSON.parse(cachedData);
                    parsed.bills = bills;
                    parsed.timestamp = Date.now();
                    localStorage.setItem(`userData_${customerId}`, JSON.stringify(parsed));
                }
                
                // Re-render UI
                renderHomeData();
                updateBillsScreen();
                
            } catch (error) {
                console.error('‚ùå Error reloading bills:', error);
            }
        }

        // üíæ CACHE CONSTANTS
        const CACHE_VERSION = '1.0';
        const CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24 gi·ªù
        
        // Real-time listeners cho th√¥ng b√°o - ƒê√É T·ªêI ∆ØU CACHE
        let activeListeners = []; // L∆∞u c√°c listener ƒë·ªÉ cleanup
        
        /**
         * üíæ L∆∞u data user v√†o m√°y t√≠nh
         */
        function saveUserDataToCache(customerId, data) {
            try {
                const cacheData = {
                    version: CACHE_VERSION,
                    timestamp: Date.now(),
                    customerId: customerId,
                    data: data
                };
                localStorage.setItem(`n_home_user_${customerId}`, JSON.stringify(cacheData));
                console.log(`üíæ ƒê√£ l∆∞u data user ${customerId} v√†o m√°y t√≠nh`);
            } catch (error) {
                console.error('‚ùå L·ªói l∆∞u cache:', error);
            }
        }
        
        /**
         * üìñ ƒê·ªçc data user t·ª´ m√°y t√≠nh
         */
        function loadUserDataFromCache(customerId) {
            try {
                const cached = localStorage.getItem(`n_home_user_${customerId}`);
                if (!cached) return null;
                
                const cacheData = JSON.parse(cached);
                
                // Ki·ªÉm tra version v√† h·∫°n s·ª≠ d·ª•ng
                if (cacheData.version !== CACHE_VERSION || 
                    (Date.now() - cacheData.timestamp) > CACHE_EXPIRY) {
                    localStorage.removeItem(`n_home_user_${customerId}`);
                    return null;
                }
                
                console.log(`üìñ Load data user ${customerId} t·ª´ m√°y t√≠nh (${new Date(cacheData.timestamp).toLocaleString()})`);
                return cacheData.data;
                
            } catch (error) {
                console.error('‚ùå L·ªói ƒë·ªçc cache:', error);
                return null;
            }
        }
        
        function setupRealtimeListeners(customerId) {
            console.log(`üöÄ Setup listeners cho user: ${customerId}`);
            
            // Cleanup listeners c≈© tr∆∞·ªõc
            activeListeners.forEach(unsubscribe => {
                if (typeof unsubscribe === 'function') {
                    unsubscribe();
                }
            });
            activeListeners = [];
            
            // üíæ B∆Ø·ªöC 1: Th·ª≠ load t·ª´ cache tr∆∞·ªõc
            const cachedData = loadUserDataFromCache(customerId);
            if (cachedData) {
                console.log('‚ö° Hi·ªÉn th·ªã data t·ª´ cache ngay');
                // Load data t·ª´ cache
                bills = cachedData.bills || [];
                notifications = cachedData.notifications || [];
                
                // üîÑ MIGRATION: Chuy·ªÉn old notifications sang unified system (1 l·∫ßn duy nh·∫•t)
                const userPhone = localStorage.getItem('userPhone');
                if (userPhone && notifications.length === 0) {
                    const oldNotifications = localStorage.getItem(`notifications_${userPhone}`);
                    if (oldNotifications) {
                        try {
                            const parsed = JSON.parse(oldNotifications);
                            if (Array.isArray(parsed) && parsed.length > 0) {
                                notifications = parsed;
                                console.log('üîÑ Migrated', notifications.length, 'old notifications to unified system');
                                // Save to unified cache v√† x√≥a old storage
                                saveUserDataToCache(customerId, { bills, notifications, timestamp: Date.now() });
                                localStorage.removeItem(`notifications_${userPhone}`);
                            }
                        } catch (e) {
                            console.log('Error migrating old notifications:', e);
                        }
                    }
                }
                
                // Hi·ªÉn th·ªã ngay
                renderHomeData();
                renderBillsList();
                renderNotificationsList();
                // updateNotificationBadge(); // ƒê√£ g·ªçi trong renderNotificationsList()
            }
            
            // 1. L·∫ÆNG NGHE H√ìA ƒê∆†N - CH·ªà HI·ªÇN TH·ªä H√ìA ƒê∆†N ƒê√É DUY·ªÜT (b·ªè orderBy)
            const billsQuery = query(
                collection(db, 'bills'), 
                where('customerId', '==', customerId)
                // B·ªè orderBy ƒë·ªÉ tr√°nh index error, s·∫Ω sort ·ªü client
            );
            
            let isFirstBillLoad = true;
            
            const billsUnsubscribe = onSnapshot(billsQuery, (snapshot) => {
                console.log(`üìä Bills changes: ${snapshot.docChanges().length} reads`);
                
                if (isFirstBillLoad) {
                    // N·∫øu ƒë√£ c√≥ cache th√¨ skip load l·∫ßn ƒë·∫ßu
                    if (cachedData) {
                        isFirstBillLoad = false;
                        return;
                    }
                    
                    bills = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(bill => bill.approved === true)
                        .sort((a, b) => new Date(b.createdAt?.toDate?.() || b.createdAt || 0) - new Date(a.createdAt?.toDate?.() || a.createdAt || 0));
                    renderHomeData();
                    renderBillsList();
                    isFirstBillLoad = false;
                    
                    // üíæ L∆∞u v√†o cache
                    saveUserDataToCache(customerId, { 
                        bills, 
                        notifications,
                        timestamp: Date.now()
                    });
                    return;
                }
                
                // Real-time update
                const newBills = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(bill => bill.approved === true)
                    .sort((a, b) => new Date(b.createdAt?.toDate?.() || b.createdAt || 0) - new Date(a.createdAt?.toDate?.() || a.createdAt || 0));
                
                // Check for real changes including status updates
                const hasChanges = newBills.length !== bills.length || 
                    !newBills.every(nb => {
                        const ob = bills.find(bill => bill.id === nb.id);
                        return ob && ob.status === nb.status && ob.paid === nb.paid;
                    });
                
                if (hasChanges) {
                    console.log('üîÑ Bills updated - status changes detected');
                    bills = newBills;
                    
                    // Force refresh UI to show payment status changes
                    renderHomeData();
                    renderBillsList();
                    
                    // Update notification badge if needed
                    updateNotificationBadge();
                    
                    // üíæ L∆∞u v√†o cache
                    saveUserDataToCache(customerId, { 
                        bills, 
                        notifications,
                        timestamp: Date.now()
                    });
                }
            }, (error) => {
                console.error('‚ùå Bills listener error:', error.message || error);
            });
            
            activeListeners.push(billsUnsubscribe);

            // 2. L·∫ÆNG NGHE TRANSACTIONS - B·∫ÆT TR√öNG KHI WEB THU TI·ªÄN (b·ªè orderBy)
            const transactionsQuery = query(
                collection(db, 'transactions'),
                where('customerId', '==', customerId),
                where('type', '==', 'income') // Ch·ªâ l·∫Øng nghe phi·∫øu thu, b·ªè orderBy
            );
            
            let isFirstTransactionLoad = true;
            
            onSnapshot(transactionsQuery, (snapshot) => {
                if (isFirstTransactionLoad) {
                    console.log('üí∞ First transaction load, skipping notifications');
                    isFirstTransactionLoad = false;
                    return;
                }
                
                snapshot.docChanges().forEach((change) => {
                    const transactionData = { id: change.doc.id, ...change.doc.data() };
                    
                    if (change.type === 'added' && transactionData.approved && transactionData.billId) {
                        // T·∫°o IN-APP NOTIFICATION (kh√¥ng c√≥ push notification ƒë·ªÉ tr√°nh duplicate)
                        console.log('üí∞ Payment transaction created by admin:', transactionData.id);
                        
                        // T√≠nh t·ªïng ti·ªÅn t·ª´ items
                        const totalAmount = transactionData.items 
                            ? transactionData.items.reduce((sum, item) => sum + (item.amount || 0), 0)
                            : 0;
                            
                        // T·∫°o notification trong app (kh√¥ng push)
                        const notification = {
                            id: `payment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            type: 'payment_received',
                            title: 'X√°c nh·∫≠n thanh to√°n',
                            message: `Ch√∫ng t√¥i ƒë√£ nh·∫≠n ƒë∆∞·ª£c kho·∫£n thanh to√°n ${formatCurrency(totalAmount)} c·ªßa b·∫°n. Xin c·∫£m ∆°n!`,
                            createdAt: new Date(),
                            isRead: false,
                            data: { 
                                transactionId: transactionData.id, 
                                billId: transactionData.billId, 
                                amount: totalAmount 
                            }
                        };
                        
                        // Th√™m v√†o danh s√°ch notifications
                        notifications.unshift(notification);
                        saveNotificationsToStorage();
                        renderNotificationsList();
                        
                        console.log('‚úÖ Created in-app payment notification (no push)');
                    }
                    
                    // üóëÔ∏è X·ª¨ L√ù KHI TRANSACTION B·ªä X√ìA (H·ª¶Y THU TI·ªÄN)
                    if (change.type === 'removed' && transactionData.billId) {
                        console.log('üóëÔ∏è Transaction deleted by admin:', transactionData.id);
                        
                        // T√¨m v√† x√≥a notification c√≥ transactionId t∆∞∆°ng ·ª©ng
                        const initialLength = notifications.length;
                        notifications = notifications.filter(notification => 
                            notification.data?.transactionId !== transactionData.id
                        );
                        
                        if (notifications.length < initialLength) {
                            console.log('‚úÖ ƒê√£ x√≥a th√¥ng b√°o thanh to√°n do h·ªßy thu ti·ªÅn');
                            saveNotificationsToStorage();
                            renderNotificationsList();
                        } else {
                            console.log('‚ÑπÔ∏è Kh√¥ng t√¨m th·∫•y th√¥ng b√°o thanh to√°n ƒë·ªÉ x√≥a');
                        }
                    }
                });
            });

            // 3. L·∫ÆNG NGHE TASKS - B·∫ÆT TR√öNG KHI WEB DUY·ªÜT S·ª∞ C·ªê (toggleTaskStatus)
            const tasksQuery = query(
                collection(db, 'tasks'),
                where('customerId', '==', customerId),
                orderBy('createdAt', 'desc')
            );
            
            let isFirstTaskLoad = true;
            
            onSnapshot(tasksQuery, (snapshot) => {
                if (isFirstTaskLoad) {
                    console.log('üîß First task load, skipping notifications');
                    isFirstTaskLoad = false;
                    return;
                }
                
                snapshot.docChanges().forEach((change) => {
                    const taskData = { id: change.doc.id, ...change.doc.data() };
                    
                    if (change.type === 'modified') {
                        // Y√äU C·∫¶U 4: KHI WEB DUY·ªÜT S·ª∞ C·ªê (status: pending -> completed)
                        if (taskData.status === 'completed') {
                            console.log('‚úÖ Task completed by admin:', taskData.id, taskData.title);
                            createNotification(
                                'issue_resolved',
                                'S·ª± c·ªë ƒë√£ ƒë∆∞·ª£c gi·∫£i quy·∫øt',
                                `S·ª± c·ªë "${taskData.title}" ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω ho√†n th√†nh. C·∫£m ∆°n b·∫°n ƒë√£ ph·∫£n h·ªìi!`,
                                { taskId: taskData.id }
                            );
                        }
                    }
                });
            });

            // 5. L·∫ÆNG NGHE TH√îNG B√ÅO ADMIN - adminNotifications collection
            // L·∫Øng nghe theo buildingId v√† room c·ªßa kh√°ch h√†ng
            console.log('üîç Searching contract for customer:', customerId);
            console.log('üîç Available contracts:', contracts);
            const contract = contracts.find(c => c.representativeId === customerId);
            if (contract) {
                console.log('‚úÖ Contract found! BuildingId:', contract.buildingId, 'Room:', contract.room);
                console.log('üìç Setting up admin notifications for:', contract.buildingId, contract.room);
                // Query ƒë∆°n gi·∫£n ch·ªâ theo buildingId (b·ªè orderBy ƒë·ªÉ tr√°nh index error)
                const adminNotificationsQuery = query(
                    collection(db, 'adminNotifications'),
                    where('buildingId', '==', contract.buildingId)
                );
            
                let isFirstNotificationLoad = true;
                
                console.log('üîó Setting up admin notifications listener...');
                const unsubscribeAdmin = onSnapshot(adminNotificationsQuery, (snapshot) => {
                console.log('üîî Firebase snapshot received, total docs:', snapshot.docs.length);
                
                snapshot.docChanges().forEach((change) => {
                // console.log('üîî Document change detected:', change.type, change.doc.id, 'isFirstLoad:', isFirstNotificationLoad);
                
                const notificationData = { id: change.doc.id, ...change.doc.data() };
                // console.log('üìã Notification data:', notificationData);                    // Skip T·∫§T C·∫¢ th√¥ng b√°o trong l·∫ßn ƒë·∫ßu load (tr√°nh hi·ªÉn th·ªã notification c≈© khi kh·ªüi ƒë·ªông)
                    if (isFirstNotificationLoad) {
                        // console.log('‚è≠Ô∏è Skipping all notifications on first load:', change.doc.id);
                        return;
                    }
                    
                    // Skip modified events ƒë·ªÉ tr√°nh spam khi mark as read
                    if (change.type === 'modified') {
                        // console.log('‚è≠Ô∏è Skipping modified notification:', change.doc.id);
                        return;
                    }
                    
                    // Filter room ·ªü client side (query ch·ªâ filter buildingId)
                    const isForThisRoom = notificationData.room === contract.room;
                    // console.log('üîî Processing notification:', notificationData.type, 'room match:', isForThisRoom);
                    
                    if (change.type === 'added' && isForThisRoom) {
                        // console.log('üîî New customer notification received:', notificationData.type, notificationData.message);
                        
                        // Ki·ªÉm tra xem notification ƒë√£ t·ªìn t·∫°i ch∆∞a
                        const existingNotification = notifications.find(n => n.id === change.doc.id);
                        if (existingNotification) {
                            // console.log('‚è≠Ô∏è Notification already exists, skipping:', change.doc.id);
                            return;
                        }
                        
                        // Hi·ªÉn th·ªã th√¥ng b√°o admin v·ªõi customerMessage
                        const messageToShow = notificationData.customerMessage || notificationData.message;
                        // console.log('üîî Admin notification for customer:', messageToShow);
                        
                        // ‚ö° OPTIMISTIC UPDATE: Reload bills ngay l·∫≠p t·ª©c khi c√≥ th√¥ng b√°o bill approved
                        if (notificationData.type === 'bill_approved' && notificationData.billId && currentUser?.id) {
                            console.log('‚ö° Bill approved notification - triggering IMMEDIATE bills reload');
                            // Reload ONLY bills immediately, kh√¥ng c·∫ßn ch·ªù Firestore listener
                            setTimeout(() => {
                                reloadBillsOnly(currentUser.id);
                            }, 50);
                        }
                        
                        // üö´ FILTER: ·∫®n th√¥ng b√°o t·∫°o s·ª± c·ªë, ch·ªâ hi·ªán nghi·ªám thu
                        const issueCreationTypes = ['customer_issue', 'issue_created', 'issue_reported'];
                        // üö´ FILTER: ·∫®n payment notifications ƒë·ªÉ tr√°nh duplicate v·ªõi transaction listener
                        const paymentTypes = ['payment_received', 'payment_confirmed'];
                        // üö´ FILTER: ·∫®n th√¥ng b√°o thu ti·ªÅn admin (ch·ªâ d√†nh cho web admin)
                        const adminOnlyTypes = ['payment_collected'];
                        const shouldShowNotification = !issueCreationTypes.includes(notificationData.type) && 
                                                     !paymentTypes.includes(notificationData.type) &&
                                                     !adminOnlyTypes.includes(notificationData.type);
                        
                        if (!shouldShowNotification) {
                            console.log('üîá Hiding notification type:', notificationData.type, '(handled elsewhere)');
                            return; // Kh√¥ng hi·ªán th√¥ng b√°o ƒë∆∞·ª£c filter
                        }
                        
                        // Ch·ªâ t·∫°o th√¥ng b√°o n·∫øu ch∆∞a t·ªìn t·∫°i (tr√°nh ghi ƒë√® tr·∫°ng th√°i ƒë√£ ƒë·ªçc)
                        const localExistingNotification = notifications.find(n => n.data?.firebaseId === change.doc.id);
                        if (!localExistingNotification) {
                            console.log('‚úÖ Showing notification type:', notificationData.type);
                            createNotification(
                                notificationData.type,
                                notificationData.title,
                                messageToShow,
                                { 
                                    billId: notificationData.billId,
                                    amount: notificationData.amount,
                                    taskId: notificationData.taskId,
                                    transactionId: notificationData.transactionId,
                                    firebaseId: change.doc.id // L∆∞u Firebase ID ƒë·ªÉ c√≥ th·ªÉ x√≥a sau
                                }
                            );
                        } else {
                            // console.log('‚è≠Ô∏è Notification already exists locally, skipping creation to preserve read status');
                        }
                    }
                    
                    // X·ª≠ l√Ω khi th√¥ng b√°o b·ªã x√≥a tr√™n web admin (Bill b·ªè duy·ªát)
                    if (change.type === 'removed' && isForThisRoom) {
                        console.log('üóëÔ∏è Admin notification deleted:', change.doc.id);
                        
                        // ‚ö° OPTIMISTIC UPDATE: Khi notification b·ªã x√≥a = bill b·ªã b·ªè duy·ªát ‚Üí reload bills ngay
                        if (currentUser?.id) {
                            console.log('‚ö° Notification deleted - triggering IMMEDIATE bills reload (bill unapproved)');
                            setTimeout(() => {
                                reloadBillsOnly(currentUser.id);
                            }, 50);
                        }
                        
                        // T√¨m v√† x√≥a th√¥ng b√°o t∆∞∆°ng ·ª©ng trong app
                        removeNotificationByFirebaseId(change.doc.id);
                    }
                });
                
                // ƒê√°nh d·∫•u ƒë√£ load xong l·∫ßn ƒë·∫ßu
                if (isFirstNotificationLoad) {
                    console.log('‚úÖ First notification load completed');
                    isFirstNotificationLoad = false;
                }
            }, (error) => {
                console.error('‚ùå Admin notifications listener error:', error.message || error);
                // Listener s·∫Ω t·ª± ƒë·ªông reconnect, kh√¥ng c·∫ßn handle th√™m
            });
            
            // L∆∞u unsubscribe function
            activeListeners.push(unsubscribeAdmin);
            console.log('‚úÖ Admin notifications listener added to cleanup list');
            
            } else {
                console.log('‚ùå No contract found for customer:', customerId);
            }
        }

        function showLogin() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('home-screen').classList.add('hidden');
        }

        async function showHome(customer) {
            currentUser = customer;
            customerData = customer; // Set global customerData for language system
            
            // Notifications are loaded from unified cache in setupRealtimeListeners
            // No need for separate loadNotificationsFromStorage() call
            
            // Badge will be updated when notifications are rendered
            // updateNotificationBadge();
            
            // Hi·ªán giao di·ªán ngay, ch∆∞a c·∫ßn ƒë·ª£i data
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('home-screen').classList.remove('hidden');
            
            // Load data trong background
            await loadUserData(customer.id);
            renderHomeData();
            renderBillsList();
            
            // Update UI with current language
            updateAllUI();
            
            // Setup real-time listeners cho th√¥ng b√°o
            setupRealtimeListeners(customer.id);
            
            // T·∫ÆT auto request notification permission - g√¢y spam popup
            // requestNotificationPermission();
        }

        function renderHomeData() {
            perfMon.track('renderHomeData');
            
            // Render building info
            const buildingInfo = document.getElementById('building-info');
            if (contracts.length > 0) {
                const contract = contracts[0];
                const building = buildings.find(b => b.id === contract.buildingId);
                
                // Debug mapping
                console.log('üîç Contract buildingId:', contract.buildingId);
                console.log('üè¢ Available buildings:', buildings.map(b => ({ id: b.id, address: b.address })));
                console.log('üéØ Found building:', building);
                
                buildingInfo.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">${currentLanguage === 'en' ? 'Room:' : 'Ph√≤ng:'}</span>
                            <span class="font-bold text-gray-800">${contract.room || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between items-start">
                            <span class="text-gray-600">${currentLanguage === 'en' ? 'Address:' : 'ƒê·ªãa ch·ªâ chi ti·∫øt:'}</span>
                            <span class="font-semibold text-gray-800 text-right">${building?.address || 'N/A'}</span>
                        </div>
                    </div>
                `;
            } else {
                buildingInfo.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <p>${currentLanguage === 'en' ? 'No building information' : 'Ch∆∞a c√≥ th√¥ng tin to√† nh√†'}</p>
                    </div>
                `;
            }

            // Render rent info (from first contract)
            const rentInfo = document.getElementById('rent-info');
            if (contracts.length > 0) {
                const contract = contracts[0];
                const building = buildings.find(b => b.id === contract.buildingId);
                
                // Debug: Log all contract fields to see what's available
                // console.log('All contract fields:', Object.keys(contract));
                // console.log('Contract data:', contract);
                
                rentInfo.innerHTML = `
                    <div class="space-y-0 -mx-5 -my-5">
                        <div class="flex justify-between items-center py-3 px-5 bg-white">
                            <div>
                                <p class="font-medium text-gray-800">${currentLanguage === 'en' ? 'Rent' : 'Ti·ªÅn nh√†'}</p>
                            </div>
                            <p class="font-bold text-gray-800">${formatCurrency(contract.rentPrice || contract.roomPrice || 0)} / ${currentLanguage === 'en' ? 'month' : 'th√°ng'}</p>
                        </div>
                        
                        <div class="flex justify-between items-center py-3 px-5 bg-gray-50">
                            <div>
                                <p class="font-medium text-gray-800">${currentLanguage === 'en' ? 'Deposit' : 'Ti·ªÅn c·ªçc'}</p>
                            </div>
                            <p class="font-bold text-gray-800">${formatCurrency(contract.deposit || 0)}</p>
                        </div>
                        

                        
                        ${contract.vehiclePrice ? `
                        <div class="flex justify-between items-center py-3 px-5 bg-white">
                            <div>
                                <p class="font-medium text-gray-800">${currentLanguage === 'en' ? 'Parking Fee' : 'Ti·ªÅn xe'}</p>
                                <p class="text-xs text-gray-500">${currentLanguage === 'en' ? 'Quantity:' : 'S·ªë l∆∞·ª£ng:'} ${contract.vehicleCount || 1}</p>
                            </div>
                            <p class="font-bold text-gray-800">${formatCurrency(contract.vehiclePrice)} / ${currentLanguage === 'en' ? 'vehicle' : 'xe'}</p>
                        </div>
                        ` : ''}
                        
                        ${contract.serviceDetails && contract.serviceDetails.length > 0 ? 
                            contract.serviceDetails.map((serviceDetail, index) => {
                                const service = services.find(s => s.id === serviceDetail.serviceId);
                                if (service) {
                                    const isElectric = service.name.toLowerCase().includes('ƒëi·ªán');
                                    const isWater = service.name.toLowerCase().includes('n∆∞·ªõc');
                                    const isMetered = isElectric || (isWater && (service.unit === 'm¬≥' || service.unit === 'kh·ªëi'));
                                    const bgClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                                    
                                    // Translate service name
                                    const translateServiceName = (name) => {
                                        if (currentLanguage === 'en') {
                                            if (name.toLowerCase().includes('ƒëi·ªán')) return 'Electricity';
                                            if (name.toLowerCase().includes('n∆∞·ªõc')) return 'Water';
                                            if (name.toLowerCase().includes('d·ªãch v·ª• chung')) return 'Common Service';
                                            if (name.toLowerCase().includes('xe')) return 'Parking';
                                            return name; // Keep original if no translation
                                        }
                                        return name;
                                    };
                                    
                                    const translateUnit = (unit) => {
                                        if (currentLanguage === 'en') {
                                            if (unit === 'Ng∆∞·ªùi') return 'Person';
                                            if (unit === 'Ph√≤ng') return 'Room';
                                            if (unit === 'xe') return 'Vehicle';
                                            return unit;
                                        }
                                        return unit;
                                    };
                                    
                                    return `
                                    <div class="flex justify-between items-center py-3 px-5 ${bgClass}">
                                        <div>
                                            <p class="font-medium text-gray-800">${translateServiceName(service.name)}</p>
                                            ${isElectric && serviceDetail.initialReading ? `<p class="text-xs text-gray-500">${currentLanguage === 'en' ? 'Initial reading:' : 'Ch·ªâ s·ªë ƒë·∫ßu:'} ${serviceDetail.initialReading}</p>` : 
                                             isWater && serviceDetail.quantity ? `<p class="text-xs text-gray-500">${currentLanguage === 'en' ? 'Quantity:' : 'S·ªë l∆∞·ª£ng:'} ${serviceDetail.quantity}</p>` :
                                             serviceDetail.quantity > 1 ? `<p class="text-xs text-gray-500">${currentLanguage === 'en' ? 'Quantity:' : 'S·ªë l∆∞·ª£ng:'} ${serviceDetail.quantity}</p>` : ''}
                                        </div>
                                        <p class="font-bold text-gray-800">${formatCurrency(service.price || 0)} / ${translateUnit(service.unit || 'ƒë∆°n v·ªã')}</p>
                                    </div>
                                    `;
                                }
                                return '';
                            }).join('')
                        : ''}
                    </div>
                `;
            } else {
                rentInfo.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                    <p>${currentLanguage === 'en' ? 'No contract information' : 'Ch∆∞a c√≥ th√¥ng tin h·ª£p ƒë·ªìng'}</p>
                </div>
                `;
            }

            // Render tenant info
            const tenantInfo = document.getElementById('tenant-info');
            if (currentUser) {
                tenantInfo.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">${currentLanguage === 'en' ? 'Full Name:' : 'H·ªç t√™n:'}</span>
                            <span class="font-bold text-gray-800">${currentUser.name || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">${currentLanguage === 'en' ? 'Phone Number:' : 'S·ªë ƒëi·ªán tho·∫°i:'}</span>
                            <span class="font-bold text-gray-800">${currentUser.phone || 'N/A'}</span>
                        </div>
                    </div>
                `;
            } else {
                tenantInfo.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <p>${currentLanguage === 'en' ? 'No tenant information' : 'Ch∆∞a c√≥ th√¥ng tin ng∆∞·ªùi thu√™'}</p>
                    </div>
                `;
            }
        }

        function renderBillsList() {
            perfMon.track('renderBillsList');
            // console.log('üìã Rendering bills list with language:', currentLanguage);
            // Render bills
            const billsList = document.getElementById('bills-list-page');
            if (!billsList) {
                console.error('bills-list-page element not found');
                return;
            }
            
            if (bills.length === 0) {
                billsList.innerHTML = `
                    <div class="bg-white rounded-xl p-8 text-center text-gray-500 shadow-sm">
                        <div class="w-20 h-20 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                            <svg class="w-10 h-10 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <p class="font-medium text-gray-700">${currentLanguage === 'en' ? 'No bills yet' : 'Ch∆∞a c√≥ h√≥a ƒë∆°n n√†o'}</p>
                        <p class="text-sm text-gray-500 mt-1">${currentLanguage === 'en' ? 'Your bills will appear here' : 'H√≥a ƒë∆°n c·ªßa b·∫°n s·∫Ω xu·∫•t hi·ªán t·∫°i ƒë√¢y'}</p>
                    </div>
                `;
            } else {
                // S·∫Øp x·∫øp bills theo th·ªùi gian m·ªõi nh·∫•t
                const sortedBills = bills.sort((a, b) => {
                    const dateA = a.createdAt?.toDate?.() || new Date(a.createdAt);
                    const dateB = b.createdAt?.toDate?.() || new Date(b.createdAt);
                    return dateB - dateA;
                });

                billsList.innerHTML = sortedBills.map(bill => {
                    const building = buildings.find(b => b.id === bill.buildingId);
                    
                    // X√°c ƒë·ªãnh tr·∫°ng th√°i v√† m√†u s·∫Øc
                    const isPaid = bill.status === 'paid';
                    const statusBadge = isPaid 
                        ? `<span class="bg-green-600 text-white px-3 py-1 rounded-full text-xs font-medium">${t('paid')}</span>`
                        : `<span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-medium">${t('unpaid')}</span>`;
                    
                    // Format ID h√≥a ƒë∆°n
                    const billCode = bill.code || `#INV${bill.id?.slice(-6)?.toUpperCase() || ''}`;
                    
                    // Format ti√™u ƒë·ªÅ h√≥a ƒë∆°n - keep data values (month, year) unchanged
                    const billTitle = currentLanguage === 'en' 
                        ? `Monthly rent bill ${bill.period} - 2025`
                        : `H√≥a ƒë∆°n ti·ªÅn nh√† th√°ng ${bill.period} - 2025`;
                    
                    return `
                        <div class="bill-card bg-white rounded-xl p-4 shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all duration-200" data-bill-id="${bill.id}">
                            <!-- Header -->
                            <div class="mb-3">
                                <h3 class="font-bold text-gray-900 text-base">${billTitle}</h3>
                            </div>
                            
                            <!-- M√£ h√≥a ƒë∆°n v√† tr·∫°ng th√°i -->
                            <div class="flex items-center justify-between mb-3">
                                <p class="text-green-600 font-medium text-sm">${billCode}</p>
                                ${statusBadge}
                            </div>
                            
                            <!-- Chi ti·∫øt d·ªãch v·ª• -->
                            <div class="space-y-2 mb-4 text-sm">
                                ${bill.services?.slice(0, 4).map(service => {
                                    const serviceName = service.serviceName || service.name;
                                    const translatedName = translateBillServiceName(serviceName);
                                    return `
                                    <div class="flex justify-between items-center py-1">
                                        <span class="text-gray-600">${translatedName}</span>
                                        <span class="font-medium text-gray-800">${formatCurrency(service.amount || 0)}</span>
                                    </div>
                                `;
                                }).join('') || `
                                    <div class="text-center text-gray-500 py-2 text-sm">
                                        ${currentLanguage === 'en' ? 'No service details' : 'Ch∆∞a c√≥ chi ti·∫øt d·ªãch v·ª•'}
                                    </div>
                                `}
                            </div>
                            
                            <!-- T·ªïng ti·ªÅn v√† QR thanh to√°n -->
                            <div class="border-t pt-3">
                                <div class="flex justify-between items-center">
                                    <div class="flex-1">
                                    </div>
                                    <span class="font-bold text-xl text-gray-900">${formatCurrency(bill.totalAmount || 0)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Th√™m event listeners cho c√°c bill cards
                setTimeout(() => {
                    document.querySelectorAll('.bill-card').forEach(card => {
                        card.addEventListener('click', function() {
                            const billId = this.getAttribute('data-bill-id');
                            if (billId) {
                                showBillDetail(billId);
                            }
                        });
                    });
                }, 100);
            }
        }

        function showBillDetail(billId) {
            console.log('üîç showBillDetail called with ID:', billId);
            console.log('üìã All bills:', bills);
            
            const bill = bills.find(b => b.id === billId);
            if (!bill) {
                console.error('‚ùå Bill not found with ID:', billId);
                return;
            }
            
            console.log('‚úÖ Found bill:', bill);
            console.log('üìÖ billDate:', bill.billDate);
            console.log('üìÖ dueDate:', bill.dueDate);
            console.log('üìÖ createdAt:', bill.createdAt);

            const building = buildings.find(b => b.id === bill.buildingId);
            const contract = contracts.find(c => c.representativeId === currentUser.id);
            
            // Format ng√†y th√°ng - L·∫§Y ƒê√öNG T·ª™ BILL
            const formatDateVN = (date) => {
                return date.toLocaleDateString('vi-VN', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric' 
                });
            };
            
            // Helper function ƒë·ªÉ parse date an to√†n
            const parseDate = (dateValue, fieldName) => {
                console.log(`üîç Parsing ${fieldName}:`, dateValue, typeof dateValue);
                
                if (!dateValue) return null;
                
                // N·∫øu l√† Firebase Timestamp
                if (dateValue.toDate && typeof dateValue.toDate === 'function') {
                    const result = dateValue.toDate();
                    console.log(`‚úÖ ${fieldName} parsed from Timestamp:`, result);
                    return result;
                }
                
                // N·∫øu l√† string format DD/MM/YYYY
                if (typeof dateValue === 'string') {
                    const parts = dateValue.split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1; // JS month is 0-indexed
                        const year = parseInt(parts[2]);
                        const result = new Date(year, month, day);
                        console.log(`‚úÖ ${fieldName} parsed from string DD/MM/YYYY:`, result);
                        return result;
                    }
                }
                
                // Fallback: try native Date parse
                try {
                    const result = new Date(dateValue);
                    console.log(`‚ö†Ô∏è ${fieldName} parsed with fallback:`, result);
                    return result;
                } catch (e) {
                    console.error(`‚ùå Failed to parse ${fieldName}:`, e);
                    return null;
                }
            };
            
            // L·∫•y ng√†y t·∫°o t·ª´ billDate (∆∞u ti√™n) ho·∫∑c createdAt
            let createdDate = parseDate(bill.billDate, 'billDate');
            if (!createdDate || createdDate.getFullYear() < 2000) {
                createdDate = parseDate(bill.createdAt, 'createdAt') || new Date();
            }
            
            // L·∫•y h·∫°n thanh to√°n t·ª´ dueDate
            let dueDate = parseDate(bill.dueDate, 'dueDate');
            
            // N·∫øu kh√¥ng c√≥ dueDate ho·∫∑c parse sai, t√≠nh t·ª´ contract paymentDay
            if (!dueDate || dueDate.getFullYear() < 2000) {
                if (contract && contract.paymentDay) {
                    const year = createdDate.getFullYear();
                    const month = parseInt(bill.period) || createdDate.getMonth() + 1;
                    dueDate = new Date(year, month - 1, contract.paymentDay);
                    console.log(`‚úÖ dueDate calculated from contract paymentDay:`, dueDate);
                } else {
                    // Fallback: +3 ng√†y t·ª´ ng√†y t·∫°o
                    dueDate = new Date(createdDate);
                    dueDate.setDate(dueDate.getDate() + 3);
                    console.log(`‚ö†Ô∏è dueDate fallback (+3 days):`, dueDate);
                }
            }
            
            console.log('üìÖ Final createdDate:', createdDate);
            console.log('üìÖ Final dueDate:', dueDate);

            // Format period (c√≥ th·ªÉ l√† "11-2025" ho·∫∑c "11" ho·∫∑c number 11)
            let periodDisplay = '';
            if (bill.period) {
                const periodStr = String(bill.period);
                if (periodStr.includes('-')) {
                    periodDisplay = periodStr; // ƒê√£ c√≥ format "11-2025"
                } else {
                    periodDisplay = `${periodStr}-2025`; // Ch·ªâ c√≥ th√°ng, th√™m nƒÉm
                }
            } else {
                periodDisplay = 'N/A';
            }
            
            // L·∫•y services t·ª´ bill (kh√¥ng fallback hardcode)
            const services = bill.services || [];
            
            if (services.length === 0) {
                console.warn('‚ö†Ô∏è Bill has no services data:', bill.id);
            }



            const content = `
                <!-- Header h√≥a ƒë∆°n -->
                <div class="text-center mb-4 pb-3 border-b">
                    <h2 class="text-lg font-bold">${currentLanguage === 'en' ? `Monthly Bill ${periodDisplay}` : `H√≥a ƒê∆°n Th√°ng ${periodDisplay}`}</h2>
                </div>
                
                <!-- Th√¥ng tin c∆° b·∫£n -->
                <div class="mb-4 text-sm space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">${currentLanguage === 'en' ? 'Room:' : 'Ph√≤ng:'}</span>
                        <span class="font-semibold">${bill.room || contract?.room}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">${currentLanguage === 'en' ? 'Bill Number:' : 'S·ªë h√≥a ƒë∆°n:'}</span>
                        <span class="font-semibold text-green-600">${bill.code || `INV${bill.id?.slice(-6)?.toUpperCase()}`}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">${currentLanguage === 'en' ? 'Created Date:' : 'Ng√†y t·∫°o:'}</span>
                        <span class="font-semibold">${formatDateVN(createdDate)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">${currentLanguage === 'en' ? 'Due Date:' : 'H·∫°n thanh to√°n:'}</span>
                        <span class="font-semibold">${formatDateVN(dueDate)}</span>
                    </div>
                </div>

                <!-- Chi ti·∫øt d·ªãch v·ª• -->
                <div class="mb-4">
                    <h3 class="font-semibold text-gray-800 mb-3">${currentLanguage === 'en' ? 'Service Details' : 'Chi ti·∫øt d·ªãch v·ª•'}</h3>
                    <div class="space-y-3">
                        ${services.map((service, index) => {
                            const serviceName = service.serviceName || service.name || `D·ªãch v·ª• ${index + 1}`;
                            const unitPrice = service.unitPrice || service.price || 0;
                            const quantity = service.quantity !== undefined ? service.quantity : (service.usage !== undefined ? service.usage : 1);
                            const amount = service.amount !== undefined ? service.amount : (unitPrice * quantity);
                            
                            return `
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="font-medium text-gray-800">${translateBillServiceName(serviceName)}</span>
                                        <span class="font-bold text-gray-900">${formatCurrency(amount)}</span>
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        <span>${currentLanguage === 'en' ? 'Unit Price:' : 'ƒê∆°n gi√°:'} ${formatCurrency(unitPrice)} √ó ${quantity}</span>
                                        ${service.type === 'electric' && service.oldReading && service.newReading ? 
                                            `<br>${currentLanguage === 'en' ? 'Reading:' : 'Ch·ªâ s·ªë:'} ${service.oldReading} ‚Üí ${service.newReading}` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <!-- T·ªïng k·∫øt -->
                <div class="border-t pt-4 mb-4">
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">${currentLanguage === 'en' ? 'Total:' : 'T·ªïng c·ªông:'}</span>
                            <span class="font-semibold">${formatCurrency(bill.totalAmount || 0)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">${currentLanguage === 'en' ? 'Paid:' : 'ƒê√£ thanh to√°n:'}</span>
                            <span class="font-semibold">${formatCurrency(bill.paidAmount || 0)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-t">
                            <span class="font-bold text-lg ${(bill.status === 'paid' || (bill.paidAmount || 0) >= (bill.totalAmount || 0)) ? 'text-green-600' : 'text-red-600'}">${currentLanguage === 'en' ? 'Remaining:' : 'C√≤n l·∫°i:'}</span>
                            <span class="font-bold text-xl ${(bill.status === 'paid' || (bill.paidAmount || 0) >= (bill.totalAmount || 0)) ? 'text-green-600' : 'text-red-600'}">${formatCurrency((bill.totalAmount || 0) - (bill.paidAmount || 0))}</span>
                        </div>
                    </div>
                </div>

                <!-- Tr·∫°ng th√°i thanh to√°n -->
                ${(bill.status === 'unpaid' && (bill.paidAmount || 0) < (bill.totalAmount || 0)) ? `
                    <div class="text-center bg-red-50 rounded-lg p-4">
                        <div class="text-red-600 mb-2">
                            <svg class="w-12 h-12 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <p class="font-semibold text-red-600 mb-1">${currentLanguage === 'en' ? 'UNPAID' : 'CH∆ØA THANH TO√ÅN'}</p>
                        <p class="text-sm text-gray-600 mb-3">${currentLanguage === 'en' ? 'Please pay on time' : 'Vui l√≤ng thanh to√°n ƒë√∫ng h·∫°n'}</p>
                        <button onclick="showQRPayment('${bill.id}')" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700">
                            ${currentLanguage === 'en' ? 'Pay Now' : 'Thanh to√°n'}
                        </button>
                    </div>
                ` : `
                    <div class="text-center bg-green-50 rounded-lg p-4">
                        <div class="text-green-600 mb-2">
                            <svg class="w-12 h-12 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <p class="font-semibold text-green-600">${currentLanguage === 'en' ? 'PAID' : 'ƒê√É THANH TO√ÅN'}</p>
                        <p class="text-sm text-gray-600 mt-1">${currentLanguage === 'en' ? 'Thank you for your timely payment' : 'C·∫£m ∆°n b·∫°n ƒë√£ thanh to√°n ƒë√∫ng h·∫°n'}</p>
                    </div>
                `}
            `;

            document.getElementById('bill-detail-content').innerHTML = content;
            
            // Hide other screens and show bill detail
            document.getElementById('bills-screen').classList.add('hidden');
            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('bill-detail-screen').classList.remove('hidden');
            
            // Scroll to top of bill detail screen
            const billDetailScreen = document.getElementById('bill-detail-screen');
            if (billDetailScreen) {
                billDetailScreen.scrollTop = 0;
            }

            // Generate VietQR code if unpaid
            if (bill.status === 'unpaid') {
                setTimeout(() => {
                    const YOUR_BANK_ID = "970416"; // ACB Bank
                    const YOUR_ACCOUNT_NO = "113366668888"; 
                    const qrContent = `THANHTOAN PHONG${bill.room} T${bill.period}${new Date().getFullYear()}`;
                    const qrUrl = `https://img.vietqr.io/image/${YOUR_BANK_ID}-${YOUR_ACCOUNT_NO}-qr_only.jpg?amount=${bill.totalAmount}&addInfo=${encodeURIComponent(qrContent)}`;
                    
                    const qrImg = document.createElement('img');
                    qrImg.src = qrUrl;
                    qrImg.className = 'w-24 h-24 border rounded-lg';
                    qrImg.alt = 'QR Code thanh to√°n';
                    
                    const qrContainer = document.getElementById('qr-code-container');
                    if (qrContainer) {
                        qrContainer.innerHTML = '';
                        qrContainer.appendChild(qrImg);
                    }
                }, 100);
            }
        }

        function closeBillDetail() {
            document.getElementById('bill-detail-screen').classList.add('hidden');
            document.getElementById('bills-screen').classList.remove('hidden');
        }

        // QR Payment Functions
        let currentPaymentData = null;
        
        async function showQRPayment(billId) {
            const bill = bills.find(b => b.id === billId);
            if (!bill) {
                alert('Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n');
                return;
            }
            
            const building = buildings.find(b => b.id === bill.buildingId);
            if (!building || !building.accountId) {
                alert('Ch∆∞a c√≥ th√¥ng tin t√†i kho·∫£n ng√¢n h√†ng');
                return;
            }
            
            // L·∫•y th√¥ng tin t√†i kho·∫£n t·ª´ building
            console.log('üîç Loading account info for building:', building.id);
            
            try {
                const accountsQuery = query(collection(db, 'accounts'), where('__name__', '==', building.accountId));
                const accountsSnapshot = await getDocs(accountsQuery);
                
                if (accountsSnapshot.empty) {
                    alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin t√†i kho·∫£n');
                    return;
                }
                
                const account = { id: accountsSnapshot.docs[0].id, ...accountsSnapshot.docs[0].data() };
                console.log('‚úÖ Account found:', account);
                
                if (account.bank === 'Cash') {
                    alert('Vui l√≤ng thanh to√°n b·∫±ng ti·ªÅn m·∫∑t');
                    return;
                }
                
                // Bank ID mapping
                const BANK_ID_MAP = {
                    'VietcomBank': '970436',
                    'BIDV': '970418', 
                    'VietinBank': '970415',
                    'Agribank': '970405',
                    'ACB': '970416',
                    'Techcombank': '970407',
                    'MBBank': '970422',
                    'TPBank': '970423',
                    'Sacombank': '970403',
                    'HDBank': '970437',
                    'VPBank': '970432',
                    'SHB': '970443',
                    'Eximbank': '970431',
                    'MSB': '970426',
                    'OCB': '970448',
                    'Nam A Bank': '970428'
                };
                
                const bankId = BANK_ID_MAP[account.bank] || '970416';
                const accountNumber = account.accountNumber;
                const accountName = account.accountHolder || 'KHACH HANG';
                const amount = bill.totalAmount - (bill.paidAmount || 0);
                
                // S·ª≠ d·ª•ng QR content gi·ªëng web index thay v√¨ t·ª± t·∫°o
                const customer = currentUser;
                let qrContent = 'CHUYEN KHOAN';
                if (customer && customer.name) {
                    // Chuy·ªÉn t√™n th√†nh ch·ªØ hoa, b·ªè d·∫•u ƒë·ªÉ ph√π h·ª£p v·ªõi format ng√¢n h√†ng
                    const customerName = customer.name
                        .toUpperCase()
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '') // B·ªè d·∫•u ti·∫øng Vi·ªát
                        .replace(/ƒê/g, 'D')
                        .replace(/ƒë/g, 'd');
                    qrContent = `${customerName} CHUYEN KHOAN`;
                }
                
                // T·∫°o QR URL v·ªõi n·ªôi dung gi·ªëng web index
                const qrUrl = `https://img.vietqr.io/image/${bankId}-${accountNumber}-qr_only.jpg?amount=${amount}&addInfo=${encodeURIComponent(qrContent)}&accountName=${encodeURIComponent(accountName)}`;
                
                // L∆∞u data ƒë·ªÉ d√πng cho copy v√† download
                currentPaymentData = {
                    qrUrl: qrUrl,
                    accountName: accountName,
                    accountNumber: accountNumber,
                    amount: amount,
                    description: qrContent, // S·ª≠ d·ª•ng qrContent thay v√¨ description c≈©
                    billId: bill.id
                };
                
                // Hi·ªÉn th·ªã m√†n h√¨nh QR payment
                document.getElementById('payment-qr-image').src = qrUrl;
                document.getElementById('payment-account-name').textContent = accountName;
                document.getElementById('payment-account-number').textContent = accountNumber;
                document.getElementById('payment-amount').textContent = formatCurrency(amount);
                
                // Hide bill detail, show QR payment
                document.getElementById('bill-detail-screen').classList.add('hidden');
                const qrScreen = document.getElementById('qr-payment-screen');
                qrScreen.classList.remove('hidden');
                
                // Scroll to top
                setTimeout(() => {
                    qrScreen.scrollTop = 0;
                }, 0);
                
            } catch (error) {
                console.error('Error loading account:', error);
                alert('L·ªói t·∫£i th√¥ng tin t√†i kho·∫£n');
            }
        }
        
        function closeQRPayment() {
            document.getElementById('qr-payment-screen').classList.add('hidden');
            document.getElementById('bill-detail-screen').classList.remove('hidden');
        }
        
        function copyAccountNumber() {
            if (!currentPaymentData) return;
            navigator.clipboard.writeText(currentPaymentData.accountNumber).then(() => {
                showToast('ƒê√£ sao ch√©p s·ªë t√†i kho·∫£n', 'success');
            });
        }
        
        function copyAmount() {
            if (!currentPaymentData) return;
            // Copy s·ªë ti·ªÅn kh√¥ng c√≥ VNƒê, ch·ªâ s·ªë
            const amountNumber = currentPaymentData.amount.toString().replace(/\./g, '');
            navigator.clipboard.writeText(amountNumber).then(() => {
                showToast('ƒê√£ sao ch√©p s·ªë ti·ªÅn', 'success');
            });
        }
        
        async function downloadQR() {
            if (!currentPaymentData) return;
            
            try {
                showToast('ƒêang t·∫£i ·∫£nh QR...', 'info');
                
                // L·∫•y ·∫£nh QR t·ª´ element hi·ªán t·∫°i
                const qrImg = document.getElementById('payment-qr-image');
                if (!qrImg || !qrImg.src) {
                    showToast('Kh√¥ng t√¨m th·∫•y m√£ QR ƒë·ªÉ t·∫£i', 'error');
                    return;
                }
                
                // T·∫°o canvas ƒë·ªÉ v·∫Ω ·∫£nh QR
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // T·∫°o image element m·ªõi ƒë·ªÉ load ·∫£nh
                const img = new Image();
                img.crossOrigin = 'anonymous'; // ƒê·ªÉ tr√°nh CORS issue
                
                img.onload = function() {
                    // ƒê·∫∑t k√≠ch th∆∞·ªõc canvas b·∫±ng k√≠ch th∆∞·ªõc ·∫£nh
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // V·∫Ω ·∫£nh l√™n canvas
                    ctx.drawImage(img, 0, 0);
                    
                    // Chuy·ªÉn canvas th√†nh blob
                    canvas.toBlob(function(blob) {
                        if (blob) {
                            // T·∫°o URL t·ª´ blob
                            const url = URL.createObjectURL(blob);
                            
                            // T·∫°o link download
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = `QR_Thanh_Toan_Phong_${currentPaymentData.room || 'Unknown'}_${new Date().getTime()}.jpg`;
                            
                            // Trigger download
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            // D·ªçn d·∫πp
                            URL.revokeObjectURL(url);
                            
                            showToast('‚úÖ ƒê√£ l∆∞u m√£ QR v√†o th∆∞ vi·ªán!', 'success');
                        } else {
                            showToast('L·ªói khi t·∫°o file ·∫£nh', 'error');
                        }
                    }, 'image/jpeg', 0.9);
                };
                
                img.onerror = function() {
                    console.log('Canvas method failed, trying fetch method...');
                    // Fallback: D√πng fetch ƒë·ªÉ t·∫£i ·∫£nh
                    downloadQRWithFetch();
                };
                
                // Load ·∫£nh t·ª´ URL
                img.src = currentPaymentData.qrUrl;
                
            } catch (error) {
                console.error('L·ªói download QR:', error);
                showToast('L·ªói khi t·∫£i m√£ QR', 'error');
            }
        }

        // Ph∆∞∆°ng ph√°p fallback d√πng fetch
        async function downloadQRWithFetch() {
            try {
                const response = await fetch(currentPaymentData.qrUrl, {
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const blob = await response.blob();
                
                // T·∫°o URL t·ª´ blob
                const url = URL.createObjectURL(blob);
                
                // T·∫°o link download
                const link = document.createElement('a');
                link.href = url;
                link.download = `QR_Thanh_Toan_Phong_${currentPaymentData.room || 'Unknown'}_${new Date().getTime()}.jpg`;
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // D·ªçn d·∫πp
                URL.revokeObjectURL(url);
                
                showToast('‚úÖ ƒê√£ l∆∞u m√£ QR v√†o th∆∞ vi·ªán!', 'success');
                
            } catch (error) {
                console.error('Fetch method also failed:', error);
                // Cu·ªëi c√πng d√πng ph∆∞∆°ng ph√°p c≈© n·∫øu t·∫•t c·∫£ ƒë·ªÅu fail
                downloadQRFallback();
            }
        }

        // Ph∆∞∆°ng ph√°p cu·ªëi c√πng (gi·ªëng nh∆∞ tr∆∞·ªõc)
        function downloadQRFallback() {
            const link = document.createElement('a');
            link.href = currentPaymentData.qrUrl;
            link.download = `QR_Thanh_Toan_Phong_${currentPaymentData.room || 'Unknown'}_${new Date().getTime()}.jpg`;
            link.target = '_blank'; // M·ªü trong tab m·ªõi
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('M√£ QR ƒë√£ ƒë∆∞·ª£c m·ªü. Nh·∫•n gi·ªØ ·∫£nh ƒë·ªÉ l∆∞u v√†o th∆∞ vi·ªán.', 'info');
        }

        async function refreshData() {
            if (currentUser) {
                await loadUserData(currentUser.id);
                renderHomeData();
                renderBillsList();
                alert('ƒê√£ l√†m m·ªõi d·ªØ li·ªáu!');
            }
        }

        function showScreen(screenName) {
            // Hide all screens
            const homeScreen = document.getElementById('home-screen');
            const billsScreen = document.getElementById('bills-screen');
            const notificationsScreen = document.getElementById('notifications-screen');
            const createIssueScreen = document.getElementById('create-issue-screen');
            const issueFormScreen = document.getElementById('issue-form-screen');
            const profileScreen = document.getElementById('profile-screen');
            const billDetailScreen = document.getElementById('bill-detail-screen');
            const qrPaymentScreen = document.getElementById('qr-payment-screen');
            
            if (homeScreen) homeScreen.classList.add('hidden');
            if (billsScreen) billsScreen.classList.add('hidden');
            if (notificationsScreen) notificationsScreen.classList.add('hidden');
            if (createIssueScreen) createIssueScreen.classList.add('hidden');
            if (issueFormScreen) issueFormScreen.classList.add('hidden');
            if (profileScreen) profileScreen.classList.add('hidden');
            if (billDetailScreen) billDetailScreen.classList.add('hidden');
            if (qrPaymentScreen) qrPaymentScreen.classList.add('hidden');
            
            // Show selected screen
            if (screenName === 'home' && homeScreen) {
                homeScreen.classList.remove('hidden');
                renderHomeData();
            } else if (screenName === 'bills' && billsScreen) {
                billsScreen.classList.remove('hidden');
                renderBillsList();
            } else if (screenName === 'notifications' && notificationsScreen) {
                notificationsScreen.classList.remove('hidden');
                renderNotificationsList();
            } else if (screenName === 'create-issue' && createIssueScreen) {
                createIssueScreen.classList.remove('hidden');
            } else if (screenName === 'profile' && profileScreen) {
                console.log('üîß Showing profile screen');
                profileScreen.classList.remove('hidden');
                loadProfileData();
            }
        }

        // Y√äU C·∫¶U 3: CH·ª®C NƒÇNG T·∫†O S·ª∞ C·ªê
        window.showCreateIssueScreen = async function() {
            console.log('üîî showCreateIssueScreen called');
            showScreen('create-issue');
            
            // Update navigation (remove active from all, don't add to any since this is a separate screen)
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            console.log('üìû About to load customer issues...');
            // Load and display issues
            await loadCustomerIssues();
            console.log('‚úÖ Issues loaded and displayed');
        };

        window.closeIssueScreen = function() {
            // Cleanup realtime listener when leaving issues screen
            if (issuesUnsubscribe) {
                issuesUnsubscribe();
                issuesUnsubscribe = null;
                console.log('üîå Unsubscribed from issues listener');
            }
            
            showScreen('home');
            
            // Update navigation to home
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector('.nav-item').classList.add('active'); // First item is home
        };

        // Listener for realtime issues updates
        let issuesUnsubscribe = null;

        // Load customer's reported issues with realtime sync
        async function loadCustomerIssues() {
            if (!currentUser) {
                console.log('‚ùå No current user, cannot load issues');
                return;
            }
            
            try {
                console.log('üìã Setting up realtime listener for customer:', currentUser.id);
                
                // Unsubscribe from previous listener if exists
                if (issuesUnsubscribe) {
                    issuesUnsubscribe();
                    console.log('üîå Unsubscribed from previous listener');
                }
                
                // Query tasks created by this customer (without orderBy to avoid index requirement)
                const tasksQuery = query(
                    collection(db, 'tasks'),
                    where('customerId', '==', currentUser.id)
                );
                
                // Setup realtime listener - auto updates when data changes
                issuesUnsubscribe = onSnapshot(tasksQuery, (snapshot) => {
                    console.log('üîÑ Realtime update received');
                    
                    const issues = [];
                    snapshot.forEach((doc) => {
                        issues.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Sort by createdAt in JavaScript
                    issues.sort((a, b) => {
                        const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
                        const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
                        return dateB - dateA; // Descending order (newest first)
                    });
                    
                    console.log('‚úÖ Loaded issues count:', issues.length);
                    
                    // Show empty state or issues list
                    const emptyState = document.getElementById('empty-issues-state');
                    const listContainer = document.getElementById('issues-list-container');
                    
                    if (!emptyState || !listContainer) {
                        console.error('‚ùå Cannot find empty state or list container elements');
                        return;
                    }
                    
                    if (issues.length === 0) {
                        console.log('üì≠ No issues found, showing empty state');
                        emptyState.classList.remove('hidden');
                        listContainer.classList.add('hidden');
                    } else {
                        console.log('üìã Issues found, showing list');
                        emptyState.classList.add('hidden');
                        listContainer.classList.remove('hidden');
                        renderIssuesList(issues);
                    }
                }, (error) => {
                    console.error('‚ùå Error in realtime listener:', error);
                    showToast('L·ªói ƒë·ªìng b·ªô d·ªØ li·ªáu', 'error');
                });
                
            } catch (error) {
                console.error('‚ùå Error setting up realtime listener:', error);
                showToast('L·ªói t·∫£i danh s√°ch s·ª± c·ªë', 'error');
            }
        }

        // Render issues list
        function renderIssuesList(issues) {
            // console.log('üé® Rendering issues list:', issues.length, 'items');
            const listContainer = document.getElementById('issues-list');
            if (!listContainer) {
                console.error('‚ùå Cannot find issues-list element');
                return;
            }
            
            listContainer.innerHTML = issues.map((issue, idx) => {
                // console.log(`Rendering issue ${idx}:`, issue);
                
                const statusConfig = {
                    'pending': { label: t('statusPending'), bg: 'bg-yellow-100', text: 'text-yellow-800' },
                    'in-progress': { label: t('statusInProgress'), bg: 'bg-blue-100', text: 'text-blue-800' },
                    'completed': { label: t('statusCompleted'), bg: 'bg-green-100', text: 'text-green-800' },
                    'cancelled': { label: t('statusCancelled'), bg: 'bg-gray-100', text: 'text-gray-800' }
                };
                
                const status = statusConfig[issue.status] || statusConfig['pending'];
                let formattedDate = 'N/A';
                try {
                    const date = issue.createdAt?.toDate ? issue.createdAt.toDate() : new Date(issue.createdAt);
                    formattedDate = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                } catch (e) {
                    console.warn('Error formatting date for issue:', issue.id, e);
                }
                
                return `
                    <div class="card cursor-pointer hover:shadow-md transition-shadow" onclick="viewIssueDetail('${issue.id}')">
                        <div class="flex items-start justify-between mb-2">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${status.bg} ${status.text}">
                                ${status.label}
                            </span>
                            <span class="text-xs text-gray-500">${formattedDate}</span>
                        </div>
                        <h3 class="font-semibold text-gray-900 mb-1">${issue.title || 'S·ª± c·ªë'}</h3>
                        <p class="text-sm text-gray-600 line-clamp-2">${issue.description || ''}</p>
                    </div>
                `;
            }).join('');
            
            // console.log('‚úÖ Rendered HTML to issues-list container');
        }

        // View issue detail (placeholder for future implementation)
        window.viewIssueDetail = function(issueId) {
            console.log('View issue detail:', issueId);
            showToast('Ch·ª©c nƒÉng xem chi ti·∫øt ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
        };

        window.backToHome = function() {
            showScreen('home');
            
            // Update navigation to home
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector('.nav-item').classList.add('active'); // First item is home
        };

        window.showIssueForm = function() {
            // Hide create-issue screen, show form screen
            document.getElementById('create-issue-screen').classList.add('hidden');
            document.getElementById('issue-form-screen').classList.remove('hidden');
            
            // Reset form
            const descField = document.getElementById('issue-description');
            if (descField) descField.value = '';
            selectedImages = [];
            updateImagePreview();
            updateImageCounter();
        };

        window.backToIssueScreen = function() {
            // Hide form screen, show create-issue screen
            document.getElementById('issue-form-screen').classList.add('hidden');
            document.getElementById('create-issue-screen').classList.remove('hidden');
        };

        // Handle image upload
        let selectedImages = [];
        
        window.handleImageUpload = function(input) {
            const files = Array.from(input.files);
            const maxImages = 5;
            
            // Ki·ªÉm tra s·ªë l∆∞·ª£ng ·∫£nh
            if (selectedImages.length + files.length > maxImages) {
                alert(`Ch·ªâ ƒë∆∞·ª£c ch·ªçn t·ªëi ƒëa ${maxImages} ·∫£nh`);
                return;
            }
            
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    selectedImages.push(file);
                }
            });
            
            updateImagePreview();
            updateImageCounter();
        };
        
        function updateImagePreview() {
            const preview = document.getElementById('image-preview');
            if (!preview) return;
            
            preview.innerHTML = '';
            
            selectedImages.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'relative';
                    imageDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Preview" class="w-full h-20 object-cover rounded-lg border">
                        <button type="button" onclick="removeImage(${index})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
                            √ó
                        </button>
                    `;
                    preview.appendChild(imageDiv);
                };
                reader.readAsDataURL(file);
            });
        }
        
        window.removeImage = function(index) {
            selectedImages.splice(index, 1);
            updateImagePreview();
            updateImageCounter();
        };
        
        function updateImageCounter() {
            const counter = document.querySelector('label[for="issue-images"]');
            if (counter) {
                counter.textContent = `H√¨nh ·∫£nh (${selectedImages.length}/5)`;
            }
        }

        window.submitIssue = async function() {
            const description = document.getElementById('issue-description').value.trim();
            
            if (!description) {
                alert('Vui l√≤ng nh·∫≠p m√¥ t·∫£ s·ª± c·ªë');
                return;
            }

            try {
                const contract = contracts[0];
                const building = buildings.find(b => b.id === contract?.buildingId);
                
                // L·∫•y t√™n ng∆∞·ªùi ƒë·∫°i di·ªán - ∆∞u ti√™n t·ª´ currentUser v√¨ contract ch·ªâ c√≥ ID
                const representativeName = currentUser?.name || 'Kh√°ch h√†ng';
                const representativePhone = currentUser?.phone || '';
                
                console.log('üë§ Representative info:', {
                    name: representativeName,
                    phone: representativePhone,
                    contractId: contract?.id,
                    representativeId: contract?.representativeId
                });
                
                // UPLOAD ·∫¢NH L√äN FIREBASE STORAGE
                const imageUrls = [];
                if (selectedImages.length > 0) {
                    console.log('üì§ Starting upload for', selectedImages.length, 'images...');
                    showToast(`ƒêang upload ${selectedImages.length} ·∫£nh...`, 'info');
                    
                    let uploadedCount = 0;
                    let failedCount = 0;
                    
                    for (let i = 0; i < selectedImages.length; i++) {
                        const file = selectedImages[i];
                        const timestamp = Date.now();
                        const fileName = `issues/${currentUser.id}/${timestamp}_${i}_${file.name}`;
                        const storageRef = ref(storage, fileName);
                        
                        try {
                            console.log(`‚è≥ Uploading image ${i + 1}/${selectedImages.length}: ${file.name}`);
                            await uploadBytes(storageRef, file);
                            const url = await getDownloadURL(storageRef);
                            imageUrls.push(url);
                            uploadedCount++;
                            console.log(`‚úÖ Uploaded ${i + 1}/${selectedImages.length}: ${url}`);
                            showToast(`ƒê√£ upload ${uploadedCount}/${selectedImages.length} ·∫£nh`, 'success');
                        } catch (uploadError) {
                            failedCount++;
                            console.error(`‚ùå Failed to upload image ${i + 1}:`, uploadError);
                            showToast(`L·ªói upload ·∫£nh ${i + 1}: ${uploadError.message}`, 'error');
                        }
                    }
                    
                    console.log(`‚úÖ Upload completed: ${uploadedCount} success, ${failedCount} failed`);
                    console.log('üì∏ Image URLs:', imageUrls);
                    
                    if (failedCount > 0) {
                        showToast(`Upload ho√†n t·∫•t: ${uploadedCount} th√†nh c√¥ng, ${failedCount} th·∫•t b·∫°i`, 'warning');
                    } else {
                        showToast(`Upload th√†nh c√¥ng ${uploadedCount} ·∫£nh!`, 'success');
                    }
                }
                
                // Y√äU C·∫¶U 3: T·∫†O S·ª∞ C·ªê TRONG FIREBASE (s·∫Ω ƒë∆∞·ª£c web admin nh·∫≠n v√† x·ª≠ l√Ω)
                const taskData = {
                    title: description.substring(0, 50) + (description.length > 50 ? '...' : ''), // T·ª± ƒë·ªông t·∫°o title t·ª´ m√¥ t·∫£
                    description: description,
                    customerId: currentUser.id,
                    buildingId: contract?.buildingId || '',
                    room: contract?.room || '',
                    priority: 'medium', // M·∫∑c ƒë·ªãnh l√† trung b√¨nh
                    status: 'pending', // Tr·∫°ng th√°i ch·ªù x·ª≠ l√Ω
                    type: 'issue', // Lo·∫°i s·ª± c·ªë t·ª´ kh√°ch
                    contact: representativePhone,
                    reporter: representativeName, // T√™n ng∆∞·ªùi ƒë·∫°i di·ªán - ƒê√öNG FIELD NAME WEB ƒê·ªåC
                    reportedBy: representativeName, // Backup field
                    images: imageUrls.length, // S·ªë l∆∞·ª£ng ·∫£nh
                    imageUrls: imageUrls, // Array URLs c·ªßa ·∫£nh ƒë√£ upload
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                console.log('üîß Creating issue:', taskData);
                
                // 1. L∆∞u task v√†o Firebase collection 'tasks' (ƒë·ªÉ web admin qu·∫£n l√Ω)
                const taskRef = await addDoc(collection(db, 'tasks'), taskData);
                console.log('‚úÖ Task created with ID:', taskRef.id);
                
                // 2. T·∫°o notification cho web admin (hi·ªÉn th·ªã trong m·ª•c Th√¥ng b√°o)
                const notificationData = {
                    title: `${t('issueFromRoom')} ${contract?.room || 'N/A'}`,
                    message: description, // Hi·ªán to√†n b·ªô n·ªôi dung m√¥ t·∫£ chi ti·∫øt c·ªßa kh√°ch b√°o
                    type: 'customer_issue',
                    priority: 'medium',
                    buildingId: contract?.buildingId || '',
                    room: contract?.room || '',
                    customerId: currentUser.id,
                    customerName: representativeName,
                    taskId: taskRef.id, // Link ƒë·∫øn task v·ª´a t·∫°o
                    isRead: false,
                    createdAt: new Date(),
                    // Metadata ƒë·ªÉ web c√≥ th·ªÉ filter theo building/room
                    metadata: {
                        reportedBy: representativeName,
                        customerPhone: representativePhone,
                        buildingCode: building?.code || 'N/A',
                        issueDescription: description, // L∆∞u to√†n b·ªô m√¥ t·∫£ kh√¥ng c·∫Øt b·ªõt
                        imageCount: imageUrls.length
                    }
                };
                
                console.log('üì¢ Creating notification for web admin:', notificationData);
                
                // L∆∞u notification v√†o Firebase collection 'adminNotifications' (ƒë·ªÉ web admin ƒë·ªçc ƒë∆∞·ª£c)
                const notificationRef = await addDoc(collection(db, 'adminNotifications'), notificationData);
                console.log('‚úÖ Notification created with ID:', notificationRef.id);
                
                // Reset form
                const descField = document.getElementById('issue-description');
                if (descField) descField.value = '';
                selectedImages = [];
                updateImagePreview();
                updateImageCounter();
                
                // Hi·ªán th√¥ng b√°o th√†nh c√¥ng
                showToast('ƒê√£ g·ª≠i s·ª± c·ªë th√†nh c√¥ng! Ch√∫ng t√¥i s·∫Ω x·ª≠ l√Ω trong th·ªùi gian s·ªõm nh·∫•t.', 'success');
                
                // Quay v·ªÅ m√†n h√¨nh danh s√°ch s·ª± c·ªë
                setTimeout(async () => {
                    document.getElementById('issue-form-screen').classList.add('hidden');
                    document.getElementById('create-issue-screen').classList.remove('hidden');
                    await loadCustomerIssues(); // Reload issues list
                }, 1000);
                
                return { 
                    task: { id: taskRef.id, ...taskData },
                    notification: { id: notificationRef.id, ...notificationData }
                };
                
            } catch (error) {
                console.error('Error creating issue:', error);
                showToast('L·ªói g·ª≠i s·ª± c·ªë. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                throw error;
            }
        };

        // Global functions
        window.handleLogin = async function() {
            const phone = document.getElementById('phone-input').value.trim();
            
            if (!phone) {
                alert('Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i');
                return;
            }

            if (!/^0[0-9]{9}$/.test(phone)) {
                alert('S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10 ch·ªØ s·ªë v√† b·∫Øt ƒë·∫ßu b·∫±ng 0');
                return;
            }

            const loginBtn = document.getElementById('login-btn');
            loginBtn.disabled = true;
            loginBtn.textContent = 'ƒêang ƒëƒÉng nh·∫≠p...';

            try {
                const customer = await loadCustomerData(phone);
                if (!customer) {
                    alert('S·ªë ƒëi·ªán tho·∫°i kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng');
                    return;
                }

                localStorage.setItem('userPhone', phone);
                requestNotificationPermission();
                await showHome(customer);
                updateAppInteractionState(); // Enable interaction sau khi login
            } catch (error) {
                console.error('Login error:', error);
                alert('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'ƒêƒÉng Nh·∫≠p';
            }
        };

        window.logout = function() {
            localStorage.removeItem('userPhone');
            currentUser = null;
            bills = [];
            updateAppInteractionState(); // Disable interaction khi logout
            showLogin();
            location.reload();
        };

        window.showBillDetail = showBillDetail;
        window.closeBillDetail = closeBillDetail;
        window.refreshData = refreshData;
        
        // Export QR Payment functions
        window.showQRPayment = showQRPayment;
        window.closeQRPayment = closeQRPayment;
        window.copyAccountNumber = copyAccountNumber;
        window.copyAmount = copyAmount;
        window.downloadQR = downloadQR;
        
        // Go to Bills Page
        window.goToBillsPage = function() {
            // Switch to bills tab
            showScreen('bills');
            
            // Update active state in bottom nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            // Find and activate the bills nav item (3rd item - index 2)
            const navItems = document.querySelectorAll('.nav-item');
            if (navItems[2]) {
                navItems[2].classList.add('active');
            }
        };
        
        // Bottom Navigation
        window.switchTab = function(tab) {
            // Ki·ªÉm tra ƒëƒÉng nh·∫≠p - ch·ªâ cho ph√©p tab home n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
            if (!currentUser && tab !== 'home') {
                console.log('‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p, ch·∫∑n chuy·ªÉn tab:', tab);
                // Gi·ªØ active state cho home tab
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector('.nav-item[onclick="switchTab(\'home\')"]')?.classList.add('active');
                return;
            }
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked item if event exists
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
            
            // Handle tab switching
            switch(tab) {
                case 'home':
                    // Cleanup issues listener when leaving
                    if (issuesUnsubscribe) {
                        issuesUnsubscribe();
                        issuesUnsubscribe = null;
                    }
                    showScreen('home');
                    // Set home tab as active
                    document.querySelector('.nav-item[onclick="switchTab(\'home\')"]')?.classList.add('active');
                    break;
                case 'notifications':
                    // Cleanup issues listener when leaving
                    if (issuesUnsubscribe) {
                        issuesUnsubscribe();
                        issuesUnsubscribe = null;
                    }
                    showNotificationsScreen();
                    // Set notifications tab as active
                    document.querySelector('.nav-item[onclick="switchTab(\'notifications\')"]')?.classList.add('active');
                    break;
                case 'bills':
                    // Cleanup issues listener when leaving
                    if (issuesUnsubscribe) {
                        issuesUnsubscribe();
                        issuesUnsubscribe = null;
                    }
                    showScreen('bills');
                    renderBillsList(); // Refresh bills data
                    // Set bills tab as active
                    document.querySelector('.nav-item[onclick="switchTab(\'bills\')"]')?.classList.add('active');
                    break;
                case 'feedback':
                    showCreateIssueScreen();
                    // Set feedback tab as active
                    document.querySelector('.nav-item[onclick="switchTab(\'feedback\')"]')?.classList.add('active');
                    break;
                case 'profile':
                    // Cleanup issues listener when leaving
                    if (issuesUnsubscribe) {
                        issuesUnsubscribe();
                        issuesUnsubscribe = null;
                    }
                    showProfileScreen();
                    break;
            }
        };

        // Function to control app interaction based on login status
        function updateAppInteractionState() {
            const homeScreen = document.getElementById('home-screen');
            const bottomNav = document.querySelector('.bottom-nav');
            const body = document.body;
            
            if (!currentUser) {
                // Ch∆∞a ƒëƒÉng nh·∫≠p - disable scroll v√† interaction
                console.log('üîí Ch∆∞a ƒëƒÉng nh·∫≠p - disable interaction');
                body.classList.add('no-scroll');
                homeScreen?.classList.add('disabled-interaction');
                
                // Disable t·∫•t c·∫£ nav items except home
                document.querySelectorAll('.nav-item').forEach((item, index) => {
                    if (index !== 0) { // home is first item (index 0)
                        item.style.opacity = '0.5';
                        item.style.pointerEvents = 'none';
                    }
                });
            } else {
                // ƒê√£ ƒëƒÉng nh·∫≠p - enable l·∫°i t·∫•t c·∫£
                console.log('üîì ƒê√£ ƒëƒÉng nh·∫≠p - enable interaction');
                body.classList.remove('no-scroll');
                homeScreen?.classList.remove('disabled-interaction');
                
                // Enable t·∫•t c·∫£ nav items
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.style.opacity = '1';
                    item.style.pointerEvents = 'auto';
                });
            }
        }

        // Setup event listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('phone-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            
            // Event delegation for notification clicks
            document.addEventListener('click', (e) => {
                console.log('üñ±Ô∏è Document click detected:', e.target);
                
                const notificationItem = e.target.closest('.notification-item');
                if (notificationItem) {
                    console.log('üéØ Found notification item:', notificationItem);
                    
                    const notificationId = notificationItem.getAttribute('data-notification-id');
                    const isUnread = notificationItem.getAttribute('data-is-unread') === 'true';
                    
                    console.log('ÔøΩ Notification data:', { notificationId, isUnread });
                    
                    if (notificationId && isUnread) {
                        console.log('‚úÖ Calling markNotificationAsRead...');
                        markNotificationAsRead(notificationId, isUnread);
                    } else {
                        console.log('‚è≠Ô∏è Skipping: already read or no ID');
                    }
                } else {
                    console.log('‚ùå Not a notification item');
                }
            });
        });

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' VNƒê';
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else if (typeof timestamp === 'string') {
                date = new Date(timestamp);
            } else {
                date = new Date(timestamp);
            }
            return date.toLocaleDateString('vi-VN');
        }

        // H√†m hi·ªÉn th·ªã toast notification
        function showToast(message, type = 'success') {
            // T·∫°o toast element
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : (type === 'info' ? 'bg-blue-500' : 'bg-green-600');
            toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium transform transition-all duration-300 translate-x-full ${bgColor}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // --- NOTIFICATION SYSTEM ---
        let notifications = [];
        let shownPopupNotifications = new Set(); // Cache ƒë·ªÉ tr√°nh duplicate popup

        function requestNotificationPermission() {
            console.log('üîî Ki·ªÉm tra quy·ªÅn th√¥ng b√°o...');
            
            if (!('Notification' in window)) {
                console.log('‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ push notifications');
                return;
            }
            
            const currentPermission = Notification.permission;
            console.log('üîî Quy·ªÅn hi·ªán t·∫°i:', currentPermission);
            
            if (currentPermission === 'granted') {
                console.log('‚úÖ ƒê√£ c√≥ quy·ªÅn th√¥ng b√°o');
                // Test notification ƒë·ªÉ ƒë·∫£m b·∫£o ho·∫°t ƒë·ªông - T·∫ÆT ƒêI
                // setTimeout(() => {
                //     showNotification('N-Home', 'üîî Th√¥ng b√°o ƒë√£ s·∫µn s√†ng! B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c c·∫≠p nh·∫≠t khi c√≥ h√≥a ƒë∆°n m·ªõi.');
                // }, 1000);
                return;
            }
            
            if (currentPermission === 'default') {
                // T·∫ÆT popup confirm notification - g√¢y kh√≥ ch·ªãu
                console.log('üîï Notification permission default - kh√¥ng t·ª± ƒë·ªông h·ªèi ƒë·ªÉ tr√°nh spam popup');
                localStorage.setItem('notificationPermissionAsked', 'true');
                return;
            }
            
            if (currentPermission === 'denied') {
                console.log('‚ùå Quy·ªÅn th√¥ng b√°o b·ªã t·ª´ ch·ªëi');
                // Ch·ªâ hi·ªán th√¥ng b√°o h∆∞·ªõng d·∫´n 1 l·∫ßn
                if (!localStorage.getItem('notificationDeniedNotified')) {
                    setTimeout(() => {
                        showToast('üí° ƒê·ªÉ nh·∫≠n th√¥ng b√°o, h√£y b·∫≠t "Notifications" trong c√†i ƒë·∫∑t tr√¨nh duy·ªát', 'info');
                        localStorage.setItem('notificationDeniedNotified', 'true');
                    }, 3000);
                }
            }
        }

        let lastNotificationTime = 0;
        const NOTIFICATION_COOLDOWN = 10000; // 10 gi√¢y cooldown
        
        function showNotification(title, body) {
            console.log('üîî Attempting to show notification:', title);
            console.log('üîî Notification permission:', Notification.permission);
            
            // Debounce - tr√°nh spam notifications
            const now = Date.now();
            if (now - lastNotificationTime < NOTIFICATION_COOLDOWN) {
                console.log('‚è±Ô∏è Notification cooldown active, skipping...');
                return;
            }
            lastNotificationTime = now;
            
            if (!('Notification' in window)) {
                console.log('‚ùå Browser kh√¥ng h·ªó tr·ª£ notifications');
                return;
            }
            
            // T·∫ÆT t·ª± ƒë·ªông y√™u c·∫ßu quy·ªÅn notification - g√¢y spam popup
            if (Notification.permission === 'default') {
                console.log('üîï Notification permission ch∆∞a c√≥ - kh√¥ng t·ª± ƒë·ªông h·ªèi ƒë·ªÉ tr√°nh spam');
                return;
            }
            
            if (Notification.permission === 'granted') {
                displayPushNotification(title, body);
            } else if (Notification.permission === 'denied') {
                console.log('‚ö†Ô∏è Quy·ªÅn th√¥ng b√°o b·ªã t·ª´ ch·ªëi - hi·ªán alert thay th·∫ø');
                // Fallback: hi·ªán alert n·∫øu b·ªã t·ª´ ch·ªëi quy·ªÅn
                setTimeout(() => {
                    alert(`üì¢ ${title}\n${body}`);
                }, 100);
            }
        }
        
        function displayPushNotification(title, body) {
            try {
                console.log('‚úÖ Hi·ªÉn th·ªã push notification:', title);
                
                // T·∫°o unique tag ƒë·ªÉ tr√°nh ghi ƒë√® notifications
                const uniqueTag = `n-home-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
                
                const notification = new Notification(title, {
                    body: body,
                    icon: '/icon-nen-xanh.jpg',
                    tag: uniqueTag,
                    badge: '/icon-nen-xanh.jpg',
                    requireInteraction: false, // Kh√¥ng y√™u c·∫ßu t∆∞∆°ng t√°c (tr√°nh l·ªói)
                    renotify: true, // Lu√¥n hi·ªÉn th·ªã notification m·ªõi
                    vibrate: [200, 100, 200], // Rung nh·∫π h∆°n
                    // Kh√¥ng d√πng actions v√¨ ch·ªâ support trong Service Worker
                    data: {
                        timestamp: Date.now(),
                        url: window.location.href
                    }
                });
                
                // T·ª± ƒë·ªông ƒë√≥ng sau 10 gi√¢y (d√†i h∆°n ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y)
                setTimeout(() => {
                    if (notification) {
                        notification.close();
                    }
                }, 10000);
                
                // Click ƒë·ªÉ m·ªü app
                notification.onclick = function(event) {
                    event.preventDefault();
                    window.focus();
                    notification.close();
                };
                
                console.log('‚úÖ Push notification hi·ªÉn th·ªã th√†nh c√¥ng');
            } catch (error) {
                console.error('‚ùå L·ªói t·∫°o push notification:', error);
            }
        }        // 4 lo·∫°i th√¥ng b√°o ch√≠nh THEO Y√äU C·∫¶U
        // Debounce ƒë·ªÉ tr√°nh spam notification
        let notificationDebounce = {};
        
        window.createNotification = function(type, title, message, data = {}) {
            // T·∫°o debounce key ƒë·ªÉ tr√°nh duplicate
            const debounceKey = `${type}_${data.billId || data.taskId || Date.now()}`;
            
            // N·∫øu notification n√†y v·ª´a ƒë∆∞·ª£c t·∫°o trong 2 gi√¢y qua, b·ªè qua
            if (notificationDebounce[debounceKey] && Date.now() - notificationDebounce[debounceKey] < 2000) {
                return;
            }
            notificationDebounce[debounceKey] = Date.now();
            
            // T·∫°o unique ID d·ª±a tr√™n Firebase ID n·∫øu c√≥, n·∫øu kh√¥ng th√¨ d√πng timestamp
            const uniqueId = data.firebaseId || `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            const notification = {
                id: uniqueId,
                type: type, // 'bill_approved', 'payment_received', 'issue_created', 'issue_resolved'
                title: title,
                message: message,
                data: data,
                isRead: false, // M·ªçi th√¥ng b√°o m·ªõi ƒë·ªÅu ch∆∞a ƒë·ªçc
                createdAt: new Date().toISOString()
            };
            
            // Ki·ªÉm tra xem th√¥ng b√°o ƒë√£ t·ªìn t·∫°i ch∆∞a (theo ID)
            const existingIndex = notifications.findIndex(n => n.id === uniqueId);
            if (existingIndex !== -1) {
                // console.log('‚ö†Ô∏è Notification already exists, keeping read status...');
                // Gi·ªØ nguy√™n tr·∫°ng th√°i isRead n·∫øu notification ƒë√£ t·ªìn t·∫°i
                notification.isRead = notifications[existingIndex].isRead;
                notifications[existingIndex] = notification;
            } else {
                // console.log('‚úÖ Adding new notification');
                notifications.unshift(notification);
            }
            
            saveNotificationsToStorage();
            
            // ‚úÖ C·∫¨P NH·∫¨T UI NGAY L·∫¨P T·ª®C
            renderNotificationsList();
            
            // console.log('üîî Creating notification popup for:', title);
            // console.log('üîî Total notifications after add:', notifications.length);
            
            // Ch·ªâ hi·ªán popup n·∫øu ch∆∞a t·ª´ng hi·ªán cho notification n√†y
            const popupKey = uniqueId + '_' + title + '_' + message.substring(0, 50);
            if (!shownPopupNotifications.has(popupKey)) {
                // console.log('üîî Showing popup for new notification:', uniqueId);
                shownPopupNotifications.add(popupKey);
                showNotification(title, message);
                
                // T·ª± ƒë·ªông x√≥a kh·ªèi cache sau 5 ph√∫t ƒë·ªÉ tr√°nh memory leak
                setTimeout(() => {
                    shownPopupNotifications.delete(popupKey);
                }, 5 * 60 * 1000);
            } else {
                console.log('‚è≠Ô∏è Skipping duplicate popup for:', uniqueId);
            }
            
            return notification;
        };

        // H√†m t·∫°o s·ª± c·ªë/c√¥ng vi·ªác (s·∫Ω ƒë∆∞·ª£c g·ªçi t·ª´ UI c·ªßa kh√°ch h√†ng)
        window.createIssue = async function(issueData) {
            try {
                const taskData = {
                    title: issueData.title,
                    description: issueData.description,
                    customerId: currentUser.id,
                    buildingId: issueData.buildingId || contracts[0]?.buildingId,
                    roomNumber: issueData.roomNumber || contracts[0]?.roomNumber,
                    priority: issueData.priority || 'medium',
                    status: 'pending',
                    type: 'issue', // Ph√¢n lo·∫°i l√† s·ª± c·ªë t·ª´ kh√°ch
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                // L∆∞u v√†o Firebase
                const docRef = await addDoc(collection(db, 'tasks'), taskData);
                
                showToast('ƒê√£ g·ª≠i b√°o c√°o s·ª± c·ªë th√†nh c√¥ng!');
                
                return { id: docRef.id, ...taskData };
            } catch (error) {
                console.error('Error creating issue:', error);
                showToast('L·ªói g·ª≠i b√°o c√°o s·ª± c·ªë', 'error');
                throw error;
            }
        };

        function saveNotificationsToStorage() {
            // S·ª≠ d·ª•ng unified cache system thay v√¨ dual storage
            if (currentUser?.id) {
                const existingCache = loadUserDataFromCache(currentUser.id) || {};
                existingCache.notifications = notifications;
                saveUserDataToCache(currentUser.id, existingCache);
                console.log('üíæ Saved notifications to unified cache system');
            }
        }

        function removeNotificationByFirebaseId(firebaseId) {
            console.log('üóëÔ∏è Attempting to remove notification with Firebase ID:', firebaseId);
            const initialLength = notifications.length;
            
            // X√≥a th√¥ng b√°o c√≥ firebaseId t∆∞∆°ng ·ª©ng
            notifications = notifications.filter(notification => 
                notification.data?.firebaseId !== firebaseId
            );
            
            const removedCount = initialLength - notifications.length;
            console.log('üóëÔ∏è Removed', removedCount, 'notification(s) from local storage');
            
            if (removedCount > 0) {
                saveNotificationsToStorage();
                
                // Refresh danh s√°ch th√¥ng b√°o n·∫øu ƒëang hi·ªÉn th·ªã
                if (!document.getElementById('notifications-screen').classList.contains('hidden')) {
                    renderNotificationsList();
                }
                
                showToast('Th√¥ng b√°o ƒë√£ ƒë∆∞·ª£c x√≥a', 'info');
            }
        }

        function loadNotificationsFromStorage() {
            // ƒê√£ ƒë∆∞·ª£c load trong setupRealtimeListeners t·ª´ unified cache system
            // Kh√¥ng c·∫ßn load ri√™ng n·ªØa ƒë·ªÉ tr√°nh conflict
            console.log('üìñ Notifications already loaded from unified cache system');
        }

        // H√†m x√≥a t·∫•t c·∫£ th√¥ng b√°o c≈© (ƒë·ªÉ test)
        window.clearAllNotifications = function() {
            const userPhone = localStorage.getItem('userPhone');
            if (userPhone) {
                // X√≥a old notification storage
                localStorage.removeItem(`notifications_${userPhone}`);
            }
            
            // Clear from unified cache system
            if (currentUser?.id) {
                const existingCache = loadUserDataFromCache(currentUser.id) || {};
                existingCache.notifications = [];
                saveUserDataToCache(currentUser.id, existingCache);
            }
            
            notifications = [];
            renderNotificationsList();
            // updateNotificationBadge(); // ƒê√£ g·ªçi trong renderNotificationsList()
            console.log('‚úÖ ƒê√£ x√≥a t·∫•t c·∫£ th√¥ng b√°o kh·ªèi c·∫£ 2 h·ªá th·ªëng storage');
        };
        
        // üîç DEBUG: Performance stats
        window.getPerformanceStats = function() {
            console.table(perfMon.calls);
            return perfMon.calls;
        };
        
        // üß™ Test performance impact
        window.testRenderPerformance = function() {
            console.time('renderAll');
            renderHomeData();
            renderBillsList(); 
            renderNotificationsList();
            console.timeEnd('renderAll');
            console.log('Performance stats:', perfMon.calls);
        };
        
        // üêõ Debug bill status sync
        window.debugBillStatus = function() {
            console.log('=== BILL STATUS DEBUG ===');
            console.log('Bills in memory:', bills.map(b => ({
                id: b.id, 
                status: b.status, 
                paid: b.paid,
                code: b.code || b.billNumber
            })));
            
            const cache = loadUserDataFromCache(currentUser?.id);
            console.log('Bills in cache:', cache?.bills?.map(b => ({
                id: b.id, 
                status: b.status, 
                paid: b.paid,
                code: b.code || b.billNumber
            })));
        };
        
        // üöÄ Optimized DOM utilities
        const $ = {
            navItems: null,
            getNavItems() {
                if (!this.navItems) {
                    this.navItems = document.querySelectorAll('.nav-item');
                }
                return this.navItems;
            },
            updateNavActiveState(activeTab) {
                this.getNavItems().forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('onclick')?.includes(activeTab)) {
                        item.classList.add('active');
                    }
                });
            }
        };

        // H√†m t·∫°o th√¥ng b√°o test
        window.createTestNotification = function() {
            createNotification(
                'payment_received',
                'Test Th√¥ng b√°o',
                'ƒê√¢y l√† th√¥ng b√°o test ƒë·ªÉ ki·ªÉm tra h·ªá th·ªëng ho·∫°t ƒë·ªông.',
                { test: true }
            );
            renderNotificationsList();
            console.log('‚úÖ ƒê√£ t·∫°o th√¥ng b√°o test');
        };

        // H√†m test push notification tr·ª±c ti·∫øp
        window.testPushNotification = function() {
            if (Notification.permission === 'granted') {
                displayPushNotification(
                    'üîî Test Push Notification',
                    'ƒê√¢y l√† test push notification xu·∫•t hi·ªán tr√™n m√†n h√¨nh ƒëi·ªán tho·∫°i! üì±'
                );
                console.log('‚úÖ ƒê√£ test push notification');
            } else {
                console.log('‚ùå C·∫ßn quy·ªÅn th√¥ng b√°o ƒë·ªÉ test');
                requestNotificationPermission();
            }
        };
        
        // H√†m t·∫°o nhi·ªÅu lo·∫°i th√¥ng b√°o test kh√°c nhau
        window.testAllNotifications = function() {
            const testTypes = [
                { type: 'bill_approved', title: 'üí∞ H√≥a ƒë∆°n m·ªõi', message: 'B·∫°n c√≥ h√≥a ƒë∆°n th√°ng 11 c·∫ßn thanh to√°n.' },
                { type: 'payment_received', title: '‚úÖ Thanh to√°n th√†nh c√¥ng', message: 'H√≥a ƒë∆°n c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c thanh to√°n.' },
                { type: 'issue_resolved', title: 'üîß S·ª± c·ªë ƒë√£ x·ª≠ l√Ω', message: 'S·ª± c·ªë ƒëi·ªán trong ph√≤ng ƒë√£ ƒë∆∞·ª£c kh·∫Øc ph·ª•c.' },
                { type: 'announcement', title: 'üì¢ Th√¥ng b√°o', message: 'S·∫Ω c·∫Øt ƒëi·ªán b·∫£o tr√¨ t·ª´ 8h-10h ng√†y mai.' }
            ];
            
            testTypes.forEach((test, index) => {
                setTimeout(() => {
                    createNotification(test.type, test.title, test.message, { test: true, index: index });
                }, index * 2000); // C√°ch nhau 2 gi√¢y
            });
            
            console.log('‚úÖ ƒêang test t·∫•t c·∫£ lo·∫°i th√¥ng b√°o...');
        };

        // Debug function
        window.debugNotifications = function() {
            console.log('=== NOTIFICATION DEBUG ===');
            console.log('üì± User phone:', localStorage.getItem('userPhone'));
            console.log('üî¢ Notifications count:', notifications.length);
            console.log('üìã Notifications:', notifications);
            console.log('üè† Current user:', currentUser);
            console.log('üí∞ Bills count:', bills.length);
            console.log('==========================');
        };

        window.markAllAsRead = function() {
            notifications.forEach(n => n.isRead = true);
            saveNotificationsToStorage();
            renderNotificationsList();
        };

        // Mark notification as read when clicked
        window.markNotificationAsRead = async function(notificationId, isCurrentlyUnread) {
            console.log('üñ±Ô∏è markNotificationAsRead called:', { notificationId, isCurrentlyUnread });
            
            if (!isCurrentlyUnread) {
                console.log('‚è≠Ô∏è Already read, skipping');
                return; // Already read, no action needed
            }
            
            console.log('üîÑ Marking notification as read:', notificationId);
            
            try {
                // Skip Firestore update - ch·ªâ update local state ƒë·ªÉ tr√°nh l·ªói permission
                // V√¨ adminNotifications ƒë∆∞·ª£c t·∫°o b·ªüi admin, user kh√¥ng c√≥ quy·ªÅn update
                // const notificationRef = doc(db, 'adminNotifications', notificationId);
                // await updateDoc(notificationRef, { isRead: true });
                
                console.log('Skipping Firestore update - updating local state only');
                
                // Update local data
                const localIndex = notifications.findIndex(n => n.id === notificationId);
                console.log('üîç Finding notification in local array:', localIndex, 'total notifications:', notifications.length);
                
                if (localIndex !== -1) {
                    console.log('‚úÖ Found notification, updating isRead to true');
                    notifications[localIndex].isRead = true;
                } else {
                    console.log('‚ùå Notification not found in local array!');
                }
                
                // Update localStorage using consistent key
                saveNotificationsToStorage();
                console.log('üíæ Updated localStorage');
                
                // Re-render notifications list
                // console.log('üé® Re-rendering notifications list...');
                renderNotificationsList();
                console.log('‚úÖ Done marking as read');
                
            } catch (error) {
                console.error('Error in markNotificationAsRead:', error.message || error);
                // Continue with local update even if Firestore fails
            }
        };

        function showNotificationsScreen() {
            showScreen('notifications');
        }

        // Debounce ƒë·ªÉ tr√°nh render qu√° nhi·ªÅu
        let renderNotificationsTimeout = null;
        
        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            if (!badge) return;
            
            const unreadCount = notifications.filter(n => !n.isRead).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function renderNotificationsList() {
            // Debounce ƒë·ªÉ tr√°nh spam rendering
            if (renderNotificationsTimeout) {
                clearTimeout(renderNotificationsTimeout);
            }
            
            renderNotificationsTimeout = setTimeout(() => {
                _actualRenderNotificationsList();
            }, 50);
        }
        
        function _actualRenderNotificationsList() {
            perfMon.track('renderNotificationsList');
            const startTime = performance.now();
            const listEl = document.getElementById('notifications-list');
            if (!listEl) return;
            
            // C·∫≠p nh·∫≠t badge
            updateNotificationBadge();
            
            if (notifications.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-20 h-20 mx-auto mb-4 bg-gray-50 rounded-full flex items-center justify-center border border-gray-200">
                            <svg class="w-10 h-10 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                <path d="m18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                            </svg>
                        </div>
                        <p class="text-gray-500">${currentLanguage === 'en' ? 'No notifications' : 'Ch∆∞a c√≥ th√¥ng b√°o n√†o'}</p>
                    </div>
                `;
                return;
            }

            // Virtual scrolling cho danh s√°ch d√†i
            const maxVisible = 50; // Ch·ªâ render t·ªëi ƒëa 50 items
            const visibleNotifications = notifications.slice(0, maxVisible);
            
            listEl.innerHTML = visibleNotifications.map(notification => {
                const dateTime = formatDateTime(notification.createdAt);
                const isUnread = !notification.isRead;
                
                // Translate notification content
                const translatedTitle = translateNotificationTitle(notification.title);
                const translatedMessage = translateNotificationMessage(notification.message);
                
                return `
                    <div class="notification-item bg-white p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 ${isUnread ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''}" 
                         data-notification-id="${notification.id}" 
                         data-is-unread="${isUnread}"
                         onclick="if(${isUnread}) markNotificationAsRead('${notification.id}', ${isUnread});">
                        <div class="flex items-start gap-3">
                            <div class="w-12 h-12 rounded-lg bg-green-600 flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                    <path d="m18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-semibold text-gray-900 text-base mb-1 ${isUnread ? 'font-bold' : ''}">${translatedTitle}</h3>
                                <p class="text-gray-600 text-sm leading-relaxed mb-2">${translatedMessage}</p>
                                <div class="flex items-center text-gray-400 text-xs">
                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                                    </svg>
                                    ${dateTime}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu c√≥ nhi·ªÅu h∆°n maxVisible
            if (notifications.length > maxVisible) {
                listEl.innerHTML += `
                    <div class="text-center py-4 bg-gray-50 border-t">
                        <p class="text-gray-600 text-sm">Hi·ªÉn th·ªã ${maxVisible}/${notifications.length} th√¥ng b√°o m·ªõi nh·∫•t</p>
                        <button onclick="clearAllNotifications()" class="mt-2 text-blue-600 text-sm hover:underline">
                            X√≥a t·∫•t c·∫£ ƒë·ªÉ c·∫£i thi·ªán hi·ªáu su·∫•t
                        </button>
                    </div>
                `;
            }
            
            const endTime = performance.now();
            if (endTime - startTime > 50) {
                console.warn(`‚ö†Ô∏è Slow notifications render: ${(endTime - startTime).toFixed(1)}ms for ${visibleNotifications.length}/${notifications.length} items`);
            }
        }

        function translateNotificationTitle(title) {
            if (currentLanguage === 'en') {
                if (title.includes('Th√¥ng b√°o h√≥a ƒë∆°n')) {
                    return 'Bill Notification';
                }
                return title;
            }
            return title;
        }

        function translateNotificationMessage(message) {
            if (currentLanguage === 'en') {
                if (message.includes('B·∫°n c√≥ h√≥a ƒë∆°n ti·ªÅn nh√† th√°ng')) {
                    return message
                        .replace('B·∫°n c√≥ h√≥a ƒë∆°n ti·ªÅn nh√† th√°ng', 'You have a monthly rent bill for')
                        .replace('c·∫ßn thanh to√°n', 'that needs payment')
                        .replace('Vui l√≤ng ki·ªÉm tra v√† thanh to√°n ƒë√∫ng h·∫°n', 'Please check and pay on time');
                }
                return message;
            }
            return message;
        }

        // Global function to translate service names in bills
        function translateBillServiceName(name) {
            if (currentLanguage === 'en') {
                const lowerName = name.toLowerCase();
                if (lowerName.includes('ti·ªÅn nh√†') || lowerName.includes('thu√™ ph√≤ng') || lowerName.includes('rent')) return 'Rent';
                if (lowerName.includes('ti·ªÅn ƒëi·ªán') || lowerName.includes('ƒëi·ªán')) return 'Electricity';
                if (lowerName.includes('ti·ªÅn n∆∞·ªõc') || lowerName.includes('n∆∞·ªõc')) return 'Water';
                if (lowerName.includes('d·ªãch v·ª• chung') || lowerName.includes('common')) return 'Common Service';
                if (lowerName.includes('ti·ªÅn xe') || lowerName.includes('parking')) return 'Parking';
                return name;
            }
            return name;
        }

        function getNotificationIcon(type) {
            switch(type) {
                case 'bill_approved':
                    return '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>';
                case 'payment_received':
                    return '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4z"/><path d="M9 12a1 1 0 102 0V8a1 1 0 10-2 0v4z"/><path d="M9 15a1 1 0 011-1h0a1 1 0 110 2h0a1 1 0 01-1-1z"/></svg>';
                case 'issue_created':
                    return '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>';
                case 'issue_resolved':
                    return '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>';
                default:
                    return '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>';
            }
        }

        function getNotificationIconColor(type) {
            switch(type) {
                case 'bill_approved': return 'bg-blue-500';
                case 'payment_received': return 'bg-green-600';
                case 'issue_created': return 'bg-orange-500';
                case 'issue_resolved': return 'bg-green-600';
                default: return 'bg-gray-500';
            }
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${day}-${month}-${year} ${hours}:${minutes}`;
        }

        function formatTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'V·ª´a xong';
            if (diffMins < 60) return `${diffMins} ph√∫t tr∆∞·ªõc`;
            if (diffHours < 24) return `${diffHours} gi·ªù tr∆∞·ªõc`;
            if (diffDays < 7) return `${diffDays} ng√†y tr∆∞·ªõc`;
            return date.toLocaleDateString('vi-VN');
        }

        // --- PROFILE FUNCTIONS ---
        
        window.showProfileScreen = function() {
            console.log('üîß showProfileScreen called');
            showScreen('profile');
            
            // Update navigation to profile
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector('.nav-item[onclick="switchTab(\'profile\')"]')?.classList.add('active');
        };

        function loadProfileData() {
            console.log('üîß loadProfileData called', currentUser);
            if (currentUser) {
                document.getElementById('profile-name').textContent = currentUser.name || 'Kh√°ch h√†ng';
                document.getElementById('profile-fullname').textContent = currentUser.name || 'Ch∆∞a c·∫≠p nh·∫≠t';
                document.getElementById('profile-phone').textContent = currentUser.phone || 'Ch∆∞a c·∫≠p nh·∫≠t';
                
                // Load avatar if exists
                const savedAvatar = localStorage.getItem(`avatar_${currentUser.phone}`);
                if (savedAvatar) {
                    document.getElementById('profile-avatar').src = savedAvatar;
                }
                
                // Load language preference
                const savedLanguage = localStorage.getItem('app_language') || 'vi';
                const languageRadio = document.querySelector(`input[name="language"][value="${savedLanguage}"]`);
                if (languageRadio) {
                    languageRadio.checked = true;
                }
            } else {
                console.log('‚ùå No currentUser data');
            }
        }

        window.changeAvatar = function() {
            document.getElementById('avatar-input').click();
        };

        window.handleAvatarChange = function(input) {
            const file = input.files[0];
            if (file) {
                // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (max 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    alert('·∫¢nh qu√° l·ªõn! Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n 2MB');
                    return;
                }
                
                // Ki·ªÉm tra lo·∫°i file
                if (!file.type.startsWith('image/')) {
                    alert('Vui l√≤ng ch·ªçn file ·∫£nh!');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const avatarImg = document.getElementById('profile-avatar');
                    avatarImg.src = e.target.result;
                    
                    // L∆∞u v√†o localStorage
                    if (currentUser?.phone) {
                        localStorage.setItem(`avatar_${currentUser.phone}`, e.target.result);
                        showToast('ƒê√£ c·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán!', 'success');
                    }
                };
                reader.readAsDataURL(file);
            }
        };

        // Debug function to check all screens
        window.debugScreens = function() {
            console.log('=== SCREEN DEBUG ===');
            const screens = ['home-screen', 'bills-screen', 'notifications-screen', 'create-issue-screen', 'issue-form-screen', 'profile-screen'];
            screens.forEach(screenId => {
                const element = document.getElementById(screenId);
                console.log(`${screenId}:`, element ? 'EXISTS' : 'NOT FOUND', element?.classList.contains('hidden') ? 'HIDDEN' : 'VISIBLE');
            });
            console.log('====================');
        };

        // Language change handler
        document.addEventListener('change', (e) => {
            if (e.target.name === 'language') {
                const selectedLanguage = e.target.value;
                localStorage.setItem('app_language', selectedLanguage);
                
                // TODO: Implement language change logic
                showToast(`ƒê√£ ch·ªçn ng√¥n ng·ªØ: ${e.target.parentElement.textContent.trim()}`, 'success');
                
                // Placeholder for future language implementation
                console.log('Selected language:', selectedLanguage);
            }
        });

        // Auto refresh - T·∫ÆTƒêI V√å ƒê√É C√ì REAL-TIME LISTENERS
        // setInterval(async () => {
        //     if (currentUser) {
        //         await loadUserData(currentUser.id);
        //         renderHomeData();
        //         renderBillsList();
        //     }
        // }, 30000);

        // Initialize app when page loads
        // Initialize language system
        function initLanguageSystem() {
            // Set initial language from localStorage
            const savedLang = localStorage.getItem('language') || 'vi';
            currentLanguage = savedLang;
            
            // Set radio button state
            const radioButtons = document.querySelectorAll('input[name="language"]');
            radioButtons.forEach(radio => {
                radio.checked = radio.value === savedLang;
            });
            
            // Add event listeners for language change
            radioButtons.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        switchLanguage(e.target.value);
                    }
                });
            });
        }

        initApp();
        
        // Test function for manual language switch
        window.testLanguageSwitch = function(lang) {
            console.log('üß™ Manual language switch test:', lang);
            switchLanguage(lang);
        };
        
        // üß™ Cache test functions
        window.clearUserCache = function() {
            const userPhone = localStorage.getItem('userPhone');
            if (userPhone) {
                localStorage.removeItem(`n_home_user_${userPhone}`);
                console.log('üóëÔ∏è ƒê√£ x√≥a cache user:', userPhone);
            }
        };
        
        window.getUserCacheInfo = function() {
            const userPhone = localStorage.getItem('userPhone');
            if (!userPhone) return 'Ch∆∞a ƒëƒÉng nh·∫≠p';
            
            const cached = localStorage.getItem(`n_home_user_${userPhone}`);
            if (!cached) return 'Ch∆∞a c√≥ cache';
            
            try {
                const cacheData = JSON.parse(cached);
                return {
                    user: userPhone,
                    version: cacheData.version,
                    timestamp: new Date(cacheData.timestamp).toLocaleString(),
                    size: `${(cached.length / 1024).toFixed(1)} KB`,
                    bills: cacheData.data?.bills?.length || 0,
                    notifications: cacheData.data?.notifications?.length || 0
                };
            } catch (error) {
                return 'Cache b·ªã l·ªói';
            }
        };
        
        function updateBillDetailScreen() {
            // console.log('üí≥ Updating bill detail screen, current language:', currentLanguage);
            
            const titleEl = document.getElementById('bill-detail-title');
            if (titleEl) {
                titleEl.textContent = currentLanguage === 'en' ? 'Bill Details' : 'Chi ti·∫øt h√≥a ƒë∆°n';
            }
        }

        function updateIssueFormScreen() {
            console.log('üìù Updating issue form screen, current language:', currentLanguage);
            
            const titleEl = document.getElementById('report-issue-title');
            if (titleEl) {
                titleEl.textContent = t('reportIssueTitle');
            }
            
            const infoTitle = document.getElementById('issue-info-title');
            if (infoTitle) {
                infoTitle.textContent = t('issueInfo');
            }
            
            const descLabel = document.getElementById('description-label');
            if (descLabel) {
                descLabel.textContent = t('detailedDescription') + ' *';
            }
            
            const textarea = document.getElementById('issue-description');
            if (textarea) {
                textarea.placeholder = t('descriptionPlaceholder');
            }
            
            const imagesLabel = document.getElementById('images-label');
            if (imagesLabel) {
                const count = imagesLabel.textContent.match(/\((\d+)\/5\)/)?.[1] || '0';
                imagesLabel.textContent = `${t('images')} (${count}/5)`;
            }
            
            const addImageText = document.getElementById('add-image-text');
            if (addImageText) {
                addImageText.textContent = t('addImage');
            }
            
            const chooseBtn = document.getElementById('choose-device-btn');
            if (chooseBtn) {
                chooseBtn.textContent = t('chooseFromDevice');
            }
            
            const submitBtn = document.getElementById('submit-issue-btn');
            if (submitBtn) {
                submitBtn.textContent = t('submitIssueBtn');
            }
            
            const cancelBtn = document.getElementById('cancel-btn');
            if (cancelBtn) {
                cancelBtn.textContent = t('cancel');
            }
        }

        // Initialize language system when DOM is ready
        document.addEventListener('DOMContentLoaded', initLanguageSystem);
        
        // Fix English flag after page load
        setTimeout(() => {
            const englishFlag = document.querySelector('input[value="en"]').parentElement.querySelector('.text-2xl');
            if (englishFlag && englishFlag.textContent.includes('ÔøΩ')) {
                englishFlag.textContent = 'EN';
                englishFlag.className = 'w-8 h-6 mr-2 bg-blue-600 text-white text-xs rounded flex items-center justify-center font-bold';
            }
        }, 1000);
    </script>

    </div> <!-- End app-container -->

    <!-- PWA Install & Service Worker -->
    <script>
        // üîÆ BROWSER DECEPTION TRICKS - Make this app appear completely different
        // Change user agent to trick browser
        Object.defineProperty(navigator, 'userAgent', {
            get: function() { return navigator.userAgent + ' CustomerApp/1.0'; }
        });
        
        // Different app name in navigator
        Object.defineProperty(navigator, 'appName', {
            get: function() { return 'N-Home Customer'; }
        });
        
        // Modify window name
        window.name = 'n-home-customer-app';
        
        // Different localStorage prefix
        const originalSetItem = localStorage.setItem;
        const originalGetItem = localStorage.getItem;
        localStorage.setItem = function(key, value) {
            return originalSetItem.call(this, 'customer_' + key, value);
        };
        localStorage.getItem = function(key) {
            return originalGetItem.call(this, 'customer_' + key);
        };
        
        // Service Worker Registration cho Customer App PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // FORCE clear all old caches first
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            if (name.includes('n-home')) {
                                console.log('üóëÔ∏è Force clearing cache:', name);
                                caches.delete(name);
                            }
                        });
                    });
                }
                
                // Register customer service worker for PWA with force update
                navigator.serviceWorker.register('/customer-sw.js')
                    .then(registration => {
                        console.log('‚úÖ N-Home Customer SW registered:', registration.scope);
                        // Force update service worker
                        registration.update();
                        if (registration.waiting) {
                            registration.waiting.postMessage({type: 'SKIP_WAITING'});
                        }
                    })
                    .catch(error => {
                        console.log('‚ùå Customer SW registration failed:', error);
                    });
                
                // Also register Firebase messaging SW (kh√¥ng conflict)
                navigator.serviceWorker.register('/firebase-messaging-sw.js')
                    .then(registration => {
                        console.log('‚úÖ Firebase Messaging Service Worker registered:', registration.scope);
                        
                        // C·∫•u h√¨nh Firebase Messaging v·ªõi service worker
                        if (messaging) {
                            messaging.useServiceWorker(registration);
                        }
                    });
                
                // FORCE clear app cache ƒë·ªÉ ƒë·ªìng b·ªô data c≈©
                if ('caches' in window) {
                    caches.keys().then(cacheNames => {
                        cacheNames.forEach(cacheName => {
                            if (cacheName.includes('customer') && !cacheName.includes('v4')) {
                                console.log('üóëÔ∏è Clearing old customer cache:', cacheName);
                                caches.delete(cacheName);
                            }
                        });
                    });
                }
                    .catch(error => {
                        console.log('‚ùå Service Worker registration failed:', error);
                    });
            });
        }

        // PWA Install Prompt - Customer App (SIMPLIFIED LIKE ADMIN)
        let deferredPrompt;

        // PWA Install Prompt event - SAME AS ADMIN
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWA Install prompt event fired (Customer)');
            e.preventDefault();
            deferredPrompt = e;
            showCustomerInstallPrompt();
        });

        // Show custom install prompt - EXACT COPY OF ADMIN
        function showCustomerInstallPrompt() {
            console.log('Showing customer install prompt...');
            
            // Remove existing prompt if any
            const existing = document.getElementById('pwa-customer-install-prompt');
            if (existing) {
                existing.remove();
            }
            
            // Create popup install
            const installPrompt = document.createElement('div');
            installPrompt.id = 'pwa-customer-install-prompt';
            installPrompt.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; padding: 24px; margin: 20px; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
                        <div style="width: 60px; height: 60px; margin: 0 auto 16px; background-image: url('/icon-nen-xanh.jpg'); background-size: cover; border-radius: 12px;"></div>
                        <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: bold; color: #1f2937;">C√†i ƒë·∫∑t N-Home</h3>
                        <p style="margin: 0 0 20px 0; color: #6b7280; font-size: 14px;">C√†i ƒë·∫∑t ·ª©ng d·ª•ng ƒë·ªÉ truy c·∫≠p nhanh h∆°n v√† nh·∫≠n th√¥ng b√°o</p>
                        <div style="display: flex; gap: 12px;">
                            <button id="pwa-customer-install-btn" style="flex: 1; background: #16a34a; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 500; cursor: pointer;">C√†i ƒë·∫∑t</button>
                            <button id="pwa-customer-cancel-btn" style="flex: 1; background: #f3f4f6; color: #6b7280; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 500; cursor: pointer;">B·ªè qua</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(installPrompt);

            // Install button click
            document.getElementById('pwa-customer-install-btn').addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('PWA Customer install outcome:', outcome);
                    deferredPrompt = null;
                } else {
                    // Fallback: H∆∞·ªõng d·∫´n c√†i manual khi kh√¥ng c√≥ deferredPrompt
                    console.log('üîÑ No deferredPrompt - showing manual install guide');
                    alert('üì± ƒê·ªÉ c√†i ƒë·∫∑t app:\n\n' +
                          'üîπ Chrome: B·∫•m menu (‚ãÆ) ‚Üí "Add to Home screen"\n' +
                          'üîπ Safari: B·∫•m Share (üì§) ‚Üí "Add to Home Screen"\n' +
                          'üîπ Edge: B·∫•m menu (‚ãØ) ‚Üí "Apps" ‚Üí "Install this site as an app"');
                }
                document.body.removeChild(installPrompt);
            });

            // Cancel button click
            document.getElementById('pwa-customer-cancel-btn').addEventListener('click', () => {
                document.body.removeChild(installPrompt);
                // L∆∞u tr·∫°ng th√°i ƒë√£ t·ª´ ch·ªëi cho customer app ri√™ng
                localStorage.setItem('pwa-customer-install-dismissed', Date.now());
            });
        }

        // Check if device is mobile - EXACT COPY OF ADMIN
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   window.innerWidth <= 768 || 
                   'ontouchstart' in window;
        }

        // Check if app is installed - EXACT COPY OF ADMIN
        function isAppInstalled() {
            // Method 1: Check display-mode
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            
            // Method 2: Check if opened from home screen
            const isFromHomeScreen = window.navigator.standalone === true;
            
            // Method 3: Check URL params
            const urlParams = new URLSearchParams(window.location.search);
            const isFromPWA = urlParams.get('source') === 'pwa';
            
            console.log('üîç App install check:', { isStandalone, isFromHomeScreen, isFromPWA });
            
            return isStandalone || isFromHomeScreen || isFromPWA;
        }

        // Simple load check - SAME AS ADMIN (no complex logic)
        window.addEventListener('load', () => {
            const isMobile = isMobileDevice();
            const dismissed = localStorage.getItem('pwa-customer-install-dismissed');
            const isInstalled = isAppInstalled();
            
            console.log('üì± Customer app check:', { isMobile, dismissed, isInstalled });
            
            // Simple condition: mobile + not installed + not recently dismissed
            if (isMobile && !isInstalled && (!dismissed || Date.now() - dismissed > 7 * 24 * 60 * 60 * 1000)) {
                // Wait for user to see the page first
                setTimeout(() => {
                    if (deferredPrompt) {
                        showCustomerInstallPrompt();
                    }
                }, 2000);
            }
        });

        // Track if app was installed - SAME AS ADMIN
        window.addEventListener('appinstalled', (evt) => {
            console.log('‚úÖ PWA Customer was installed successfully');
            localStorage.removeItem('pwa-customer-install-dismissed');
        });

        // Check if running as PWA
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('‚úÖ Customer app running as PWA!');
        }
    </script>

    <!-- Firebase Cloud Messaging (FCM) -->
    <script>
        // Firebase Configuration cho FCM - PH·∫¢I KH·ªöP V·ªöI js/firebase.js v√† firebase-messaging-sw.js
        const fcmFirebaseConfig = {
            apiKey: "AIzaSyA2m1K7pijNC1yirw_t36Rc3HnzCsD8pCs",
            authDomain: "nha-tro-53ca7.firebaseapp.com",
            projectId: "nha-tro-53ca7",
            storageBucket: "nha-tro-53ca7.firebasestorage.app",
            messagingSenderId: "415886594203",
            appId: "1:415886594203:web:f3cda09037973176c9763e",
            measurementId: "G-Y5GSRYP4XC"
        };

        // VAPID Key t·ª´ Firebase Console (Project Settings > Cloud Messaging > Web Push certificates)
        const vapidKey = 'BHj9JZW39U-e3JhrHcwEYxgKpLcSTD0JyaFw54agm3CvaXXCYD4q3HBM9_rVv9iOXRs6a2fIhSEeybftXNtrhmc';

        // Kh·ªüi t·∫°o Firebase cho FCM (ch·ªâ khi ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o)
        if (!firebase.apps.length) {
            firebase.initializeApp(fcmFirebaseConfig);
        }
        
        // Kh·ªüi t·∫°o Firebase Messaging
        const messaging = firebase.messaging();
        
        // Bi·∫øn l∆∞u FCM token
        window.fcmToken = null;

        // H√†m xin quy·ªÅn th√¥ng b√°o v√† l·∫•y FCM token
        async function requestNotificationPermission() {
            try {
                if (!('Notification' in window)) {
                    console.error('‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ th√¥ng b√°o');
                    return null;
                }
                
                // T·∫ÆT auto request notification permission ƒë·ªÉ tr√°nh spam popup
                // const permission = await Notification.requestPermission();
                const permission = Notification.permission;
                
                if (permission === 'granted') {
                    try {
                        const token = await messaging.getToken({ vapidKey: vapidKey });
                        
                        if (token) {
                            console.log('‚úÖ FCM token nh·∫≠n th√†nh c√¥ng');
                            window.fcmToken = token;
                            
                            await saveFCMTokenToProfile(token);
                            // showTestNotification(); // T·∫Øt auto test notification
                            return token;
                        }
                    } catch (tokenError) {
                        console.error('‚ùå L·ªói FCM token:', tokenError);
                    }
                } else {
                    console.log('‚ö†Ô∏è C·∫ßn quy·ªÅn th√¥ng b√°o ƒë·ªÉ nh·∫≠n c·∫≠p nh·∫≠t');
                }
            } catch (error) {
                console.error('‚ùå L·ªói requestNotificationPermission:', error);
            }
            return null;
        }

        // L∆∞u FCM token v√†o h·ªì s∆° kh√°ch h√†ng trong Firestore
        async function saveFCMTokenToProfile(token) {
            try {
                if (window.customerData && window.customerData.id) {
                    await setDoc(doc(db, 'customers', window.customerData.id), {
                        fcmToken: token,
                        lastTokenUpdate: new Date(),
                        deviceInfo: {
                            userAgent: navigator.userAgent,
                            platform: navigator.platform,
                            language: navigator.language
                        }
                    }, { merge: true });
                    
                    console.log('‚úÖ ƒê√£ l∆∞u FCM token v√†o Firestore');
                } else {
                    console.log('‚ö†Ô∏è Ch∆∞a c√≥ th√¥ng tin kh√°ch h√†ng ƒë·ªÉ l∆∞u FCM token');
                }
            } catch (error) {
                console.error('‚ùå L·ªói khi l∆∞u FCM token:', error);
            }
        }

        // Th√¥ng b√°o test ƒë·ªÉ x√°c minh ho·∫°t ƒë·ªông
        function showTestNotification() {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('üéâ N-Home ƒë√£ s·∫µn s√†ng!', {
                    body: 'B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o khi c√≥ h√≥a ƒë∆°n m·ªõi ho·∫∑c s·ª± c·ªë ƒë∆∞·ª£c x·ª≠ l√Ω.',
                    icon: '/icon-nen-xanh.jpg',
                    tag: 'test-notification'
                });
                console.log('‚úÖ ƒê√£ g·ª≠i th√¥ng b√°o test');
            }
        }

        // X·ª≠ l√Ω th√¥ng b√°o khi app ƒëang m·ªü (foreground messages)
        messaging.onMessage((payload) => {
            console.log('üîî Nh·∫≠n th√¥ng b√°o khi app ƒëang m·ªü:', payload);
            
            const title = payload.notification?.title || payload.data?.title || 'Th√¥ng b√°o m·ªõi';
            const body = payload.notification?.body || payload.data?.body || 'B·∫°n c√≥ th√¥ng b√°o m·ªõi';
            
            // T·∫°o th√¥ng b√°o t√πy ch·ªânh trong app
            showInAppNotification(title, body);
            
            // L√†m m·ªõi d·ªØ li·ªáu khi nh·∫≠n th√¥ng b√°o
            if (typeof loadData === 'function') {
                loadData();
            }
        });

        // Hi·ªÉn th·ªã th√¥ng b√°o trong app (custom notification banner)
        function showInAppNotification(title, body) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-white border-l-4 border-green-500 rounded-lg shadow-lg p-4 max-w-sm z-50 notification-popup';
            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 2L3 7v11h4v-6h6v6h4V7l-7-5z"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-900 text-sm">${title}</h4>
                        <p class="text-gray-600 text-sm mt-1">${body}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // T·ª± ƒë·ªông x√≥a sau 5 gi√¢y
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }



        // T·∫ÆT t·ª± ƒë·ªông xin quy·ªÅn th√¥ng b√°o khi login - g√¢y spam popup
        const originalLoadCustomerData = window.loadCustomerData;
        if (originalLoadCustomerData) {
            window.loadCustomerData = async function(phone, password) {
                const result = await originalLoadCustomerData(phone, password);
                
                if (result && window.customerData) {
                    // KH√îNG t·ª± ƒë·ªông xin quy·ªÅn th√¥ng b√°o - tr√°nh popup
                    console.log('üîï Login successful - skipping auto notification permission request');
                }
                
                return result;
            };
        }
    </script>
</body>
</html>